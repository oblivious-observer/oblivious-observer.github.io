<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Encrypting Proxmox VE 6: ZFS, LUKS, systemd-boot and Dropbear | oblivious observer</title><meta name=keywords content="proxmox,zfs,luks,systemd-boot,dropbear"><meta name=description content="This describes how to set up a fully encrypted Proxmox VE 6 host with ZFS root and unlocking it remotely using the dropbear ssh server. Also it describes how you can do that, while keeping systemd-boot and thus also the pve tooling intact. (I&rsquo;m not sure if the pve tooling still works if you replace systemd-boot with grub, which seems to be the common solution to creating this kind of setup, maybe it does."><meta name=author content="oblivious observer"><link rel=canonical href=https://oblivious.observer/posts/proxmoxve6-zfs-luks-systemdboot-dropbear/><link crossorigin=anonymous href=/assets/css/stylesheet.dc96e9e0118e5e264a03d68b104df6ae869cfb73c61f5f89dd91aeb16b0d8c03.css integrity="sha256-3Jbp4BGOXiZKA9aLEE32roac+3PGH1+J3ZGusWsNjAM=" rel="preload stylesheet" as=style><link rel=icon href=https://oblivious.observer/observer-16x16.png><link rel=icon type=image/png sizes=16x16 href=https://oblivious.observer/observer-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://oblivious.observer/observer-32x32.png><link rel=apple-touch-icon href=https://oblivious.observer/observer-512x512.png><link rel=mask-icon href=https://oblivious.observer/observer-512x512.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://oblivious.observer/css/syntax.css><meta property="og:title" content="Encrypting Proxmox VE 6: ZFS, LUKS, systemd-boot and Dropbear"><meta property="og:description" content="This describes how to set up a fully encrypted Proxmox VE 6 host with ZFS root and unlocking it remotely using the dropbear ssh server. Also it describes how you can do that, while keeping systemd-boot and thus also the pve tooling intact. (I&rsquo;m not sure if the pve tooling still works if you replace systemd-boot with grub, which seems to be the common solution to creating this kind of setup, maybe it does."><meta property="og:type" content="article"><meta property="og:url" content="https://oblivious.observer/posts/proxmoxve6-zfs-luks-systemdboot-dropbear/"><meta property="og:image" content="https://oblivious.observer/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-08-23T00:00:00+02:00"><meta property="article:modified_time" content="2019-08-23T00:00:00+02:00"><meta property="og:site_name" content="oblivious.observer"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://oblivious.observer/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Encrypting Proxmox VE 6: ZFS, LUKS, systemd-boot and Dropbear"><meta name=twitter:description content="This describes how to set up a fully encrypted Proxmox VE 6 host with ZFS root and unlocking it remotely using the dropbear ssh server. Also it describes how you can do that, while keeping systemd-boot and thus also the pve tooling intact. (I&rsquo;m not sure if the pve tooling still works if you replace systemd-boot with grub, which seems to be the common solution to creating this kind of setup, maybe it does."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://oblivious.observer/posts/"},{"@type":"ListItem","position":3,"name":"Encrypting Proxmox VE 6: ZFS, LUKS, systemd-boot and Dropbear","item":"https://oblivious.observer/posts/proxmoxve6-zfs-luks-systemdboot-dropbear/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Encrypting Proxmox VE 6: ZFS, LUKS, systemd-boot and Dropbear","name":"Encrypting Proxmox VE 6: ZFS, LUKS, systemd-boot and Dropbear","description":"This describes how to set up a fully encrypted Proxmox VE 6 host with ZFS root and unlocking it remotely using the dropbear ssh server. Also it describes how you can do that, while keeping systemd-boot and thus also the pve tooling intact. (I\u0026rsquo;m not sure if the pve tooling still works if you replace systemd-boot with grub, which seems to be the common solution to creating this kind of setup, maybe it does.","keywords":["proxmox","zfs","luks","systemd-boot","dropbear"],"articleBody":"This describes how to set up a fully encrypted Proxmox VE 6 host with ZFS root and unlocking it remotely using the dropbear ssh server. Also it describes how you can do that, while keeping systemd-boot and thus also the pve tooling intact. (I’m not sure if the pve tooling still works if you replace systemd-boot with grub, which seems to be the common solution to creating this kind of setup, maybe it does.)\nUpdate: This post has been translated into czech language and was published on abclinuxu.cz.\nOverview We are going to do the following:\nInstall Proxmox VE 6 on our machine\nMinimally configure the Installation\nEncrypt the Installation:\nRemove a Disk from the ZFS-Pool Encrypt the Disk with LUKS Add it back to the ZFS Pool Repeat until all disks are encrypted Set up Dropbear and Systemd-boot to enable remote unlocking\nPrerequisites There really only is one prerequisite apart from having a machine you want to install Proxmox onto: You need a second harddrive, which we will setup in a ZFS RAID1 configuration. If you don’t want to have your root devices mirrored, you will still need a second drive that you can use as a temporary mirrored root device, otherwise you’d have to install and set up an encrypted debian and then install proxmox on top of that.\nApart from that I’ll assume that you are probably fairly familiar with how full disk encryption works on linux systems, if not you might want to read up on that before you start messing around with any hardware. Please don’t try this out on a production system, if you don’t exactly know what you’re doing.\nInstalling Proxmox VE 6 The only thing you have to make sure is to set up the ZFS RAID 1 during the installation. The rest should be pretty much straight-forward.\nMinimal post-installation For some odd reason PATH in a regular shell is different from PATH in the javascript terminal from the webinterface. You might want to take care of that:\necho \"export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\" \u003e\u003e ~/.bashrc Remove the subscription popup notice (source):\nsed -i.bak \"s/data.status !== 'Active'/false/g\" /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js \u0026\u0026 systemctl restart pveproxy.service Set up the community repositories:\nrm /etc/apt/sources.list.d/pve-enterprise.list echo 'deb http://download.proxmox.com/debian/pve buster pve-no-subscription' \u003e pve-community.list Update the host:\napt update apt upgrade Encrypt your installation This is partly taken over from this wonderful post. (The GRUB_ENABLE_CRYPTODISK option that is mentioned in the forum post does not apply here, since the boot partition is not encrypted. If you want this level of security, then this is probably not the right guide for you. Also from my understanding encrypting the boot partition means that you can’t use dropbear to unlock the system remotely since nothing has booted so far. It is a pretty nice way to set up fully encrypted laptops though, so you should definitely look into this if you haven’t already!)\nRight after the installation the host should look similiar to this (lsblk):\nNAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT sda 8:0 0 465.8G 0 disk ├─sda1 8:1 0 1007K 0 part ├─sda2 8:2 0 512M 0 part └─sda3 8:3 0 465.3G 0 part sdb 8:16 0 931.5G 0 disk sdc 8:32 0 931.5G 0 disk sdd 8:48 0 465.8G 0 disk ├─sdd1 8:49 0 1007K 0 part ├─sdd2 8:50 0 512M 0 part └─sdd3 8:51 0 465.3G 0 part The third partition of both harddrives contains our installation, the first and second are the boot and efi partitions.\nzpool status should return something like this:\nNAME STATE READ WRITE CKSUM rpool ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ata-Samsung_SSD_850_EVO_500GB_XXXXXXXXXXXXXXX-part3 ONLINE 0 0 0 ata-WDC_WDS500G2B0A-XXXXXX_XXXXXXXXXXXX-part3 ONLINE 0 0 0 You might want to install cryptsetup at this point:\napt install cryptsetup Remove the first partition from rpool, then encrypt it, mount it to /dev/mapper/cryptrpool1 and reattach it to rpool:\nzpool detach rpool ata-Samsung_SSD_850_EVO_500GB_XXXXXXXXXXXXXXX-part3 cryptsetup luksFormat /dev/disk/by-id/ata-Samsung_SSD_850_EVO_500GB_XXXXXXXXXXXXXXX-part3 cryptsetup luksOpen /dev/disk/by-id/ata-Samsung_SSD_850_EVO_500GB_XXXXXXXXXXXXXXX-part3 cryptrpool1 zpool attach rpool ata-WDC_WDS500G2B0A-XXXXXX_XXXXXXXXXXXX-part3 cryptrpool1 Wait until the scan line of zpool status displays that the drive has been resilvered successfully. You should see something similiar to this:\nscan: resilvered 1022M in 0 days 00:00:04 with 0 errors on Wed Aug 21 17:27:55 2019 Now repeat this step with the other drive:\nzpool detach rpool ata-WDC_WDS500G2B0A-XXXXXX_XXXXXXXXXXXX-part3 cryptsetup luksFormat /dev/disk/by-id/ata-WDC_WDS500G2B0A-XXXXXX_XXXXXXXXXXXX-part3 cryptsetup luksOpen /dev/disk/by-id/ata-WDC_WDS500G2B0A-XXXXXX_XXXXXXXXXXXX-part3 cryptrpool2 zpool attach rpool cryptrpool1 cryptrpool2 At this point lsblk should output something like this:\nNAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT sda 8:0 0 465.8G 0 disk ├─sda1 8:1 0 1007K 0 part ├─sda2 8:2 0 512M 0 part └─sda3 8:3 0 465.3G 0 part └─cryptrpool1 253:0 0 465.3G 0 crypt sdb 8:16 0 931.5G 0 disk sdc 8:32 0 931.5G 0 disk sdd 8:48 0 465.8G 0 disk ├─sdd1 8:49 0 1007K 0 part ├─sdd2 8:50 0 512M 0 part └─sdd3 8:51 0 465.3G 0 part └─cryptrpool2 253:1 0 465.3G 0 crypt And zpool status should return something like this:\nNAME STATE READ WRITE CKSUM rpool ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 cryptrpool1 ONLINE 0 0 0 cryptrpool2 ONLINE 0 0 0 Next we want to set up /etc/crypttab, use blkid to get the PARTUUID from both harddrives:\nblkid -s PARTUUID -o value /dev/disk/by-id/ata-Samsung_SSD_850_EVO_500GB_XXXXXXXXXXXXXXX-part3 blkid -s PARTUUID -o value /dev/disk/by-id/ata-WDC_WDS500G2B0A-XXXXXX_XXXXXXXXXXXX-part3 Then add them to /etc/crypttab:\nroot@caliban:~# cat /etc/crypttab # cryptrpool1 PARTUUID=XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX none luks,discard,initramfs cryptrpool2 PARTUUID=YYYYYYYY-YYYY-YYYY-YYYY-YYYYYYYYYYYY none luks,discard,initramfs Then update the initramfs and make sure it is put on the boot partition (this is where we deviate from the forum post I’ve linked above):\nupdate-initramfs -u -k all pve-efiboot-tool refresh In case you’re wondering at this point, yes I’m also getting the cryptsetup error message on running update-initramfs, it still works though:\ncryptsetup: ERROR: Couldn't resolve device rpool/ROOT/pve-1 cryptsetup: WARNING: Couldn't determine root device Now you should be able to reboot and unlock the ZFS partitions by entering the passphrase.\nSetting up Dropbear to remotely unlock the partition Now to the fun part! Since we aren’t using grub here, we have to take a few different steps from what we usually do in this kind of setup.\nHere are a few interesting links you might want to look into as well:\nThis nicely explains how to use the keys Dropbear already generates on install instead of recreating them. The freedesktop page on systemd-boot This little article on setting up archlinux with dropbear does not fully apply to our Proxmox case, but it gives enough information on how we can tell systemd-boot to tell the kernel to start with the options we want (unlike the article states, we need to use the udev name for assigning the IP and I was getting error messages, when supplying nameserver IPs). First install dropbear and busybox:\napt install dropbear busybox In /etc/initramfs-tools/initramfs.conf enable busybox:\nroot@caliban:~# cat /etc/initramfs-tools/initramfs.conf | grep ^BUSYBOX BUSYBOX=y Then convert the dropbear keys:\ncd /etc/dropbear-initramfs/ /usr/lib/dropbear/dropbearconvert dropbear openssh dropbear_rsa_host_key id_rsa dropbearkey -y -f dropbear_rsa_host_key | grep \"^ssh-rsa \" \u003e id_rsa.pub And add your public key to the authorized keys:\nvi /etc/dropbear-initramfs/authorized_keys Make sure dropbear starts by toggling the NO_START value in /etc/default/dropbear.\nroot@caliban:~# cat /etc/default/dropbear | grep ^NO_START NO_START=0 Finally configure dropbear to use a different Port than 22 in order to avoid getting the MITM warning, by changing the DROPBEAR_OPTIONS value in /etc/dropbear-initramfs/config:\nroot@caliban:~# cat /etc/dropbear-initramfs/config | grep ^DROPBEAR_OPTIONS DROPBEAR_OPTIONS=\"-p 12345\" You can then set up two entries in your ~/.ssh/config:\n$ cat ~/.ssh/config Host * ServerAliveInterval 120 Host unlock_caliban Hostname 1.2.3.4 User root Port 12345 Host caliban Hostname 1.2.3.4 Port 22 At this point I noticed, that only the third partition of both of the harddrives with the rpool were mounted. When mounting a boot partition, I found that there were systemd-boot configuration files, but they seemed to be autogenerated by Proxmox, whenever pve-efiboot-tool refresh was run. So I looked into /usr/sbin/pve-efiboot-tool, and followed the code until I came out in /etc/kernel/postinst.d/zz-pve-efiboot, which contains the code that generates the systemd-boot configuration files:\n# [...] for kver in ${BOOT_KVERS}; do linux_image=\"/boot/vmlinuz-${kver}\" initrd=\"/boot/initrd.img-${kver}\" if [ ! -f \"${linux_image}\" ]; then warn \"No linux-image ${linux_image} found - skipping\" continue fi if [ ! -f \"${initrd}\" ]; then warn \"No initrd-image ${initrd} found - skipping\" continue fi warn \" Copying kernel and creating boot-entry for ${kver}\" KERNEL_ESP_DIR=\"${PMX_ESP_DIR}/${kver}\" KERNEL_LIVE_DIR=\"${esp}/${KERNEL_ESP_DIR}\" mkdir -p \"${KERNEL_LIVE_DIR}\" cp -u --preserve=timestamps \"${linux_image}\" \"${KERNEL_LIVE_DIR}/\" cp -u --preserve=timestamps \"${initrd}\" \"${KERNEL_LIVE_DIR}/\" # create loader entry cat \u003e \"${esp}/loader/entries/proxmox-${kver}.conf\" \u003c\u003c- EOF title ${LOADER_TITLE} version ${kver} options ${CMDLINE} linux /${KERNEL_ESP_DIR}/vmlinuz-${kver} initrd /${KERNEL_ESP_DIR}/initrd.img-${kver} EOF done # [...] For us, the cat part is especially interesting: the CMDLINE variable in the line beginning with “=options=” contains the boot options for the Linux kernel. This variable is assigned in the same file:\n# [...] if [ -f /etc/kernel/cmdline ]; then CMDLINE=\"$(cat /etc/kernel/cmdline)\" else warn \"No /etc/kernel/cmdline found - falling back to /proc/cmdline\" CMDLINE=\"$(cat /proc/cmdline)\" fi # [...] Apparently /etc/kernel/cmdline is the place where Proxmox stores it’s boot options. The file contains one single line:\nroot=ZFS=rpool/ROOT/pve-1 boot=zfs After finding the /etc/kernel/cmdline file, I did a bit of searching and according to the Proxmox documentation, it is actually the apropriate file to change in this case.\nNow that we have identified the file we can use to configure our kernel options, there are two things we want to add:\nwe want to make sure the network interface comes up so that we can ssh into the initramfs, we will use the ip option for that. It uses the following format (look here for further reading):\nip=::::::: ::: I omitted everything after autoconf, something like this works for me:\nip=1.2.3.4::1.2.3.1:255.255.255.0:caliban:enpXsY:none: also we have to tell the kernel which devices the cryptodevices are that we want to unlock, which is done using the cryptodevice option (here we have to supply the PARTUUIDs for both of our harddrives):\ncryptdevice=UUID=XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX cryptdevice=UUID=YYYYYYYY-YYYY-YYYY-YYYY-YYYYYYYYYYYY The whole content of /etc/kernel/cmdline looks like this:\nip=1.2.3.4::1.2.3.1:255.255.255.0:caliban:enpXsY:none: cryptdevice=UUID=XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX cryptdevice=UUID=YYYYYYYY-YYYY-YYYY-YYYY-YYYYYYYYYYYY root=ZFS=rpool/ROOT/pve-1 boot=zfs The last thing to do is to:\nupdate-initramfs -u -k all pve-efiboot-tool refresh Now you should be able to reboot your machine and ssh into the busybox on the port you just configured for dropbear. From there you can unlock the drives by running something like this (You’ll have to input it twice since you have two encrypted drives):\necho -n \"password\" \u003e /lib/cryptsetup/passfifo Or:\n/lib/cryptsetup/askpass \"password: \" \u003e /lib/cryptsetup/passfifo Or you can also use the cryptroot-unlock script that is preinstalled already, which also prompts you to enter the password twice.\nIf you’re lazy, you can also use put the following script into /etc/initramfs-tools/hooks and make it executable. I basically merged the above example of using /lib/cryptsetup/askpass with a version of a unlock script I had lying around, it looks like it might have been from this gist. It asks you for a passphrase and then uses echo to write it into /lib/cryptsetup/passfifo twice (since I use 2 harddrives) with one second delay in between, then kills the session so the system can come up (I noticed, that /etc/motd, which contains instructions on how to unlock your drive is not displayed in the busybox session. . You probably shouldn’t use it, but it seems to work for me):\n#!/bin/sh PREREQ=\"dropbear\" prereqs() { echo \"$PREREQ\" } case \"$1\" in prereqs) prereqs exit 0 ;; esac . \"${CONFDIR}/initramfs.conf\" . /usr/share/initramfs-tools/hook-functions if [ \"${DROPBEAR}\" != \"n\" ] \u0026\u0026 [ -r \"/etc/crypttab\" ] ; then cat \u003e \"${DESTDIR}/bin/unlock\" \u003c\u003c EOF #!/bin/sh unlock_devices() { pw=\"\\$(/lib/cryptsetup/askpass \"password: \")\" echo -n \\$pw \u003e /lib/cryptsetup/passfifo sleep 1 echo -n \\$pw \u003e /lib/cryptsetup/passfifo } if unlock_devices; then # kill \\`ps | grep cryptroot | grep -v \"grep\" | awk '{print \\$1}'\\` # following line kill the remote shell right after the passphrase has # been entered. kill -9 \\`ps | grep \"\\-sh\" | grep -v \"grep\" | awk '{print \\$1}'\\` exit 0 fi exit 1 EOF chmod 755 \"${DESTDIR}/bin/unlock\" mkdir -p \"${DESTDIR}/lib/unlock\" cat \u003e \"${DESTDIR}/lib/unlock/plymouth\" \u003c\u003c EOF #!/bin/sh [ \"\\$1\" == \"--ping\" ] \u0026\u0026 exit 1 /bin/plymouth \"\\$@\" EOF chmod 755 \"${DESTDIR}/lib/unlock/plymouth\" echo To unlock root-partition run \"unlock\" \u003e\u003e ${DESTDIR}/etc/motd fi That’s pretty much all of it, you can now start enjoying remote reboots on your freshly encrypted Proxmox host.\n","wordCount":"2002","inLanguage":"en","datePublished":"2019-08-23T00:00:00+02:00","dateModified":"2019-08-23T00:00:00+02:00","author":[{"@type":"Person","name":"oblivious observer"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://oblivious.observer/posts/proxmoxve6-zfs-luks-systemdboot-dropbear/"},"publisher":{"@type":"Organization","name":"oblivious observer","logo":{"@type":"ImageObject","url":"https://oblivious.observer/observer-16x16.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://oblivious.observer accesskey=h title="  (Alt + H)"><img src=https://oblivious.observer/observer-64x64.png alt aria-label=logo height=35></a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://oblivious.observer/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://oblivious.observer/posts/ title=posts><span>posts</span></a></li><li><a href=https://oblivious.observer/archives/ title=archive><span>archive</span></a></li><li><a href=https://oblivious.observer/tags/ title=tags><span>tags</span></a></li><li><a href=https://oblivious.observer/index.html title=about><span>about</span></a></li><li><a href=https://oblivious.observer/index.xml title=rss><span>rss</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Encrypting Proxmox VE 6: ZFS, LUKS, systemd-boot and Dropbear</h1><div class=post-meta><span title='2019-08-23 00:00:00 +0200 CEST'>August 23, 2019</span>&nbsp;·&nbsp;10 min&nbsp;·&nbsp;oblivious observer</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#overview aria-label=Overview>Overview</a></li><li><a href=#prerequisites aria-label=Prerequisites>Prerequisites</a></li><li><a href=#installing-proxmox-ve-6 aria-label="Installing Proxmox VE 6">Installing Proxmox VE 6</a></li><li><a href=#minimal-post-installation aria-label="Minimal post-installation">Minimal post-installation</a></li><li><a href=#encrypt-your-installation aria-label="Encrypt your installation">Encrypt your installation</a></li><li><a href=#setting-up-dropbear-to-remotely-unlock-the-partition aria-label="Setting up Dropbear to remotely unlock the partition">Setting up Dropbear to remotely unlock the partition</a></li></ul></div></details></div><div class=post-content><p>This describes how to set up a fully encrypted Proxmox VE 6 host with ZFS root
and unlocking it remotely using the dropbear ssh server. Also it describes how
you can do that, while keeping systemd-boot and thus also the pve tooling
intact. (I&rsquo;m not sure if the pve tooling still works if you replace systemd-boot
with grub, which seems to be the common solution to creating this kind of setup,
maybe it does.)</p><p><strong>Update</strong>: This post has been translated into czech language and was published on
<a href=https://www.abclinuxu.cz/clanky/sifrovany-proxmox-ve-6-zfs-luks-systemd-boot-a-dropbear>abclinuxu.cz</a>.</p><h2 id=overview>Overview<a hidden class=anchor aria-hidden=true href=#overview>#</a></h2><p>We are going to do the following:</p><ol><li><p>Install Proxmox VE 6 on our machine</p></li><li><p>Minimally configure the Installation</p></li><li><p>Encrypt the Installation:</p><ol><li>Remove a Disk from the ZFS-Pool</li><li>Encrypt the Disk with LUKS</li><li>Add it back to the ZFS Pool</li><li>Repeat until all disks are encrypted</li></ol></li><li><p>Set up Dropbear and Systemd-boot to enable remote unlocking</p></li></ol><h2 id=prerequisites>Prerequisites<a hidden class=anchor aria-hidden=true href=#prerequisites>#</a></h2><p>There really only is one prerequisite apart from having a machine you
want to install Proxmox onto: You need a second harddrive, which we will
setup in a ZFS RAID1 configuration. If you don&rsquo;t want to have your root
devices mirrored, you will still need a second drive that you can use as
a temporary mirrored root device, otherwise you&rsquo;d have to install and
set up an encrypted debian and then install proxmox on top of that.</p><p>Apart from that I&rsquo;ll assume that you are probably fairly familiar with
how full disk encryption works on linux systems, if not you might want
to read up on that before you start messing around with any hardware.
Please don&rsquo;t try this out on a production system, if you don&rsquo;t exactly
know what you&rsquo;re doing.</p><h2 id=installing-proxmox-ve-6>Installing Proxmox VE 6<a hidden class=anchor aria-hidden=true href=#installing-proxmox-ve-6>#</a></h2><p>The only thing you have to make sure is to set up the ZFS RAID 1 during
the installation. The rest should be pretty much straight-forward.</p><h2 id=minimal-post-installation>Minimal post-installation<a hidden class=anchor aria-hidden=true href=#minimal-post-installation>#</a></h2><p>For some odd reason <code>PATH</code> in a regular shell is different from <code>PATH</code>
in the javascript terminal from the webinterface. You might want to take
care of that:</p><pre tabindex=0><code class=language-nil data-lang=nil>  echo &#34;export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&#34; &gt;&gt; ~/.bashrc
</code></pre><p>Remove the subscription popup notice
(<a href=https://johnscs.com/remove-proxmox51-subscription-notice/>source</a>):</p><pre tabindex=0><code class=language-nil data-lang=nil>  sed -i.bak &#34;s/data.status !== &#39;Active&#39;/false/g&#34; /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js &amp;&amp; systemctl restart pveproxy.service
</code></pre><p>Set up the community repositories:</p><pre tabindex=0><code class=language-nil data-lang=nil>  rm /etc/apt/sources.list.d/pve-enterprise.list
  echo &#39;deb http://download.proxmox.com/debian/pve buster pve-no-subscription&#39; &gt; pve-community.list
</code></pre><p>Update the host:</p><pre tabindex=0><code class=language-nil data-lang=nil>  apt update
  apt upgrade
</code></pre><h2 id=encrypt-your-installation>Encrypt your installation<a hidden class=anchor aria-hidden=true href=#encrypt-your-installation>#</a></h2><p>This is partly taken over from <a href=https://forums.servethehome.com/index.php?threads/proxmox-zfs-encryption-guide-work-in-progress.23004/#post-215138>this wonderful post</a>. (The
<code>GRUB_ENABLE_CRYPTODISK</code> option that is mentioned in the <a href=https://forums.servethehome.com/index.php?threads/proxmox-zfs-encryption-guide-work-in-progress.23004/#post-215138>forum post</a> does not
apply here, since the boot partition is not encrypted. If you want this level of
security, then this is probably not the right guide for you. Also from my
understanding encrypting the boot partition means that you can&rsquo;t use dropbear to
unlock the system remotely since nothing has booted so far. It is a pretty nice
way to set up fully encrypted laptops though, so you should definitely look into
this if you haven&rsquo;t already!)</p><p>Right after the installation the host should look similiar to this
(<code>lsblk</code>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  NAME            MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT
</span></span><span style=display:flex><span>  sda               8:0    <span style=color:#bd93f9>0</span> 465.8G  <span style=color:#bd93f9>0</span> disk
</span></span><span style=display:flex><span>  ├─sda1            8:1    <span style=color:#bd93f9>0</span>  1007K  <span style=color:#bd93f9>0</span> part
</span></span><span style=display:flex><span>  ├─sda2            8:2    <span style=color:#bd93f9>0</span>   512M  <span style=color:#bd93f9>0</span> part
</span></span><span style=display:flex><span>  └─sda3            8:3    <span style=color:#bd93f9>0</span> 465.3G  <span style=color:#bd93f9>0</span> part
</span></span><span style=display:flex><span>  sdb               8:16   <span style=color:#bd93f9>0</span> 931.5G  <span style=color:#bd93f9>0</span> disk
</span></span><span style=display:flex><span>  sdc               8:32   <span style=color:#bd93f9>0</span> 931.5G  <span style=color:#bd93f9>0</span> disk
</span></span><span style=display:flex><span>  sdd               8:48   <span style=color:#bd93f9>0</span> 465.8G  <span style=color:#bd93f9>0</span> disk
</span></span><span style=display:flex><span>  ├─sdd1            8:49   <span style=color:#bd93f9>0</span>  1007K  <span style=color:#bd93f9>0</span> part
</span></span><span style=display:flex><span>  ├─sdd2            8:50   <span style=color:#bd93f9>0</span>   512M  <span style=color:#bd93f9>0</span> part
</span></span><span style=display:flex><span>  └─sdd3            8:51   <span style=color:#bd93f9>0</span> 465.3G  <span style=color:#bd93f9>0</span> part
</span></span></code></pre></div><p>The third partition of both harddrives contains our installation, the
first and second are the boot and efi partitions.</p><p><code>zpool status</code> should return something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  NAME             STATE     READ WRITE CKSUM
</span></span><span style=display:flex><span>  rpool            ONLINE       <span style=color:#bd93f9>0</span>     <span style=color:#bd93f9>0</span>     <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span>    mirror-0       ONLINE       <span style=color:#bd93f9>0</span>     <span style=color:#bd93f9>0</span>     <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span>      ata-Samsung_SSD_850_EVO_500GB_XXXXXXXXXXXXXXX-part3  ONLINE       <span style=color:#bd93f9>0</span>     <span style=color:#bd93f9>0</span>     <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span>      ata-WDC_WDS500G2B0A-XXXXXX_XXXXXXXXXXXX-part3        ONLINE       <span style=color:#bd93f9>0</span>     <span style=color:#bd93f9>0</span>     <span style=color:#bd93f9>0</span>
</span></span></code></pre></div><p>You might want to install <code>cryptsetup</code> at this point:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  apt install cryptsetup
</span></span></code></pre></div><p>Remove the first partition from <code>rpool</code>, then encrypt it, mount it to
<code>/dev/mapper/cryptrpool1</code> and reattach it to <code>rpool</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  zpool detach rpool ata-Samsung_SSD_850_EVO_500GB_XXXXXXXXXXXXXXX-part3
</span></span><span style=display:flex><span>  cryptsetup luksFormat /dev/disk/by-id/ata-Samsung_SSD_850_EVO_500GB_XXXXXXXXXXXXXXX-part3
</span></span><span style=display:flex><span>  cryptsetup luksOpen /dev/disk/by-id/ata-Samsung_SSD_850_EVO_500GB_XXXXXXXXXXXXXXX-part3 cryptrpool1
</span></span><span style=display:flex><span>  zpool attach rpool ata-WDC_WDS500G2B0A-XXXXXX_XXXXXXXXXXXX-part3 cryptrpool1
</span></span></code></pre></div><p>Wait until the <code>scan</code> line of <code>zpool status</code> displays that the drive has
been resilvered successfully. You should see something similiar to this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  scan: resilvered 1022M in <span style=color:#bd93f9>0</span> days 00:00:04 with <span style=color:#bd93f9>0</span> errors on Wed Aug <span style=color:#bd93f9>21</span> 17:27:55 <span style=color:#bd93f9>2019</span>
</span></span></code></pre></div><p>Now repeat this step with the other drive:</p><pre tabindex=0><code class=language-nil data-lang=nil>  zpool detach rpool ata-WDC_WDS500G2B0A-XXXXXX_XXXXXXXXXXXX-part3
  cryptsetup luksFormat /dev/disk/by-id/ata-WDC_WDS500G2B0A-XXXXXX_XXXXXXXXXXXX-part3
  cryptsetup luksOpen /dev/disk/by-id/ata-WDC_WDS500G2B0A-XXXXXX_XXXXXXXXXXXX-part3 cryptrpool2
  zpool attach rpool cryptrpool1 cryptrpool2
</code></pre><p>At this point <code>lsblk</code> should output something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  NAME            MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT
</span></span><span style=display:flex><span>  sda               8:0    <span style=color:#bd93f9>0</span> 465.8G  <span style=color:#bd93f9>0</span> disk
</span></span><span style=display:flex><span>  ├─sda1            8:1    <span style=color:#bd93f9>0</span>  1007K  <span style=color:#bd93f9>0</span> part
</span></span><span style=display:flex><span>  ├─sda2            8:2    <span style=color:#bd93f9>0</span>   512M  <span style=color:#bd93f9>0</span> part
</span></span><span style=display:flex><span>  └─sda3            8:3    <span style=color:#bd93f9>0</span> 465.3G  <span style=color:#bd93f9>0</span> part
</span></span><span style=display:flex><span>    └─cryptrpool1 253:0    <span style=color:#bd93f9>0</span> 465.3G  <span style=color:#bd93f9>0</span> crypt
</span></span><span style=display:flex><span>  sdb               8:16   <span style=color:#bd93f9>0</span> 931.5G  <span style=color:#bd93f9>0</span> disk
</span></span><span style=display:flex><span>  sdc               8:32   <span style=color:#bd93f9>0</span> 931.5G  <span style=color:#bd93f9>0</span> disk
</span></span><span style=display:flex><span>  sdd               8:48   <span style=color:#bd93f9>0</span> 465.8G  <span style=color:#bd93f9>0</span> disk
</span></span><span style=display:flex><span>  ├─sdd1            8:49   <span style=color:#bd93f9>0</span>  1007K  <span style=color:#bd93f9>0</span> part
</span></span><span style=display:flex><span>  ├─sdd2            8:50   <span style=color:#bd93f9>0</span>   512M  <span style=color:#bd93f9>0</span> part
</span></span><span style=display:flex><span>  └─sdd3            8:51   <span style=color:#bd93f9>0</span> 465.3G  <span style=color:#bd93f9>0</span> part
</span></span><span style=display:flex><span>    └─cryptrpool2 253:1    <span style=color:#bd93f9>0</span> 465.3G  <span style=color:#bd93f9>0</span> crypt
</span></span></code></pre></div><p>And <code>zpool status</code> should return something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  NAME             STATE     READ WRITE CKSUM
</span></span><span style=display:flex><span>  rpool            ONLINE       <span style=color:#bd93f9>0</span>     <span style=color:#bd93f9>0</span>     <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span>    mirror-0       ONLINE       <span style=color:#bd93f9>0</span>     <span style=color:#bd93f9>0</span>     <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span>      cryptrpool1  ONLINE       <span style=color:#bd93f9>0</span>     <span style=color:#bd93f9>0</span>     <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span>      cryptrpool2  ONLINE       <span style=color:#bd93f9>0</span>     <span style=color:#bd93f9>0</span>     <span style=color:#bd93f9>0</span>
</span></span></code></pre></div><p>Next we want to set up <code>/etc/crypttab</code>, use <code>blkid</code> to get the
<code>PARTUUID</code> from both harddrives:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  blkid -s PARTUUID -o value /dev/disk/by-id/ata-Samsung_SSD_850_EVO_500GB_XXXXXXXXXXXXXXX-part3
</span></span><span style=display:flex><span>  blkid -s PARTUUID -o value /dev/disk/by-id/ata-WDC_WDS500G2B0A-XXXXXX_XXXXXXXXXXXX-part3
</span></span></code></pre></div><p>Then add them to <code>/etc/crypttab</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  root@caliban:~# cat /etc/crypttab
</span></span><span style=display:flex><span>  <span style=color:#6272a4># &lt;target name&gt; &lt;source device&gt;                                &lt;key file&gt;      &lt;options&gt;</span>
</span></span><span style=display:flex><span>    cryptrpool1   <span style=color:#8be9fd;font-style:italic>PARTUUID</span><span style=color:#ff79c6>=</span>XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX  none            luks,discard,initramfs
</span></span><span style=display:flex><span>    cryptrpool2   <span style=color:#8be9fd;font-style:italic>PARTUUID</span><span style=color:#ff79c6>=</span>YYYYYYYY-YYYY-YYYY-YYYY-YYYYYYYYYYYY  none            luks,discard,initramfs
</span></span></code></pre></div><p>Then update the initramfs and make sure it is put on the boot partition
(this is where we deviate from the forum post I&rsquo;ve linked above):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  update-initramfs -u -k all
</span></span><span style=display:flex><span>  pve-efiboot-tool refresh
</span></span></code></pre></div><p>In case you&rsquo;re wondering at this point, yes I&rsquo;m also getting the
<code>cryptsetup</code> error message on running <code>update-initramfs</code>, it still works
though:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  cryptsetup: ERROR: Couldn<span style=color:#f1fa8c>&#39;t resolve device rpool/ROOT/pve-1
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  cryptsetup: WARNING: Couldn&#39;</span>t determine root device
</span></span></code></pre></div><p>Now you should be able to reboot and unlock the ZFS partitions by
entering the passphrase.</p><h2 id=setting-up-dropbear-to-remotely-unlock-the-partition>Setting up Dropbear to remotely unlock the partition<a hidden class=anchor aria-hidden=true href=#setting-up-dropbear-to-remotely-unlock-the-partition>#</a></h2><p>Now to the fun part! Since we aren&rsquo;t using <code>grub</code> here, we have to take
a few different steps from what we usually do in this kind of setup.</p><p>Here are a few interesting links you might want to look into as well:</p><ul><li><a href=https://www.pbworks.net/ubuntu-guide-dropbear-ssh-server-to-unlock-luks-encrypted-pc/>This</a>
nicely explains how to use the keys Dropbear already generates on
install instead of recreating them.</li><li>The freedesktop page on
<a href=https://www.freedesktop.org/wiki/Software/systemd/systemd-boot/>systemd-boot</a></li><li><a href=https://adfinis-sygroup.ch/en/blog/decrypt-luks-devices-remotely-via-dropbear-ssh/>This
little article</a> on setting up <code>archlinux</code> with <code>dropbear</code> does not
fully apply to our Proxmox case, but it gives enough information on
how we can tell <code>systemd-boot</code> to tell the kernel to start with the
options we want (unlike the article states, we need to use the udev
name for assigning the IP and I was getting error messages, when
supplying nameserver IPs).</li></ul><p>First install <code>dropbear</code> and <code>busybox</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  apt install dropbear busybox
</span></span></code></pre></div><p>In <code>/etc/initramfs-tools/initramfs.conf</code> enable busybox:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  root@caliban:~# cat /etc/initramfs-tools/initramfs.conf | grep ^BUSYBOX
</span></span><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>BUSYBOX</span><span style=color:#ff79c6>=</span>y
</span></span></code></pre></div><p>Then convert the dropbear keys:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>cd</span> /etc/dropbear-initramfs/
</span></span><span style=display:flex><span>  /usr/lib/dropbear/dropbearconvert dropbear openssh dropbear_rsa_host_key id_rsa
</span></span><span style=display:flex><span>  dropbearkey -y -f dropbear_rsa_host_key | grep <span style=color:#f1fa8c>&#34;^ssh-rsa &#34;</span> &gt; id_rsa.pub
</span></span></code></pre></div><p>And add your public key to the authorized keys:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  vi /etc/dropbear-initramfs/authorized_keys
</span></span></code></pre></div><p>Make sure <code>dropbear</code> starts by toggling the <code>NO_START</code> value in
<code>/etc/default/dropbear</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  root@caliban:~# cat /etc/default/dropbear | grep ^NO_START
</span></span><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>NO_START</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span>
</span></span></code></pre></div><p>Finally configure <code>dropbear</code> to use a different Port than 22 in order to
avoid getting the MITM warning, by changing the <code>DROPBEAR_OPTIONS</code> value
in /etc/dropbear-initramfs/config:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  root@caliban:~# cat /etc/dropbear-initramfs/config | grep ^DROPBEAR_OPTIONS
</span></span><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>DROPBEAR_OPTIONS</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;-p 12345&#34;</span>
</span></span></code></pre></div><p>You can then set up two entries in your <code>~/.ssh/config</code>:</p><pre tabindex=0><code class=language-conf data-lang=conf>  $ cat ~/.ssh/config
  Host *
  ServerAliveInterval 120

  Host unlock_caliban
    Hostname 1.2.3.4
    User root
    Port 12345

  Host caliban
    Hostname 1.2.3.4
    Port 22
</code></pre><p>At this point I noticed, that only the third partition of both of the
harddrives with the rpool were mounted. When mounting a boot partition,
I found that there were systemd-boot configuration files, but they
seemed to be autogenerated by Proxmox, whenever
<code>pve-efiboot-tool refresh</code> was run. So I looked into
<code>/usr/sbin/pve-efiboot-tool</code>, and followed the code until I came out in
<code>/etc/kernel/postinst.d/zz-pve-efiboot</code>, which contains the code that
generates the systemd-boot configuration files:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  <span style=color:#6272a4># [...]</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>for</span> kver in <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>BOOT_KVERS</span><span style=color:#f1fa8c>}</span>; <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#8be9fd;font-style:italic>linux_image</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;/boot/vmlinuz-</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>kver</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#8be9fd;font-style:italic>initrd</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;/boot/initrd.img-</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>kver</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>[</span> ! -f <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>linux_image</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span> <span style=color:#ff79c6>]</span>; <span style=color:#ff79c6>then</span>
</span></span><span style=display:flex><span>          warn <span style=color:#f1fa8c>&#34;No linux-image </span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>linux_image</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c> found - skipping&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>continue</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>fi</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>[</span> ! -f <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>initrd</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span> <span style=color:#ff79c6>]</span>; <span style=color:#ff79c6>then</span>
</span></span><span style=display:flex><span>          warn <span style=color:#f1fa8c>&#34;No initrd-image </span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>initrd</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c> found - skipping&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>continue</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      warn <span style=color:#f1fa8c>&#34;  Copying kernel and creating boot-entry for </span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>kver</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#8be9fd;font-style:italic>KERNEL_ESP_DIR</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>PMX_ESP_DIR</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>kver</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#8be9fd;font-style:italic>KERNEL_LIVE_DIR</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>esp</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>KERNEL_ESP_DIR</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>      mkdir -p <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>KERNEL_LIVE_DIR</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>      cp -u --preserve<span style=color:#ff79c6>=</span>timestamps <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>linux_image</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>KERNEL_LIVE_DIR</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/&#34;</span>
</span></span><span style=display:flex><span>      cp -u --preserve<span style=color:#ff79c6>=</span>timestamps <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>initrd</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>KERNEL_LIVE_DIR</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#6272a4># create loader entry</span>
</span></span><span style=display:flex><span>      cat &gt; <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>esp</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/loader/entries/proxmox-</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>kver</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>.conf&#34;</span> <span style=color:#f1fa8c>&lt;&lt;- EOF
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>              title    ${LOADER_TITLE}
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>              version  ${kver}
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>              options  ${CMDLINE}
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>              linux    /${KERNEL_ESP_DIR}/vmlinuz-${kver}
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>              initrd   /${KERNEL_ESP_DIR}/initrd.img-${kver}
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      EOF</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>done</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4># [...]</span>
</span></span></code></pre></div><p>For us, the cat part is especially interesting: the <code>CMDLINE</code> variable
in the line beginning with “=options=” contains the boot options for the
Linux kernel. This variable is assigned in the same file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  <span style=color:#6272a4># [...]</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>[</span> -f /etc/kernel/cmdline <span style=color:#ff79c6>]</span>; <span style=color:#ff79c6>then</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>CMDLINE</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span>cat /etc/kernel/cmdline<span style=color:#ff79c6>)</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>else</span>
</span></span><span style=display:flex><span>    warn <span style=color:#f1fa8c>&#34;No /etc/kernel/cmdline found - falling back to /proc/cmdline&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>CMDLINE</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span>cat /proc/cmdline<span style=color:#ff79c6>)</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>fi</span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4># [...]</span>
</span></span></code></pre></div><p>Apparently <code>/etc/kernel/cmdline</code> is the place where Proxmox stores it&rsquo;s
boot options. The file contains one single line:</p><pre tabindex=0><code class=language-conf data-lang=conf>  root=ZFS=rpool/ROOT/pve-1 boot=zfs
</code></pre><p>After finding the <code>/etc/kernel/cmdline</code> file, I did a bit of searching
and according to the Proxmox
<a href=https://pve.proxmox.com/pve-docs/pve-admin-guide.html#sysboot%5Fedit%5Fkernel%5Fcmdline>documentation</a>,
it is actually the apropriate file to change in this case.</p><p>Now that we have identified the file we can use to configure our kernel
options, there are two things we want to add:</p><ol><li><p>we want to make sure the network interface comes up so that we can
ssh into the initramfs, we will use the <code>ip</code> option for that. It uses
the following format (look
<a href=https://www.kernel.org/doc/Documentation/filesystems/nfs/nfsroot.txt>here</a>
for further reading):</p><pre tabindex=0><code class=language-conf data-lang=conf>       ip=&lt;client-ip&gt;:&lt;server-ip&gt;:&lt;gw-ip&gt;:&lt;netmask&gt;:&lt;hostname&gt;:&lt;device&gt;:&lt;autoconf&gt;:
     &lt;dns0-ip&gt;:&lt;dns1-ip&gt;:&lt;ntp0-ip&gt;:
</code></pre><p>I omitted everything after autoconf, something like this works for
me:</p><pre tabindex=0><code class=language-conf data-lang=conf>     ip=1.2.3.4::1.2.3.1:255.255.255.0:caliban:enpXsY:none:
</code></pre></li><li><p>also we have to tell the kernel which devices the cryptodevices are
that we want to unlock, which is done using the <code>cryptodevice</code> option
(here we have to supply the PARTUUIDs for both of our harddrives):</p><pre tabindex=0><code class=language-conf data-lang=conf>     cryptdevice=UUID=XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX cryptdevice=UUID=YYYYYYYY-YYYY-YYYY-YYYY-YYYYYYYYYYYY
</code></pre></li></ol><p>The whole content of <code>/etc/kernel/cmdline</code> looks like this:</p><pre tabindex=0><code class=language-conf data-lang=conf>  ip=1.2.3.4::1.2.3.1:255.255.255.0:caliban:enpXsY:none: cryptdevice=UUID=XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX cryptdevice=UUID=YYYYYYYY-YYYY-YYYY-YYYY-YYYYYYYYYYYY root=ZFS=rpool/ROOT/pve-1 boot=zfs
</code></pre><p>The last thing to do is to:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  update-initramfs -u -k all
</span></span><span style=display:flex><span>  pve-efiboot-tool refresh
</span></span></code></pre></div><p>Now you should be able to reboot your machine and ssh into the busybox on the
port you just configured for <code>dropbear</code>. From there you can unlock the drives by
running something like this (You&rsquo;ll have to input it twice since you have two
encrypted drives):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>echo</span> -n <span style=color:#f1fa8c>&#34;password&#34;</span> &gt; /lib/cryptsetup/passfifo
</span></span></code></pre></div><p>Or:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  /lib/cryptsetup/askpass <span style=color:#f1fa8c>&#34;password: &#34;</span> &gt; /lib/cryptsetup/passfifo
</span></span></code></pre></div><p>Or you can also use the <code>cryptroot-unlock</code> script that is preinstalled
already, which also prompts you to enter the password twice.</p><p>If you&rsquo;re lazy, you can also use put the following script into
<code>/etc/initramfs-tools/hooks</code> and make it executable. I basically merged
the above example of using <code>/lib/cryptsetup/askpass</code> with a version of a
unlock script I had lying around, it looks like it might have been from
this <a href=https://gist.github.com/gusennan/712d6e81f5cf9489bd9f>gist</a>. It
asks you for a passphrase and then uses echo to write it into
<code>/lib/cryptsetup/passfifo</code> twice (since I use 2 harddrives) with one
second delay in between, then kills the session so the system can come
up (I noticed, that /etc/motd, which contains instructions on how to
unlock your drive is not displayed in the busybox session. . You
probably shouldn&rsquo;t use it, but it seems to work for me):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  <span style=color:#6272a4>#!/bin/sh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>PREREQ</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;dropbear&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  prereqs<span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>      <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$PREREQ</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$1</span><span style=color:#f1fa8c>&#34;</span> in
</span></span><span style=display:flex><span>      prereqs<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>          prereqs
</span></span><span style=display:flex><span>          <span style=color:#8be9fd;font-style:italic>exit</span> <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span>          ;;
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>esac</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  . <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>CONFDIR</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/initramfs.conf&#34;</span>
</span></span><span style=display:flex><span>  . /usr/share/initramfs-tools/hook-functions
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>[</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DROPBEAR</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span> !<span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;n&#34;</span> <span style=color:#ff79c6>]</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>[</span> -r <span style=color:#f1fa8c>&#34;/etc/crypttab&#34;</span> <span style=color:#ff79c6>]</span> ; <span style=color:#ff79c6>then</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      cat &gt; <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DESTDIR</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/bin/unlock&#34;</span> <span style=color:#f1fa8c>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  #!/bin/sh
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  unlock_devices() {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    pw=&#34;\$(/lib/cryptsetup/askpass &#34;password: &#34;)&#34;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    echo -n \$pw &gt; /lib/cryptsetup/passfifo
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    sleep 1
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    echo -n \$pw &gt; /lib/cryptsetup/passfifo
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  }
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  if unlock_devices; then
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  # kill \`ps | grep cryptroot | grep -v &#34;grep&#34; | awk &#39;{print \$1}&#39;\`
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  # following line kill the remote shell right after the passphrase has
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  # been entered.
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  kill -9 \`ps | grep &#34;\-sh&#34; | grep -v &#34;grep&#34; | awk &#39;{print \$1}&#39;\`
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  exit 0
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  fi
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  exit 1
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      chmod <span style=color:#bd93f9>755</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DESTDIR</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/bin/unlock&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      mkdir -p <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DESTDIR</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/lib/unlock&#34;</span>
</span></span><span style=display:flex><span>      cat &gt; <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DESTDIR</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/lib/unlock/plymouth&#34;</span> <span style=color:#f1fa8c>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  #!/bin/sh
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  [ &#34;\$1&#34; == &#34;--ping&#34; ] &amp;&amp; exit 1
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  /bin/plymouth &#34;\$@&#34;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      chmod <span style=color:#bd93f9>755</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DESTDIR</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/lib/unlock/plymouth&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#8be9fd;font-style:italic>echo</span> To unlock root-partition run <span style=color:#f1fa8c>&#34;unlock&#34;</span> &gt;&gt; <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DESTDIR</span><span style=color:#f1fa8c>}</span>/etc/motd
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>fi</span>
</span></span></code></pre></div><p>That&rsquo;s pretty much all of it, you can now start enjoying remote reboots
on your freshly encrypted Proxmox host.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://oblivious.observer/tags/proxmox/>proxmox</a></li><li><a href=https://oblivious.observer/tags/zfs/>ZFS</a></li><li><a href=https://oblivious.observer/tags/luks/>LUKS</a></li><li><a href=https://oblivious.observer/tags/systemd-boot/>systemd-boot</a></li><li><a href=https://oblivious.observer/tags/dropbear/>dropbear</a></li></ul></footer><script src=https://utteranc.es/client.js repo=observer/observer.github.io issue-term=url label=💬 theme=photon-dark crossorigin=anonymous async></script></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>