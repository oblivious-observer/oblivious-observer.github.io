<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>NixOS Deployment with Colmena | oblivious observer</title><meta name=keywords content="NixOS,flakes,colmena,Deployment"><meta name=description content="In the last post, I wrote about how to convert a &rsquo;normal&rsquo; NixOS system to one that is managed by a flake. This one will build on top of, or rather scale out of managing single hosts and dive into how to do remote management and deployment for multiple systems.
Introduction Before taking a peek into Deployments, lets set a bit of a frame of reference here first:
When talking about deployments a lot of people think about quite complex setups and the use of services such as autoscaling, instance creation etc."><meta name=author content="oblivious observer"><link rel=canonical href=https://oblivious.observer/posts/nixos-multi-host-deployment-with-flakes-and-colmena/><link crossorigin=anonymous href=/assets/css/stylesheet.0c4fd3725171366f335155acde6fb3c7b7042cd2fd075bebf5023d9b28a701b2.css integrity="sha256-DE/TclFxNm8zUVWs3m+zx7cELNL9B1vr9QI9myinAbI=" rel="preload stylesheet" as=style><link rel=icon href=https://oblivious.observer/observer-16x16.png><link rel=icon type=image/png sizes=16x16 href=https://oblivious.observer/observer-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://oblivious.observer/observer-32x32.png><link rel=apple-touch-icon href=https://oblivious.observer/observer-512x512.png><link rel=mask-icon href=https://oblivious.observer/observer-512x512.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://oblivious.observer/css/syntax.css><meta property="og:title" content="NixOS Deployment with Colmena"><meta property="og:description" content="In the last post, I wrote about how to convert a &rsquo;normal&rsquo; NixOS system to one that is managed by a flake. This one will build on top of, or rather scale out of managing single hosts and dive into how to do remote management and deployment for multiple systems.
Introduction Before taking a peek into Deployments, lets set a bit of a frame of reference here first:
When talking about deployments a lot of people think about quite complex setups and the use of services such as autoscaling, instance creation etc."><meta property="og:type" content="article"><meta property="og:url" content="https://oblivious.observer/posts/nixos-multi-host-deployment-with-flakes-and-colmena/"><meta property="og:image" content="https://oblivious.observer/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-07-21T00:00:00+00:00"><meta property="article:modified_time" content="2023-07-21T00:00:00+00:00"><meta property="og:site_name" content="oblivious.observer"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://oblivious.observer/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="NixOS Deployment with Colmena"><meta name=twitter:description content="In the last post, I wrote about how to convert a &rsquo;normal&rsquo; NixOS system to one that is managed by a flake. This one will build on top of, or rather scale out of managing single hosts and dive into how to do remote management and deployment for multiple systems.
Introduction Before taking a peek into Deployments, lets set a bit of a frame of reference here first:
When talking about deployments a lot of people think about quite complex setups and the use of services such as autoscaling, instance creation etc."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://oblivious.observer/posts/"},{"@type":"ListItem","position":3,"name":"NixOS Deployment with Colmena","item":"https://oblivious.observer/posts/nixos-multi-host-deployment-with-flakes-and-colmena/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"NixOS Deployment with Colmena","name":"NixOS Deployment with Colmena","description":"In the last post, I wrote about how to convert a \u0026rsquo;normal\u0026rsquo; NixOS system to one that is managed by a flake. This one will build on top of, or rather scale out of managing single hosts and dive into how to do remote management and deployment for multiple systems.\nIntroduction Before taking a peek into Deployments, lets set a bit of a frame of reference here first:\nWhen talking about deployments a lot of people think about quite complex setups and the use of services such as autoscaling, instance creation etc.","keywords":["NixOS","flakes","colmena","Deployment"],"articleBody":"In the last post, I wrote about how to convert a ’normal’ NixOS system to one that is managed by a flake. This one will build on top of, or rather scale out of managing single hosts and dive into how to do remote management and deployment for multiple systems.\nIntroduction Before taking a peek into Deployments, lets set a bit of a frame of reference here first:\nWhen talking about deployments a lot of people think about quite complex setups and the use of services such as autoscaling, instance creation etc. The setup I’m going to describe here is fairly simple in comparison.\nMy starting point was just a bunch of hosts, some of them physical, some virtual (as in VM, not as in container) and all of them - at least so far - manually managed and upgraded. Boiling it down, I had access to all of the hosts using ssh.\nThis is where I started to look into deployment tools for NixOS and due to the fact that NixOS is built on top of an amazing package manager, there are quite a bunch of them out there: Here is a list of tools on the awesome-nix page on github (lollipop seems to be missing at the moment).\nUnder the hood most of these tools seem to first build the system configuration somewhere, then copy over the closure of the configuration to the specific host it is intended for and finally switch over to it. Before continuing here, you might want to take a peek into how deployment on NixOS works under the hood, here are a few very interesting pointers:\nThere is a nice talk (+transcript) by Vaibhav Sagar from 2018’s linux.conf.au about how to do deployment with NixOS, as well as another nice blog post on how to basically deploy NixOS using bash. Another very nice post by Chris Martin goes into detail on how this can be done on AWS using bash and haskell. Last but definitely not least there is one very nice video as well as a couple of accompanying blog articles by Solène Rapenne on how she implemented deployment on NixOS using a pull instead of a push semantic.\nDeploying NixOS using Colmena When I got started with deploying on NixOS, I initially looked at some of the deployment tools available and after reading through various bits and pieces of documentation and blog posts I decided to give colmena a try.\nAdding all Hosts to the flake To get started, we first need all of the hosts we want to deploy to managed inside a single flake, this is fairly straightforward and was already described in the last post. After adding all of your hosts to the flake, it should look somewhat like this:\n{ description = \"Oblivious Infrastructure\"; inputs = { flake-utils.url = \"github:numtide/flake-utils\"; nix.url = \"github:NixOS/nix/2.5.1\"; nixpkgs.url = \"github:NixOS/nixpkgs/nixos-23.05\"; nixos-hardware.url = \"github:NixOS/nixos-hardware\"; }; outputs = { self, nixpkgs, nix, ... }: { nixosConfigurations = { host0 = nixpkgs.lib.nixosSystem { system = \"x86_64-linux\"; modules = [ ./hosts/host0/configuration.nix ]; }; host1 = nixpkgs.lib.nixosSystem { system = \"x86_64-linux\"; modules = [ ./hosts/host1/configuration.nix ]; }; ... }; }; } Setting up Host Access In order to access and manage all systems, you need to create a keypair, that has access to the root user on the remote machines. Since colmena does not seem to support the option of using a specific ssh key for a host, I opted to simply defining everything host specific outside of colmena and in the ssh config instead.\nAt this point I’d like to mention that apparently colmena (the same applies to deploy-rs) does not seem to support password protected ssh keys, if you try using one you’ll see output like this during the deployment step:\n[ERROR] Failed to complete requested operation - Last 1 lines of logs: [ERROR] failure) Child process exited with error code: 1 [ERROR] Failed to push system closure to azwraith - Last 5 lines of logs: [ERROR] created) [ERROR] state) Running [ERROR] stderr) root@1.2.3.4: Permission denied (publickey,password,keyboard-interactive). [ERROR] stderr) error: cannot connect to 'root@colmena.host' [ERROR] failure) Child process exited with error code: 1 [ERROR] ----- [ERROR] Operation failed with error: Child process exited with error code: 1 Also colmena does not seem to come with a way to define which key is supposed to be used, when accessing a node: while there are the options deployment.targetHost, deployment.targetPort and deployment.targetUser, there is no option such as deployment.sshKey1.\nSo basically you’re supposed to just have a key lying around on your system, which gives you passwordless root level access to all of your infrastructure and is at the same time the default method of accessing all of your nodes via ssh from a terminal. Sounds like a great idea, after all, what could possibly go wrong?\nLuckily, there is actually a fairly easy workaround, which solves all of the little problems I just mentioned. I’m not sure how many people are using it at the moment, I haven’t really read about it anywhere else, but then again, I might just haven’t stumbled over it so far:\nFirst (on the host you want to use to manage your infrastructure with) we need to create a ssh key with a password, e.g. ~/.ssh/colmena.key. using ssh-keygen.\nNext we add the password protected ssh key to the ssh-agent, this way, unlocking the key will be managed by the ssh-agent instead of colmena, so whenever we need to unlock the key, we get a GUI or CLI popup and can simply insert the password and we even get the nice little timeframe wherein the key stays unlocked, so it does not have to be input every single time:\n$ ssh-add ~/.ssh/colmena.key $ ssh-add -L ssh-ed25519 ... user@host Next create an additional colmena entry for the hosts you want to manage in ~/.ssh/config, so in my case I now have 3 entries per host (for the unlock.host entry check out my earlier post, which explains remote decryption):\nHost host Hostname 1.2.3.4 User user Host unlock.host Hostname 1.2.3.4 User root Port 2222 Host colmena.host Hostname 1.2.3.4 User root IdentityFile ~/.ssh/colmena.key You can put the ssh config in a file in your flake repo, which you then include by adding ‘Include /path/to/file’ at the top of your .ssh/config file. This only works at the top of the config, not inbetween:\n# oblivious hosts: Include /home/user/git/infrastructure/.ssh/config Then create a small module on the managed hosts, that enables everything colmena needs to work, e.g. modules/colmena/default.nix:\n{ # https://github.com/NixOS/nix/issues/2330#issuecomment-451650296 nix.trustedUsers = [ \"root\" \"@wheel\" ]; users.users.root.openssh.authorizedKeys.keys = [ \"ssh-ed25519 ...\" \"ssh-rsa ...\" ]; } Finally import the module into all of your hosts configurations and one last time update them all manually.\nGetting started with Colmena In order to use colmena, the flake.nix has to be slightly modified, under outputs add a colmena section parallell to nixosConfigurations containing the hosts information, like this:\n... outputs = { self, nixpkgs, nix, ... }: { colmena = { meta = { nixpkgs = import nixpkgs { system = \"x86_64-linux\"; }; }; host0 = { deployment = { targetHost = \"colmena.host0\"; # \u003c- defined in ~/.ssh/config }; imports = [ ./hosts/host0/configuration.nix ]; }; ... }; nixosConfigurations = { ... }; }; Note the use of the colmena.host0 entry we earlier defined, so we’ll automagically use the correct user and ssh key, when connecting. colmena comes with a targetPort option, but since we are basically defining everything specific to the host access inside of the ssh config, I’d advise against using it here, targetPort is preferred over the ssh config, if the option is set. (Using the option directly after adding a new host combined with the copy and paste mistake of not adjusting the targetPort option, can lead to very annoying node-breaking deployments when you’re accessing hosts behind a NAT.)\nUpdate the flake git repos on all the hosts using nixos-rebuild --flake in order to enable the root ssh access.\nNext check out the repository containing the host(s) managed and grab a version of colmena, e.g. using nix shell github:zhaofengli/colmena.\nThen on the management host grab and enter a copy of the flake repo and check if everything works by using colmena exec2 in order to execute some commands on the remote hosts. Depending on whether or not the ssh key is still unlocked you should either get a pinentry popup, or everything should just work:\n[user@host:~/git/infrastructure]$ colmena exec -v -- 'hostname' [INFO ] Using flake: git+file:///home/user/git/infrastructure [INFO ] Enumerating nodes... copying path '/nix/store/39i5vz1nf5l6q3mxj61yv2ymfms3xhid-source' from 'https://cache.nixos.org'... copying path '/nix/store/f1zgyzaq53q962w78gv54rxmmisfqbrk-source' from 'https://cache.nixos.org'... [INFO ] Selected all 2 nodes. host0 | host1 | host0 | host0 host0 | Succeeded host1 | host1 host1 | Succeeded | All done! Voila, we just executed some commands on a couple of remote hosts in parallel!\nFrom here on managing the hosts is fairly straightforward. To build the system configurations you can use the build command:\n[user@host:~/git/infrastructure]$ colmena build [INFO ] Using flake: git+file:///home/user/git/infrastructure [INFO ] Enumerating nodes... [INFO ] Selected all 2 nodes. ✅ 39s All done! (...) ✅ 15s Evaluated host0 and host1 host0 ✅ 22s Built \"/nix/store/y2w31fwaazjxxq94rcc28qi10xmc0rgz-nixos-system-host0-21.11pre-git host1 ✅ 24s Built \"/nix/store/v3ba77v92hbf1grr3kz649ykrlfrrglm-nixos-system-host1-21.11pre-git Deploying to the hosts is done with the apply command:\n[user@host:~/git/infrastructure]$ colmena apply [INFO ] Using flake: git+file:///home/user/git/infrastructure [INFO ] Enumerating nodes... [INFO ] Selected all 2 nodes. ✅ 28s All done! (...) ✅ 14s Evaluated host0 and host1 host0 ✅ 0s Built \"/nix/store/y2w31fwaazjxxq94rcc28qi10xmc0rgz-nixos-system-host0-21.11pre-git\" host1 ✅ 0s Built \"/nix/store/v3ba77v92hbf1grr3kz649ykrlfrrglm-nixos-system-host1-21.11pre-git\" host0 ✅ 3s Pushed system closure host1 ✅ 9s Pushed system closure host0 ✅ 5s Activation successful host1 ✅ 5s Activation successful After deploying, at this point in time we have new system state on the managed hosts. However their respective /etc/nixos directories are still on some random version of the repo. We can easily solve this using the exec command however. So on the managment host we can push the repo and then use colmena to make sure the revision on all of the hosts is always the same3:\n[user@host:~/git/infrastructure]$ colmena exec -- 'cd /etc/nixos \u0026\u0026 git pull' [INFO ] Using flake: git+file:///home/user/git/infrastructure [INFO ] Enumerating nodes... [INFO ] Selected all 2 nodes. ✅ 1s All done! host0 ✅ 1s Succeeded host1 ✅ 1s Succeeded One noteworthy point is that when using colmena, we seem to loose the ability to update a system using conventional methods:\n[user@host:~]$ sudo nixos-rebuild switch --flake /etc/nixos/#host error: infinite recursion encountered at /nix/store/n9dk853bl3ny2mqv4pjh7440jglm8wz8-source/lib/modules.nix:512:28: 511| builtins.addErrorContext (context name) 512| (args.${name} or config._module.args.${name}) | ^ 513| ) (lib.functionArgs f); (use '--show-trace' to show detailed location information) In order to update a host locally, we need to set the allowLocalDeployment option option in flake.nix (optionally it might make sense to set targetHost to null):\n... outputs = { self, nixpkgs, nix, ... }: { colmena = { meta = { nixpkgs = import nixpkgs { system = \"x86_64-linux\"; }; }; host0 = { deployment = { targetHost = \"colmena.host0\"; # \u003c- optionally set this to 'null' allowLocalDeployment = true; }; imports = [ ./hosts/host0/configuration.nix ]; }; ... }; ... }; ... Then on the host, we can simply grab a copy of the flake repository, build a system configuration using something like colmena build --on host and finally update the system by using the apply-local command:\n[user@host]$ colmena apply-local --sudo [INFO ] Using flake: git+file:///home/user/git/infrastructure host | Evaluating mortimer host | host | Evaluated host host | Building host host | /nix/store/i8vasqriqb184gdc0hnyy38yr9ii2y9w-nixos-system-host-23.05pre-git host | Built \"/nix/store/i8vasqriqb184gdc0hnyy38yr9ii2y9w-nixos-system-host-23.05pre-git\" host | Pushing system closure host | Pushed system closure host | No pre-activation keys to upload host | Activating system profile [sudo] password for user: host | updating GRUB 2 menu... host | activating the configuration... host | setting up /etc... host | reloading user units for user... host | setting up tmpfiles host | Activation successful host | No post-activation keys to upload | All done! At this point we can basically manage, update and deploy hosts as we want.\nCleaning up the flake Now that everything works, we can start cleaning up the flake a bit. Ever since adding in the colmena section, we have to reference the hosts configurations in two places, so lets include a little let statement and store the information we need in hostConfigs:\n{ description = \"Oblivious Infrastructure\"; inputs = { flake-utils.url = \"github:numtide/flake-utils\"; nix.url = \"github:NixOS/nix/2.5.1\"; nixpkgs.url = \"github:NixOS/nixpkgs/nixos-23.05\"; nixos-hardware.url = \"github:NixOS/nixos-hardware\"; }; outputs = {self, nixpkgs, nix, ... }: let hostConfigs = { host0 = [ ./hosts/host0/configuration.nix ]; host1 = [ ./hosts/host1/configuration.nix ]; }; in { colmena = { meta = { nixpkgs = import nixpkgs { system = \"x86_64-linux\"; }; }; host0 = { deployment = { targetHost = \"colmena.host0\"; }; imports = [] ++ hostConfigs.host0; }; host1 = { deployment = { targetHost = \"colmena.host1\"; }; imports = [] ++ hostConfigs.host1; }; }; nixosConfigurations = { host0 = nixpkgs.lib.nixosSystem { system = \"x86_64-linux\"; modules = [] ++ hostConfigs.host0; }; host1 = nixpkgs.lib.nixosSystem { system = \"x86_64-linux\"; modules = [] ++ hostConfigs.host1; }; }; }; } Adding a Development Shell into the Mix A very nice feature, when it comes to flakes is the development shell, simply define a shell, then type nix develop (or even let direnv do all the work) and you end up with a very nice working environment.\nLet’s add a development shell to our flake. In order to do that, we can add a devShell section to our outputs. There is a nice article about how to do this here. I decided to keep the shell definition in a separate shell.nix file. Add the following to flake.nix:\n{ description = \"Oblivious Infrastructure\"; inputs = { ... }; outputs = {self, nixpkgs, nix, ... }: let pkgs = nixpkgs.legacyPackages.x86_64-linux; hostConfigs = { ... }; in { devShell.x86_64-linux = import ./shell.nix {inherit pkgs;}; colmena = { ... }; nixosConfigurations = { ... }; }); } Next create a shell.nix file inside the flake repo:\n{ pkgs ? import {} }: with pkgs; mkShell { buildInputs = [ colmena ]; shellHook = '' export PS1='\\n\\[\\033[1;34m\\][oblivious]\\$\\[\\033[0m\\] ' echo \"\" | base64 -d sync () { # local state # Update all the Inputs: for input in $(cat flake.nix | awk '/inputs = {/,/};/' | grep .url | cut -d '.' -f 1 | tr -d ' ') do nix flake lock --update-input $input done if [[ `git status --porcelain` ]] then cm=\".\" read -p \"Commit message: \" commit_message if ! [[ \"$commit_message\" == \"\" ]] then cm=\"$commit_message\" else cm=\".\" fi git add . git commit -m \"$cm\" git push fi # get the channel we are following in our flake nixpkgsVersion=$(cat flake.nix | grep nixpkgs.url | cut -d '\"' -f 2 | cut -d '/' -f 3) # remote state echo '[INFO ] pulling repo on remote hosts' colmena exec -v -- 'cd /etc/nixos \u0026\u0026 old_rev=$(git rev-parse --short HEAD) \u0026\u0026 git pull | grep \"Already up to date\" || echo \"$old_rev -\u003e $(git rev-parse --short HEAD)\"' echo '[INFO ] updating nix channel on remote hosts' colmena exec -v -- \"nix-channel --add https://nixos.org/channels/$nixpkgsVersion nixos \u0026\u0026 nix-channel --update\" # check channelSyncSuccessful=$(echo $( colmena exec -v -- 'echo nixos channel revision:$(cat /nix/var/nix/profiles/per-user/root/channels/nixos/.git-revision)' 2\u003e\u00261 | grep 'nixos channel revision' | cut -d ':' -f 2 cat flake.lock | jq \".nodes.$(cat flake.lock | jq '.nodes.root.inputs.nixpkgs').locked.rev\" | tr -d '\"' ) | tr ' ' '\\n' | uniq | wc -l ) if ! [[ \"$channelSyncSuccessful\" == \"1\" ]] then echo \"[WARNING!] - Channels on local repo and remote nodes not synced!\" echo \"[WARNING!] - If you're trying to e.g. manually start nixos-containers YMMV\" # exit 1 fi } alias build=\"sync \u0026\u0026 colmena build\" alias deploy=\"sync \u0026\u0026 colmena apply\" ''; } As you can see I added in a sync function, which makes sure the /etc/nixos/ directory always reflects the most recent git commit on all nodes and also updates the nixos-channels on the remote nodes 4.\nI also added two little aliases build and deploy to make life a bit more easy.\nAs a sidenote colmena doesn’t seem to like it, when nodes with a set targetHost are not reachable, a viable solution to this would be to extract the machine addresses from e.g. the hostConfigs section of the flake, check for their availability and if not all hosts are reachable use colmenas --on option to make sure at least the nodes available can be updated without too much of a fuzz.\nAt this point we have a wonderful little devshell, we can jump into from basically anywhere in order to manage our systems:\n[user@host:~/git/infrastructure]$ nix develop _ _ _ _ | | | (_) (_) ___ | |__ | |___ ___ ___ _ _ ___ / _ \\| '_ \\| | \\ \\ / / |/ _ \\| | | / __| | (_) | |_) | | |\\ V /| | (_) | |_| \\__ \\ \\___/|_.__/|_|_| \\_/ |_|\\___/ \\__,_|___/ _ __ _ _ (_) / _| | | | | _ _ __ | |_ _ __ __ _ ___| |_ _ __ _ _ ___| |_ _ _ _ __ ___ | | '_ \\| _| '__/ _` / __| __| '__| | | |/ __| __| | | | '__/ _ \\ | | | | | | | | | (_| \\__ \\ |_| | | |_| | (__| |_| |_| | | | __/ |_|_| |_|_| |_| \\__,_|___/\\__|_| \\__,_|\\___|\\__|\\__,_|_| \\___| [oblivious]$ sync warning: updating lock file '/home/user/git/infrastructure/flake.lock': • Updated input 'nixpkgs': 'github:NixOS/nixpkgs/fcc147b1e9358a8386b2c4368bd928e1f63a7df2' (2023-07-13) → 'github:NixOS/nixpkgs/fa793b06f56896b7d1909e4b69977c7bf842b2f0' (2023-07-20) warning: Git tree '/home/user/git/infrastructure' is dirty warning: Git tree '/home/user/git/infrastructure' is dirty warning: Git tree '/home/user/git/infrastructure' is dirty warning: Git tree '/home/user/git/infrastructure' is dirty Commit message: [master 204c4ba] . 1 file changed, 3 insertions(+), 3 deletions(-) Enumerating objects: 5, done. Counting objects: 100% (5/5), done. Delta compression using up to 12 threads Compressing objects: 100% (3/3), done. Writing objects: 100% (3/3), 368 bytes | 368.00 KiB/s, done. Total 3 (delta 2), reused 0 (delta 0), pack-reused 0 remote: Resolving deltas: 100% (2/2), completed with 2 local objects. To github... 4733c2c..204c4ba master -\u003e master [INFO ] pulling repo on remote hosts [INFO ] Using flake: git+file:///home/user/git/infrastructure [INFO ] Enumerating nodes... [INFO ] Selected all 2 nodes. host0 | host1 | host1 | From github... host1 | 4733c2c..204c4ba master -\u003e origin/master host0 | From github... host0 | 4733c2c..204c4ba master -\u003e origin/master host1 | 4733c2c -\u003e 204c4ba host1 | Succeeded host0 | 4733c2c -\u003e 204c4ba host0 | Succeeded | All done! [INFO ] updating nix channel on remote hosts [INFO ] Using flake: git+file:///home/user/git/infrastructure [INFO ] Enumerating nodes... [INFO ] Selected all 2 nodes. host1 | host0 | host0 | unpacking channels... host1 | unpacking channels... host0 | Succeeded host1 | Succeeded | All done! DIY Secret Management Next let’s take a quick look into how to manage secrets. With colmena a keyComand can be defined, so we can basically build our secret management with whatever tooling we want. For this little example, lets just use pass (I won’t go into detail here, how to set it up, there are enough posts on that on the internet).\nAs a quick recap, this is how our file structure currently looks like:\n[user@host:~/git/infrastructure] tree -CL 2 . ├── flake.nix # our flake file containing information about all hosts and their NixOS configs ├── flake.lock # the flake lock file (autogenerated) ├── shell.nix # our development shell ├── hosts # contains hosts configuration.nix files │ ├── host0 │ ├── host1 ... │ └── hostN ├── modules # modular configuration bits and pieces │ ├── baseUtils ... │ └── zfs ├── pkgs # packages that aren't part of nixpkgs ├── services # services that are hosted on the hosts │ ├── host2 │ │ └── nextloud │ └── host3 ... │ └── navidrome ├── users # user configurations └── vpn # vpn configurations First we’ll use pass to create a secret, in this case we’ll use the following and incredibly misterious string:\nCuKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKgguKjgOKjiOKjkuKjpOKjpOKgpOKgpOKipOKjgOKjgOKggOKggOKggOKggOKggOKggOKggOKhgOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggArioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioITioKDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioqDioaDioIDioIDioZTio7/io7/io7/io7/io7/io7/io7/io6bio4TioIjioJHioJLioIDioILioIDioIDioIDioIDioIjioJLioJLioIrioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIAK4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qGA4qCA4qGF4qC54qGE4qKA4qKk4qG84qO54qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qGm4qC04qO24qCy4qCA4qCA4qCA4qKA4qGk4qGE4qCA4qCS4qCA4qCC4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCACuKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKgsOKgguKgkeKgkuKgkuKgk+Kgg+KgmOKivuKjv+KjvuKhh+KggOKggOKgieKggeKgiOKgieKiu+Kjv+Khh+KgoOKghOKgpOKjgOKggOKggOKggOKgu+KiheKjgOKjiOKjkuKggOKggOKggOKggOKggOKggOKggOKgsuKhhOKggOKggOKggArioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDiobDioIPioqDioLTioKbioKbioqbio5jiorvio7/io7fio6bio6TioKDio4Tio4DioYDiorjio7/io6fioYDioIDioLjio7vioYfioIDioKDio6bioYDioInioJnioqTio4Dio4DioIDioIDioIDioIDioIDioIDioIPioIDioIDioIAK4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qGA4qKA4qCA4qCA4qCA4qCA4qCA4qGg4qCS4qGH4qCC4qKy4qCS4qCS4qO84qOu4qO/4qCJ4qCJ4qCZ4qCA4qC74qCb4qCb4qK64qGP4qCs4qGt4qO14qOA4qCI4qCB4qCA4qCA4qG/4qOf4qOG4qCA4qCA4qCA4qCA4qCj4qOE4qGA4qCA4qCi4qGA4qCA4qCA4qCA4qCACuKggOKggOKggOKggOKhgOKggOKggOKggOKggOKggOKggOKgnuKjgOKgouKggOKggOKggOKggOKikeKhpOKghOKgoOKgrOKij+KjieKjueKjv+Khl+KggOKggOKhv+KhkuKggOKggOKggOKiv+Khl+KgkuKgkuKiuuKgiuKhteKggOKggOKggOKhv+KjreKgj+KhhOKggOKggeKigOKggOKggOKgk+KipOKhgOKgiOKhhuKggOKhgOKggArioIDioIDioITioIDioIDiornioIDioIDioIDioIDiooDiobDioJvioLfioYDioIDioIDioIDiopfioJLioJLioJLioJrioILioKTioLzioqTio6fioYjioJnioK/ioL3ioLLioIDioZbioLvioIDiooDio4nio7nio4nio6fioIDioIDioIDioInio7XioobioJHioobioIDiooDioajioIbio4Dio4DioIDioInioIDioIDioIDioIAK4qCA4qCA4qCA4qCA4qCA4qCJ4qCI4qCB4qCi4qKE4qCP4qCA4qCS4qCS4qGH4qCA4qCA4qC04qGI4qCR4qOO4qOA4qOB4qOA4qG04qCK4qKB4qGf4qC34qKE4qGA4qCA4qCk4qKj4qOk4qGQ4qCS4qCS4qCm4qK84qCW4qCL4qGA4qCA4qCA4qO24qOf4qOK4qOi4qGI4qCS4qOB4qCA4qK44qO/4qG/4qCB4qCA4qCA4qCA4qCA4qCACuKggOKggOKggOKggOKggOKggOKggOKggOKjgOKjuOKggOKggOKggOKggOKgh+KggOKggOKigOKhqOKghuKgiOKgieKgkuKgmuKioOKjpOKiv+Kjh+KggOKggOKggOKggOKigOKgnuKjv+Kjv+Kjn+KjpOKjluKjiuKgoOKgnuKgg+KggOKggOKiu+KgpOKhp+KgpOKio+KjiuKggeKggeKhgOKgieKjgOKghOKggOKggOKggOKggOKggArioIDioIDioIDioIDioaDioIDioIjio4/io7nioKTio4bioaTioIDioIDioIDioIDioIDioIjiooDioZTio6vioK3iornio7/ioq/iob/io77io7/io6TioYTio4DioLTioIvioqDio7/io7/io7/io7fio6bio63io63io5bio7rio7bio6TioYTioJLioJPiorrioIjioKDio4DioqDioJ/ioIDioIvioIHioIDioJLioILioIDioIAK4qCA4qCA4qCA4qKw4qCA4qCA4qCg4qGI4qOs4qK14qCf4qOY4qCy4qC24qCA4qCA4qCA4qO04qCf4qOJ4qO04qO+4qO/4qO/4qO44qK34qK44qCB4qC54qGf4qCD4qCA4qOg4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO34qGA4qKA4qG/4qOI4qCy4qOk4qCP4qG04qCm4qGA4qGW4qCS4qCy4qCE4qCA4qCACuKggOKggOKggOKgoOKgpOKgguKgiuKggeKgiOKgieKjjuKjiOKgteKihOKggOKggOKggOKjuOKjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+KjgOKjh+Kjn+Kjk+KjtuKjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjh+KggOKioOKgkeKgh+Kgj+KitOKhseKgkuKjh+KgmOKihOKggOKggOKggOKggArioIDioILioIDio6DioILioIDioIDioIDioIDioLjioYDiorDioYDiorjioIDioIDioIDio7/io7/io7/io7/io7/io7/io7/io7/io7/io7/ioJ/io7/io5Liobrior/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/ioIbioIDioKfioIDioIDioIDioInioJHioJvioIDioqfioIDioIDioIDioIAK4qKA4qCk4qC+4qC34qOA4qOA4qCH4qG04qOG4qCA4qCz4qGA4qCA4qK54qCA4qCA4qCA4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qOb4qOA4qG/4qC24qCt4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qOm4qCA4qCA4qCA4qKA4qCA4qOf4qCv4qKm4qGA4qCI4qCT4qKk4qGA4qCACuKhjuKgk+KgkuKgguKgpOKhnuKioOKgk+KguuKhgOKggOKip+KggOKhmOKggOKggOKgsOKjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+KhvuKjjeKhr+KgreKjveKjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+KjpuKjhOKggOKgiOKjhuKgs+KirOKgkuKgmuKgkuKhhOKggOKggOKggArioJjioKLioYDioJLiopLioIHioY7iooDiobDioIPioKTioYjioaTior/ioIDioIDioIDio7/io7/io7/io7/io7/io7/io7/io7/io7/ioq3io7/io5/io5Pio7/io7/io7/io7/io7/io4/ioKnioInioInioLvio7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7fio6bio5jioIjioIDioofio6nio4nio7nioILioIDioIAK4qKA4qCQ4qKN4qCB4qCY4qKw4qKJ4qG94qKA4qGA4qKN4qKz4qC44qG34qCA4qCA4qCA4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qOb4qO/4qOS4qO+4qO/4qO/4qO/4qO/4qO/4qC34qGA4qCC4qCA4qCA4qC54qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qOm4qCI4qKJ4qKA4qOW4qCB4qCA4qGG4qCACuKgiOKgseKggOKggOKggOKgm+KgieKhtOKgm+KgmOKgouKhieKggOKggOKggOKggOKggOKjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Khv+Kjv+KgreKiveKjv+Kjv+Kjv+Kjv+Kjv+Kjv+KjreKjpOKhhOKggOKggOKiu+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+KggOKjgOKglOKii+KhpOKhhOKgkOKgggrioIDioIDioIDioIDioIDioaDioJrioIDioIDioKnioY3ioJPio4TioIDioIDioIDiorjio7/io7/io7/io7/ioL/ioL/ioJvio5vio7viob/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7bio7bio77io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/ioIDioIDiooDioafioIDioIjioqLioIAK4qCA4qCA4qKw4qCA4qCA4qKP4qCJ4qCJ4qCJ4qCA4qCJ4qCx4qG84qCA4qCA4qCA4qCw4qO/4qO/4qOv4qOk4qGO4qCt4qCk4qCc4qO/4qO/4qO/4qOT4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qG/4qC/4qKl4qCA4qCw4qO/4qOE4qOA4qCA4qCA4qCACuKggOKggOKguOKggOKggOKhgOKgieKhgOKggOKggOKhsOKgieKggOKggOKggOKggOKggOKguOKjv+Kjv+Kjv+Khg+KgkuKjkuKjveKjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kju+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Khh+KggOKgieKgieKgoeKghOKggOKggOKgoOKgnOKggOKggOKgh+KggOKggOKggOKggOKggArioIDioIDioIDioIDiorBORVZFUiBHT05OQSBHSVZFIFlPVSBVUOKjv+Kjv+Kjv+Kjv+Kjv05FVkVSIEdPTk5BIExFVCBZT1UgRE9XTuKggOKggOKggOKggOKggArioIDioIDioIDioIDioLjioIDioIjiorPioIDioJTioInioIDio7jioIDioIDioIDioIDioIDioJnioqLioIDioIzio73io7/io7/iob/ioL/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/ioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIAK4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCK4qCA4qCA4qCE4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qOA4qCM4qCA4qKg4qK/4qO/4qO/4qGH4qCA4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qGG4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCACgo= Add it to your password store using something along the lines of:\n$ pass edit colmena-test-secret Next create a module which deploys this secret, e.g. ./modules/colmena-test-secret/default.nix:\n{ deployment.keys.\"colmena-test-secret\" = { keyCommand = [ \"pass\" \"colmena-test-secret\" ]; }; } Then add it to the configuration of on of our hosts configuration.nix:\n{ config, pkgs, ... }: { imports = [ ./base.nix ../../modules/colmena-test-secrets ]; } And finally run deploy from the development shell5. After finishing, check if the secret has been properly put on the host, or if our little deployment tool has let us down:\n$ sudo cat /run/keys/colmena-testing-secret | base64 -d ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠂⣀⣈⣒⣤⣤⠤⠤⢤⣀⣀⠀⠀⠀⠀⠀⠀⠀⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀ ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠄⠠⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⡠⠀⠀⡔⣿⣿⣿⣿⣿⣿⣿⣦⣄⠈⠑⠒⠀⠂⠀⠀⠀⠀⠈⠒⠒⠊⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀ ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡀⠀⡅⠹⡄⢀⢤⡼⣹⣿⣿⣿⣿⣿⣿⣿⣿⣿⡦⠴⣶⠲⠀⠀⠀⢀⡤⡄⠀⠒⠀⠂⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀ ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠰⠂⠑⠒⠒⠓⠃⠘⢾⣿⣾⡇⠀⠀⠉⠁⠈⠉⢻⣿⡇⠠⠄⠤⣀⠀⠀⠀⠻⢅⣀⣈⣒⠀⠀⠀⠀⠀⠀⠀⠲⡄⠀⠀⠀ ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡰⠃⢠⠴⠦⠦⢦⣘⢻⣿⣷⣦⣤⠠⣄⣀⡀⢸⣿⣧⡀⠀⠸⣻⡇⠀⠠⣦⡀⠉⠙⢤⣀⣀⠀⠀⠀⠀⠀⠀⠃⠀⠀⠀ ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡀⢀⠀⠀⠀⠀⠀⡠⠒⡇⠂⢲⠒⠒⣼⣮⣿⠉⠉⠙⠀⠻⠛⠛⢺⡏⠬⡭⣵⣀⠈⠁⠀⠀⡿⣟⣆⠀⠀⠀⠀⠣⣄⡀⠀⠢⡀⠀⠀⠀⠀ ⠀⠀⠀⠀⡀⠀⠀⠀⠀⠀⠀⠞⣀⠢⠀⠀⠀⠀⢑⡤⠄⠠⠬⢏⣉⣹⣿⡗⠀⠀⡿⡒⠀⠀⠀⢿⡗⠒⠒⢺⠊⡵⠀⠀⠀⡿⣭⠏⡄⠀⠁⢀⠀⠀⠓⢤⡀⠈⡆⠀⡀⠀ ⠀⠀⠄⠀⠀⢹⠀⠀⠀⠀⢀⡰⠛⠷⡀⠀⠀⠀⢗⠒⠒⠒⠚⠂⠤⠼⢤⣧⡈⠙⠯⠽⠲⠀⡖⠻⠀⢀⣉⣹⣉⣧⠀⠀⠀⠉⣵⢆⠑⢆⠀⢀⡨⠆⣀⣀⠀⠉⠀⠀⠀⠀ ⠀⠀⠀⠀⠀⠉⠈⠁⠢⢄⠏⠀⠒⠒⡇⠀⠀⠴⡈⠑⣎⣀⣁⣀⡴⠊⢁⡟⠷⢄⡀⠀⠤⢣⣤⡐⠒⠒⠦⢼⠖⠋⡀⠀⠀⣶⣟⣊⣢⡈⠒⣁⠀⢸⣿⡿⠁⠀⠀⠀⠀⠀ ⠀⠀⠀⠀⠀⠀⠀⠀⣀⣸⠀⠀⠀⠀⠇⠀⠀⢀⡨⠆⠈⠉⠒⠚⢠⣤⢿⣇⠀⠀⠀⠀⢀⠞⣿⣿⣟⣤⣖⣊⠠⠞⠃⠀⠀⢻⠤⡧⠤⢣⣊⠁⠁⡀⠉⣀⠄⠀⠀⠀⠀⠀ ⠀⠀⠀⠀⡠⠀⠈⣏⣹⠤⣆⡤⠀⠀⠀⠀⠀⠈⢀⡔⣫⠭⢹⣿⢯⡿⣾⣿⣤⡄⣀⠴⠋⢠⣿⣿⣿⣷⣦⣭⣭⣖⣺⣶⣤⡄⠒⠓⢺⠈⠠⣀⢠⠟⠀⠋⠁⠀⠒⠂⠀⠀ ⠀⠀⠀⢰⠀⠀⠠⡈⣬⢵⠟⣘⠲⠶⠀⠀⠀⣴⠟⣉⣴⣾⣿⣿⣸⢷⢸⠁⠹⡟⠃⠀⣠⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣷⡀⢀⡿⣈⠲⣤⠏⡴⠦⡀⡖⠒⠲⠄⠀⠀ ⠀⠀⠀⠠⠤⠂⠊⠁⠈⠉⣎⣈⠵⢄⠀⠀⠀⣸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣀⣇⣟⣓⣶⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣇⠀⢠⠑⠇⠏⢴⡱⠒⣇⠘⢄⠀⠀⠀⠀ ⠀⠂⠀⣠⠂⠀⠀⠀⠀⠸⡀⢰⡀⢸⠀⠀⠀⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠟⣿⣒⡺⢿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠆⠀⠧⠀⠀⠀⠉⠑⠛⠀⢧⠀⠀⠀⠀ ⢀⠤⠾⠷⣀⣀⠇⡴⣆⠀⠳⡀⠀⢹⠀⠀⠀⣿⣿⣿⣿⣿⣿⣿⣿⣿⣛⣀⡿⠶⠭⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣦⠀⠀⠀⢀⠀⣟⠯⢦⡀⠈⠓⢤⡀⠀ ⡎⠓⠒⠂⠤⡞⢠⠓⠺⡀⠀⢧⠀⡘⠀⠀⠰⣿⣿⣿⣿⣿⣿⣿⣿⣿⡾⣍⡯⠭⣽⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣦⣄⠀⠈⣆⠳⢬⠒⠚⠒⡄⠀⠀⠀ ⠘⠢⡀⠒⢒⠁⡎⢀⡰⠃⠤⡈⡤⢿⠀⠀⠀⣿⣿⣿⣿⣿⣿⣿⣿⣿⢭⣿⣟⣓⣿⣿⣿⣿⣿⣏⠩⠉⠉⠻⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣷⣦⣘⠈⠀⢇⣩⣉⣹⠂⠀⠀ ⢀⠐⢍⠁⠘⢰⢉⡽⢀⡀⢍⢳⠸⡷⠀⠀⠀⣿⣿⣿⣿⣿⣿⣿⣿⣿⣛⣿⣒⣾⣿⣿⣿⣿⣿⠷⡀⠂⠀⠀⠹⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣦⠈⢉⢀⣖⠁⠀⡆⠀ ⠈⠱⠀⠀⠀⠛⠉⡴⠛⠘⠢⡉⠀⠀⠀⠀⠀⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⣿⠭⢽⣿⣿⣿⣿⣿⣿⣭⣤⡄⠀⠀⢻⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠀⣀⠔⢋⡤⡄⠐⠂ ⠀⠀⠀⠀⠀⡠⠚⠀⠀⠩⡍⠓⣄⠀⠀⠀⢸⣿⣿⣿⣿⠿⠿⠛⣛⣻⡿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣶⣶⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠀⠀⢀⡧⠀⠈⢢⠀ ⠀⠀⢰⠀⠀⢏⠉⠉⠉⠀⠉⠱⡼⠀⠀⠀⠰⣿⣿⣯⣤⡎⠭⠤⠜⣿⣿⣿⣓⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⠿⢥⠀⠰⣿⣄⣀⠀⠀⠀ ⠀⠀⠸⠀⠀⡀⠉⡀⠀⠀⡰⠉⠀⠀⠀⠀⠀⠸⣿⣿⣿⡃⠒⣒⣽⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣻⣿⣿⣿⣿⣿⣿⡇⠀⠉⠉⠡⠄⠀⠀⠠⠜⠀⠀⠇⠀⠀⠀⠀⠀ ⠀⠀⠀⠀⢰NEVER GONNA GIVE YOU UP⣿⣿⣿⣿⣿NEVER GONNA LET YOU DOWN⠀⠀⠀⠀⠀ ⠀⠀⠀⠀⠸⠀⠈⢳⠀⠔⠉⠀⣸⠀⠀⠀⠀⠀⠙⢢⠀⠌⣽⣿⣿⡿⠿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀ ⠀⠀⠀⠀⠀⠀⠀⠊⠀⠀⠄⠀⠀⠀⠀⠀⠀⠀⣀⠌⠀⢠⢿⣿⣿⡇⠀⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀ I’d say that looks about right.\nColmena also supports other options than keyCommand, such as string or keyFile, but i kind of like the idea of not having all my secrets lying around unencrypted. Also there are a bunch of other options on how to configure secrets documented here.\nSetting some Boundaries While my relationship with colmena can so far be described as incredibly time saving and quite a bit of fun, there were a couple of things I ran into that should be considered. When going down the path of automated deployment you can actually run into a bit of trouble in paradise: the more time you spend with colmena, the more it will over time - and quite sneakily - steal away your storage space.\nThere are two main issues I ran into kind of frequently with colmena, that I wasn’t used to when (not regularly) updating my hosts manually:\nfirstly, the size of the nix store simply explodes secondly, the amount of boot configurations gets so big, the /boot partition runs out of space The size of the nix store can be easily constrained by creating a module for the nix garbage collector (./modules/nix-settings/default.nix):\n{ config, lib, pkgs, ... }: { nix = { gc = { automatic = true; dates = \"weekly\"; options = \"--delete-older-than 14d\"; }; extraOptions = '' min-free = ${toString (100 * 1024 * 1024)} max-free = ${toString (1024 * 1024 * 1024)} ''; autoOptimiseStore = true; # \u003c- this option will hardlink identical files }; } Also we can limit the size of the systemd journal, by creating ./modules/limit-journal-size/default.nix:\n{ config, lib, pkgs, ... }: { services.journald.extraConfig = '' SystemMaxUse=100M MaxFileSec=7day ''; } And then referencing them inside our ./modules/colmena/default.nix:\n{ imports = [ ../nix-settings ../limit-journal-size ]; # https://github.com/NixOS/nix/issues/2330#issuecomment-451650296 nix.settings.trusted-users = [ \"root\" \"@wheel\" ]; users.users.root.openssh.authorizedKeys.keys = [ \"ssh-ed25519 ...\" \"ssh-rsa ...\" ]; } The second problem can be solved by creating a module, which constrains the max amount of available boot configurations. Create ./modules/bootConfigurationLimit/grub/default.nix:\n{ config, pkgs, ... }: { boot.loader.grub.configurationLimit = 16; } Respectively ./modules/bootConfigurationLimit/systemdboot/default.nix:\n{ config, pkgs, ... }: { boot.loader.systemd-boot.configurationLimit = 16; } And then import whichever applies to your hosts in their ./hosts//default.nix files.\nAfter rebuilding and deploying you should be somewhat save from colmenas nature of taking up your personal space.\nAt this point in time you should be able to manage and rollout your infrastructure fairly easily from a single flake. From here on setting up new services over multiple hosts gets to be way more fun.\nThere is maybe one last thing I should mention: sometimes colmena will fail to deploy properly on some of your hosts. This actually happens rather frequently, however most of the times this happens, a simple rerun of the deployment step will sucessfully activate the new configuration and sometimes, depending on what you do, it helps turning things off and on again.\nthere is an option called deployment.keys, but that is for secret management ↩︎\nNote, using the -v flag returns the output of executed commands, whereas not using it simply returns success or failure with colmena. ↩︎\nThis is of course not strictly necessary, however I feel kind of comfortable to know there is always a description of what is running on a node, which you can use to look up what is going on ↩︎\nWhen playing around with containers I noticed they apparently followed the channels, so it was possible to deploy a 22.05 container, whereas a container created on the remote host would still be on 21.11. Not sure how much of the sync function still applies, but it works for me (TM) ↩︎\nWhen using colmena, I’ve found, that inputing the password during an apply operation does not really seem to work nicely, so as a workaround I’ve created an empty entry in my password store called dummy, which I can use to unlock it before deploying by simply executing pass dummy before the deploy command. ↩︎\n","wordCount":"4098","inLanguage":"en","datePublished":"2023-07-21T00:00:00Z","dateModified":"2023-07-21T00:00:00Z","author":[{"@type":"Person","name":"oblivious observer"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://oblivious.observer/posts/nixos-multi-host-deployment-with-flakes-and-colmena/"},"publisher":{"@type":"Organization","name":"oblivious observer","logo":{"@type":"ImageObject","url":"https://oblivious.observer/observer-16x16.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://oblivious.observer accesskey=h title="  (Alt + H)"><img src=https://oblivious.observer/observer-64x64.png alt aria-label=logo height=35></a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://oblivious.observer/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://oblivious.observer/posts/ title=posts><span>posts</span></a></li><li><a href=https://oblivious.observer/archives/ title=archive><span>archive</span></a></li><li><a href=https://oblivious.observer/tags/ title=tags><span>tags</span></a></li><li><a href=https://oblivious.observer/index.html title=about><span>about</span></a></li><li><a href=https://oblivious.observer/index.xml title=rss><span>rss</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>NixOS Deployment with Colmena</h1><div class=post-meta><span title='2023-07-21 00:00:00 +0000 UTC'>July 21, 2023</span>&nbsp;·&nbsp;20 min&nbsp;·&nbsp;oblivious observer</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#introduction aria-label=Introduction>Introduction</a></li><li><a href=#deploying-nixos-using-colmena aria-label="Deploying NixOS using Colmena">Deploying NixOS using Colmena</a><ul><li><a href=#adding-all-hosts-to-the-flake aria-label="Adding all Hosts to the flake">Adding all Hosts to the flake</a></li><li><a href=#setting-up-host-access aria-label="Setting up Host Access">Setting up Host Access</a></li></ul></li><li><a href=#getting-started-with-colmena aria-label="Getting started with Colmena">Getting started with Colmena</a></li><li><a href=#cleaning-up-the-flake aria-label="Cleaning up the flake">Cleaning up the flake</a></li><li><a href=#adding-a-development-shell-into-the-mix aria-label="Adding a Development Shell into the Mix">Adding a Development Shell into the Mix</a></li><li><a href=#diy-secret-management aria-label="DIY Secret Management">DIY Secret Management</a></li><li><a href=#setting-some-boundaries aria-label="Setting some Boundaries">Setting some Boundaries</a></li></ul></div></details></div><div class=post-content><p>In the last <a href=https://oblivious.observer/posts/nixos-configuration-using-flakes/>post</a>, I wrote about how to convert a &rsquo;normal&rsquo; NixOS system to one
that is managed by a flake. This one will build on top of, or rather scale out of
managing single hosts and dive into how to do remote management and deployment
for multiple systems.</p><h2 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h2><p>Before taking a peek into Deployments, lets set a bit of a frame of reference
here first:</p><p>When talking about deployments a lot of people think about quite complex
setups and the use of services such as autoscaling, instance creation etc. The
setup I&rsquo;m going to describe here is fairly simple in comparison.</p><p>My starting point was just a bunch of hosts, some of them physical, some virtual
(as in VM, not as in container) and all of them - at least so far - manually
managed and upgraded. Boiling it down, I had access to all of the hosts using
<code>ssh</code>.</p><p>This is where I started to look into deployment tools for NixOS and due to the
fact that NixOS is built on top of an amazing package manager, there are quite a
bunch of them out there: Here is a <a href=https://github.com/nix-community/awesome-nix#deployment-tools>list</a> of tools on the awesome-nix page on
github (<a href=https://github.com/pinpox/lollypops>lollipop</a> seems to be missing at the moment).</p><p>Under the hood most of these tools seem to first build the system configuration
somewhere, then copy over the closure of the configuration to the specific host
it is intended for and finally switch over to it. Before continuing here, you
might want to take a peek into how deployment on NixOS works under the hood,
here are a few very interesting pointers:</p><p>There is a nice <a href="https://www.youtube.com/watch?v=RsSNEkBGmj0">talk</a> (+<a href=https://vaibhavsagar.com/blog/2019/07/04/functional-devops/>transcript</a>) by Vaibhav Sagar from 2018&rsquo;s linux.conf.au
about how to do deployment with NixOS, as well as another nice blog <a href=https://vaibhavsagar.com/blog/2019/08/22/industrial-strength-deployments/>post</a> on how
to basically deploy NixOS using bash. Another very nice <a href=https://typeclasses.com/nixos-on-aws>post</a> by Chris Martin
goes into detail on how this can be done on AWS using bash and haskell. Last but
definitely not least there is one very nice <a href="https://www.youtube.com/watch?v=KOGmAsWzzc8">video</a> as well as a couple of
accompanying blog <a href=https://dataswamp.org/~solene/tag-bento.html>articles</a> by Solène Rapenne on how she implemented deployment
on NixOS using a pull instead of a push semantic.</p><h2 id=deploying-nixos-using-colmena>Deploying NixOS using Colmena<a hidden class=anchor aria-hidden=true href=#deploying-nixos-using-colmena>#</a></h2><p>When I got started with deploying on NixOS, I initially looked at some of the
deployment tools available and after reading through various bits and pieces of
documentation and blog posts I decided to give <a href=https://colmena.cli.rs/unstable/><code>colmena</code></a> a try.</p><h3 id=adding-all-hosts-to-the-flake>Adding all Hosts to the flake<a hidden class=anchor aria-hidden=true href=#adding-all-hosts-to-the-flake>#</a></h3><p>To get started, we first need all of the hosts we want to deploy to managed
inside a single flake, this is fairly straightforward and was already described
in the last post. After adding all of your hosts to the flake, it should look
somewhat like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{
</span></span><span style=display:flex><span>  description <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;Oblivious Infrastructure&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  inputs <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>    flake-utils<span style=color:#ff79c6>.</span>url    <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;github:numtide/flake-utils&#34;</span>;
</span></span><span style=display:flex><span>    nix<span style=color:#ff79c6>.</span>url            <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;github:NixOS/nix/2.5.1&#34;</span>;
</span></span><span style=display:flex><span>    nixpkgs<span style=color:#ff79c6>.</span>url        <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;github:NixOS/nixpkgs/nixos-23.05&#34;</span>;
</span></span><span style=display:flex><span>    nixos-hardware<span style=color:#ff79c6>.</span>url <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;github:NixOS/nixos-hardware&#34;</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  outputs <span style=color:#ff79c6>=</span> { self<span style=color:#ff79c6>,</span> nixpkgs<span style=color:#ff79c6>,</span> nix<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>...</span> }: {
</span></span><span style=display:flex><span>    nixosConfigurations <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>      host0 <span style=color:#ff79c6>=</span> nixpkgs<span style=color:#ff79c6>.</span>lib<span style=color:#ff79c6>.</span>nixosSystem {
</span></span><span style=display:flex><span>        system <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;x86_64-linux&#34;</span>;
</span></span><span style=display:flex><span>        modules <span style=color:#ff79c6>=</span> [ <span style=color:#f1fa8c>./hosts/host0/configuration.nix</span> ];
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>      host1 <span style=color:#ff79c6>=</span> nixpkgs<span style=color:#ff79c6>.</span>lib<span style=color:#ff79c6>.</span>nixosSystem {
</span></span><span style=display:flex><span>        system <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;x86_64-linux&#34;</span>;
</span></span><span style=display:flex><span>        modules <span style=color:#ff79c6>=</span> [ <span style=color:#f1fa8c>./hosts/host1/configuration.nix</span> ];
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=setting-up-host-access>Setting up Host Access<a hidden class=anchor aria-hidden=true href=#setting-up-host-access>#</a></h3><p>In order to access and manage all systems, you need to create a keypair, that
has access to the root user on the remote machines. Since <code>colmena</code> does not seem
to support the option of using a specific ssh key for a host, I opted to simply
defining everything host specific outside of <code>colmena</code> and in the ssh config
instead.</p><p>At this point I&rsquo;d like to mention that apparently <code>colmena</code> (the same applies to
<code>deploy-rs</code>) does not seem to support password protected ssh keys, if you try
using one you&rsquo;ll see output like this during the deployment step:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff79c6>[</span>ERROR<span style=color:#ff79c6>]</span> Failed to <span style=color:#8be9fd;font-style:italic>complete</span> requested operation - Last <span style=color:#bd93f9>1</span> lines of logs:
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>ERROR<span style=color:#ff79c6>]</span>  failure<span style=color:#ff79c6>)</span> Child process exited with error code: <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>ERROR<span style=color:#ff79c6>]</span> Failed to push system closure to azwraith - Last <span style=color:#bd93f9>5</span> lines of logs:
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>ERROR<span style=color:#ff79c6>]</span>  created<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>ERROR<span style=color:#ff79c6>]</span>    state<span style=color:#ff79c6>)</span> Running
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>ERROR<span style=color:#ff79c6>]</span>   stderr<span style=color:#ff79c6>)</span> root@1.2.3.4: Permission denied <span style=color:#ff79c6>(</span>publickey,password,keyboard-interactive<span style=color:#ff79c6>)</span>.
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>ERROR<span style=color:#ff79c6>]</span>   stderr<span style=color:#ff79c6>)</span> error: cannot connect to <span style=color:#f1fa8c>&#39;root@colmena.host&#39;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>ERROR<span style=color:#ff79c6>]</span>  failure<span style=color:#ff79c6>)</span> Child process exited with error code: <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>ERROR<span style=color:#ff79c6>]</span> -----
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>ERROR<span style=color:#ff79c6>]</span> Operation failed with error: Child process exited with error code: <span style=color:#bd93f9>1</span>
</span></span></code></pre></div><p>Also <code>colmena</code> does not seem to come with a way to define which key is supposed to
be used, when accessing a node: while there are the options
<code>deployment.targetHost</code>, <code>deployment.targetPort</code> and <code>deployment.targetUser</code>, there is
no option such as <code>deployment.sshKey</code><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>.</p><p>So basically you&rsquo;re supposed to just have a key lying around on your system,
which gives you passwordless root level access to all of your infrastructure and
is at the same time the default method of accessing all of your nodes via <code>ssh</code>
from a terminal. Sounds like a great idea, after all, what could possibly go
wrong?</p><p>Luckily, there is actually a fairly easy workaround, which solves all of the
little problems I just mentioned. I&rsquo;m not sure how many people are using it at
the moment, I haven&rsquo;t really read about it anywhere else, but then again, I
might just haven&rsquo;t stumbled over it so far:</p><p>First (on the host you want to use to manage your infrastructure with) we need
to create a ssh key with a password, e.g. <code>~/.ssh/colmena.key</code>. using <code>ssh-keygen</code>.</p><p>Next we add the password protected ssh key to the <code>ssh-agent</code>, this way, unlocking
the key will be managed by the ssh-agent instead of <code>colmena</code>, so whenever we need
to unlock the key, we get a GUI or CLI popup and can simply insert the password
and we even get the nice little timeframe wherein the key stays unlocked, so it
does not have to be input every single time:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ssh-add ~/.ssh/colmena.key
</span></span><span style=display:flex><span>$ ssh-add -L
</span></span><span style=display:flex><span>ssh-ed25519 ... user@host
</span></span></code></pre></div><p>Next create an additional colmena entry for the hosts you want to manage in
<code>~/.ssh/config</code>, so in my case I now have 3 entries per host (for the
<code>unlock.host</code> entry check out my earlier <a href=https://oblivious.observer/posts/nixos-20.03-luks-zfs-kvm/>post</a>, which explains remote decryption):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-cfg data-lang=cfg><span style=display:flex><span><span style=color:#50fa7b>Host host</span>
</span></span><span style=display:flex><span>  <span style=color:#50fa7b>Hostname 1.2.3.4</span>
</span></span><span style=display:flex><span>  <span style=color:#50fa7b>User user</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>Host unlock.host</span>
</span></span><span style=display:flex><span>  <span style=color:#50fa7b>Hostname 1.2.3.4</span>
</span></span><span style=display:flex><span>  <span style=color:#50fa7b>User root</span>
</span></span><span style=display:flex><span>  <span style=color:#50fa7b>Port 2222</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex;background-color:#3d3f4a><span><span style=color:#50fa7b>Host colmena.host</span>
</span></span><span style=display:flex;background-color:#3d3f4a><span>  <span style=color:#50fa7b>Hostname 1.2.3.4</span>
</span></span><span style=display:flex;background-color:#3d3f4a><span>  <span style=color:#50fa7b>User root</span>
</span></span><span style=display:flex;background-color:#3d3f4a><span>  <span style=color:#50fa7b>IdentityFile ~/.ssh/colmena.key</span>
</span></span></code></pre></div><p>You can put the ssh config in a file in your flake repo, which you then include
by adding &lsquo;Include /path/to/file&rsquo; at the top of your <code>.ssh/config</code> file. This only
works at the top of the config, not inbetween:</p><pre tabindex=0><code class=language-config data-lang=config># oblivious hosts:
Include /home/user/git/infrastructure/.ssh/config
</code></pre><p>Then create a small module on the managed hosts, that enables everything colmena
needs to work, e.g. <code>modules/colmena/default.nix</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4># https://github.com/NixOS/nix/issues/2330#issuecomment-451650296</span>
</span></span><span style=display:flex><span>  nix<span style=color:#ff79c6>.</span>trustedUsers <span style=color:#ff79c6>=</span> [ <span style=color:#f1fa8c>&#34;root&#34;</span> <span style=color:#f1fa8c>&#34;@wheel&#34;</span> ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  users<span style=color:#ff79c6>.</span>users<span style=color:#ff79c6>.</span>root<span style=color:#ff79c6>.</span>openssh<span style=color:#ff79c6>.</span>authorizedKeys<span style=color:#ff79c6>.</span>keys <span style=color:#ff79c6>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;ssh-ed25519 ...&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;ssh-rsa     ...&#34;</span>
</span></span><span style=display:flex><span>  ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Finally import the module into all of your hosts configurations and one last
time update them all manually.</p><h2 id=getting-started-with-colmena>Getting started with Colmena<a hidden class=anchor aria-hidden=true href=#getting-started-with-colmena>#</a></h2><p>In order to use colmena, the <code>flake.nix</code> has to be slightly modified, under
<code>outputs</code> add a <code>colmena</code> section parallell to <code>nixosConfigurations</code> containing the
hosts information, like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span>  outputs = { self<span style=color:#ff79c6>,</span> nixpkgs<span style=color:#ff79c6>,</span> nix<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>...</span> }: {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    colmena <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>      meta <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>        nixpkgs <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>import</span> nixpkgs {
</span></span><span style=display:flex><span>          system <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;x86_64-linux&#34;</span>;
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      host0 <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>        deployment <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>          targetHost <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;colmena.host0&#34;</span>; <span style=color:#6272a4># &lt;- defined in ~/.ssh/config</span>
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>        imports <span style=color:#ff79c6>=</span> [ <span style=color:#f1fa8c>./hosts/host0/configuration.nix</span> ];
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    nixosConfigurations <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span></code></pre></div><p>Note the use of the <code>colmena.host0</code> entry we earlier defined, so we&rsquo;ll
automagically use the correct user and ssh key, when connecting. <code>colmena</code> comes
with a <code>targetPort</code> option, but since we are basically defining everything
specific to the host access inside of the ssh config, I&rsquo;d advise against using
it here, targetPort is preferred over the ssh config, if the option is set.
(Using the option directly after adding a new host combined with the copy and
paste mistake of not adjusting the <code>targetPort</code> option, can lead to very annoying
node-breaking deployments when you&rsquo;re accessing hosts behind a NAT.)</p><p>Update the flake git repos on all the hosts using <code>nixos-rebuild --flake</code> in order
to enable the root ssh access.</p><p>Next check out the repository containing the host(s) managed and grab a version
of <code>colmena</code>, e.g. using <code>nix shell github:zhaofengli/colmena</code>.</p><p>Then on the management host grab and enter a copy of the flake repo and check if
everything works by using <code>colmena exec</code><sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> in order to execute some commands on the remote hosts.
Depending on whether or not the ssh key is still unlocked you should either get
a pinentry popup, or everything should just work:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff79c6>[</span>user@host:~/git/infrastructure<span style=color:#ff79c6>]</span>$ colmena <span style=color:#8be9fd;font-style:italic>exec</span> -v -- <span style=color:#f1fa8c>&#39;hostname&#39;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>INFO <span style=color:#ff79c6>]</span> Using flake: git+file:///home/user/git/infrastructure
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>INFO <span style=color:#ff79c6>]</span> Enumerating nodes...
</span></span><span style=display:flex><span>copying path <span style=color:#f1fa8c>&#39;/nix/store/39i5vz1nf5l6q3mxj61yv2ymfms3xhid-source&#39;</span> from <span style=color:#f1fa8c>&#39;https://cache.nixos.org&#39;</span>...
</span></span><span style=display:flex><span>copying path <span style=color:#f1fa8c>&#39;/nix/store/f1zgyzaq53q962w78gv54rxmmisfqbrk-source&#39;</span> from <span style=color:#f1fa8c>&#39;https://cache.nixos.org&#39;</span>...
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>INFO <span style=color:#ff79c6>]</span> Selected all <span style=color:#bd93f9>2</span> nodes.
</span></span><span style=display:flex><span>  host0 |
</span></span><span style=display:flex><span>  host1 |
</span></span><span style=display:flex><span>  host0 | host0
</span></span><span style=display:flex><span>  host0 | Succeeded
</span></span><span style=display:flex><span>  host1 | host1
</span></span><span style=display:flex><span>  host1 | Succeeded
</span></span><span style=display:flex><span>        | All <span style=color:#ff79c6>done</span>!
</span></span></code></pre></div><p>Voila, we just executed some commands on a couple of remote hosts in parallel!</p><p>From here on managing the hosts is fairly straightforward. To build the system
configurations you can use the <code>build</code> command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff79c6>[</span>user@host:~/git/infrastructure<span style=color:#ff79c6>]</span>$ colmena build
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>INFO <span style=color:#ff79c6>]</span> Using flake: git+file:///home/user/git/infrastructure
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>INFO <span style=color:#ff79c6>]</span> Enumerating nodes...
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>INFO <span style=color:#ff79c6>]</span> Selected all <span style=color:#bd93f9>2</span> nodes.
</span></span><span style=display:flex><span>      ✅ 39s All <span style=color:#ff79c6>done</span>!
</span></span><span style=display:flex><span><span style=color:#ff79c6>(</span>...<span style=color:#ff79c6>)</span> ✅ 15s Evaluated host0 and host1
</span></span><span style=display:flex><span>host0 ✅ 22s Built <span style=color:#f1fa8c>&#34;/nix/store/y2w31fwaazjxxq94rcc28qi10xmc0rgz-nixos-system-host0-21.11pre-git
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>host1 ✅ 24s Built &#34;</span>/nix/store/v3ba77v92hbf1grr3kz649ykrlfrrglm-nixos-system-host1-21.11pre-git
</span></span></code></pre></div><p>Deploying to the hosts is done with the <code>apply</code> command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff79c6>[</span>user@host:~/git/infrastructure<span style=color:#ff79c6>]</span>$ colmena apply
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>INFO <span style=color:#ff79c6>]</span> Using flake: git+file:///home/user/git/infrastructure
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>INFO <span style=color:#ff79c6>]</span> Enumerating nodes...
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>INFO <span style=color:#ff79c6>]</span> Selected all <span style=color:#bd93f9>2</span> nodes.
</span></span><span style=display:flex><span>      ✅ 28s All <span style=color:#ff79c6>done</span>!
</span></span><span style=display:flex><span><span style=color:#ff79c6>(</span>...<span style=color:#ff79c6>)</span> ✅ 14s Evaluated host0 and host1
</span></span><span style=display:flex><span>host0 ✅ 0s Built <span style=color:#f1fa8c>&#34;/nix/store/y2w31fwaazjxxq94rcc28qi10xmc0rgz-nixos-system-host0-21.11pre-git&#34;</span>
</span></span><span style=display:flex><span>host1 ✅ 0s Built <span style=color:#f1fa8c>&#34;/nix/store/v3ba77v92hbf1grr3kz649ykrlfrrglm-nixos-system-host1-21.11pre-git&#34;</span>
</span></span><span style=display:flex><span>host0 ✅ 3s Pushed system closure
</span></span><span style=display:flex><span>host1 ✅ 9s Pushed system closure
</span></span><span style=display:flex><span>host0 ✅ 5s Activation successful
</span></span><span style=display:flex><span>host1 ✅ 5s Activation successful
</span></span></code></pre></div><p>After deploying, at this point in time we have new system state on the managed
hosts. However their respective <code>/etc/nixos</code> directories are still on some random
version of the repo. We can easily solve this using the exec command however. So
on the managment host we can push the repo and then use colmena to make sure the
revision on all of the hosts is always the same<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff79c6>[</span>user@host:~/git/infrastructure<span style=color:#ff79c6>]</span>$ colmena <span style=color:#8be9fd;font-style:italic>exec</span> -- <span style=color:#f1fa8c>&#39;cd /etc/nixos &amp;&amp; git pull&#39;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>INFO <span style=color:#ff79c6>]</span> Using flake: git+file:///home/user/git/infrastructure
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>INFO <span style=color:#ff79c6>]</span> Enumerating nodes...
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>INFO <span style=color:#ff79c6>]</span> Selected all <span style=color:#bd93f9>2</span> nodes.
</span></span><span style=display:flex><span>      ✅ 1s All <span style=color:#ff79c6>done</span>!
</span></span><span style=display:flex><span>host0 ✅ 1s Succeeded
</span></span><span style=display:flex><span>host1 ✅ 1s Succeeded
</span></span></code></pre></div><p>One noteworthy point is that when using <code>colmena</code>, we seem to loose the ability to
update a system using conventional methods:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff79c6>[</span>user@host:~<span style=color:#ff79c6>]</span>$ sudo nixos-rebuild switch --flake /etc/nixos/#host
</span></span><span style=display:flex><span>error: infinite recursion encountered
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       at /nix/store/n9dk853bl3ny2mqv4pjh7440jglm8wz8-source/lib/modules.nix:512:28:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          511|         builtins.addErrorContext <span style=color:#ff79c6>(</span>context name<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>          512|           <span style=color:#ff79c6>(</span>args.<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>name</span><span style=color:#f1fa8c>}</span> or config._module.args.<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>name</span><span style=color:#f1fa8c>}</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>             |                            ^
</span></span><span style=display:flex><span>          513|       <span style=color:#ff79c6>)</span> <span style=color:#ff79c6>(</span>lib.functionArgs f<span style=color:#ff79c6>)</span>;
</span></span><span style=display:flex><span><span style=color:#ff79c6>(</span>use <span style=color:#f1fa8c>&#39;--show-trace&#39;</span> to show detailed location information<span style=color:#ff79c6>)</span>
</span></span></code></pre></div><p>In order to update a host locally, we need to set the <code>allowLocalDeployment</code> option
option in <code>flake.nix</code> (optionally it might make sense to set <code>targetHost</code> to <code>null</code>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span>  outputs = { self<span style=color:#ff79c6>,</span> nixpkgs<span style=color:#ff79c6>,</span> nix<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>...</span> }: {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    colmena <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>      meta <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>        nixpkgs <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>import</span> nixpkgs {
</span></span><span style=display:flex><span>          system <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;x86_64-linux&#34;</span>;
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      host0 <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>        deployment <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex;background-color:#3d3f4a><span>          targetHost <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;colmena.host0&#34;</span>; <span style=color:#6272a4># &lt;- optionally set this to &#39;null&#39;</span>
</span></span><span style=display:flex;background-color:#3d3f4a><span>          allowLocalDeployment <span style=color:#ff79c6>=</span> true;
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>        imports <span style=color:#ff79c6>=</span> [ <span style=color:#f1fa8c>./hosts/host0/configuration.nix</span> ];
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span><span style=color:#ff79c6>...</span>
</span></span></code></pre></div><p>Then on the host, we can simply grab a copy of the flake repository, build a
system configuration using something like <code>colmena build --on host</code> and finally
update the system by using the <code>apply-local</code> command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff79c6>[</span>user@host<span style=color:#ff79c6>]</span>$ colmena apply-local --sudo
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>INFO <span style=color:#ff79c6>]</span> Using flake: git+file:///home/user/git/infrastructure
</span></span><span style=display:flex><span>host | Evaluating mortimer
</span></span><span style=display:flex><span>host |
</span></span><span style=display:flex><span>host | Evaluated host
</span></span><span style=display:flex><span>host | Building host
</span></span><span style=display:flex><span>host | /nix/store/i8vasqriqb184gdc0hnyy38yr9ii2y9w-nixos-system-host-23.05pre-git
</span></span><span style=display:flex><span>host | Built <span style=color:#f1fa8c>&#34;/nix/store/i8vasqriqb184gdc0hnyy38yr9ii2y9w-nixos-system-host-23.05pre-git&#34;</span>
</span></span><span style=display:flex><span>host | Pushing system closure
</span></span><span style=display:flex><span>host | Pushed system closure
</span></span><span style=display:flex><span>host | No pre-activation keys to upload
</span></span><span style=display:flex><span>host | Activating system profile
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>sudo<span style=color:#ff79c6>]</span> password <span style=color:#ff79c6>for</span> user:
</span></span><span style=display:flex><span>host | updating GRUB <span style=color:#bd93f9>2</span> menu...
</span></span><span style=display:flex><span>host | activating the configuration...
</span></span><span style=display:flex><span>host | setting up /etc...
</span></span><span style=display:flex><span>host | reloading user units <span style=color:#ff79c6>for</span> user...
</span></span><span style=display:flex><span>host | setting up tmpfiles
</span></span><span style=display:flex><span>host | Activation successful
</span></span><span style=display:flex><span>host | No post-activation keys to upload
</span></span><span style=display:flex><span>     | All <span style=color:#ff79c6>done</span>!
</span></span></code></pre></div><p>At this point we can basically manage, update and deploy hosts as we want.</p><h2 id=cleaning-up-the-flake>Cleaning up the flake<a hidden class=anchor aria-hidden=true href=#cleaning-up-the-flake>#</a></h2><p>Now that everything works, we can start cleaning up the flake a bit. Ever since
adding in the <code>colmena</code> section, we have to reference the hosts configurations in
two places, so lets include a little <code>let</code> statement and store the information we
need in <code>hostConfigs</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-nix data-lang=nix><span style=display:flex><span>{
</span></span><span style=display:flex><span>  description <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;Oblivious Infrastructure&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  inputs <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>    flake-utils<span style=color:#ff79c6>.</span>url    <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;github:numtide/flake-utils&#34;</span>;
</span></span><span style=display:flex><span>    nix<span style=color:#ff79c6>.</span>url            <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;github:NixOS/nix/2.5.1&#34;</span>;
</span></span><span style=display:flex><span>    nixpkgs<span style=color:#ff79c6>.</span>url        <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;github:NixOS/nixpkgs/nixos-23.05&#34;</span>;
</span></span><span style=display:flex><span>    nixos-hardware<span style=color:#ff79c6>.</span>url <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;github:NixOS/nixos-hardware&#34;</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  outputs <span style=color:#ff79c6>=</span> {self<span style=color:#ff79c6>,</span> nixpkgs<span style=color:#ff79c6>,</span> nix<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>...</span> }:
</span></span><span style=display:flex;background-color:#3d3f4a><span>  <span style=color:#ff79c6>let</span>
</span></span><span style=display:flex;background-color:#3d3f4a><span>    hostConfigs <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex;background-color:#3d3f4a><span>      host0    <span style=color:#ff79c6>=</span> [ <span style=color:#f1fa8c>./hosts/host0/configuration.nix</span> ];
</span></span><span style=display:flex;background-color:#3d3f4a><span>      host1    <span style=color:#ff79c6>=</span> [ <span style=color:#f1fa8c>./hosts/host1/configuration.nix</span> ];
</span></span><span style=display:flex;background-color:#3d3f4a><span>    };
</span></span><span style=display:flex;background-color:#3d3f4a><span>  <span style=color:#ff79c6>in</span>
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    colmena <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>      meta <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>        nixpkgs <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>import</span> nixpkgs {
</span></span><span style=display:flex><span>          system <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;x86_64-linux&#34;</span>;
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>      host0 <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>        deployment <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>          targetHost <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;colmena.host0&#34;</span>;
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex;background-color:#3d3f4a><span>        imports <span style=color:#ff79c6>=</span> [] <span style=color:#ff79c6>++</span> hostConfigs<span style=color:#ff79c6>.</span>host0;
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>      host1 <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>        deployment <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>          targetHost <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;colmena.host1&#34;</span>;
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex;background-color:#3d3f4a><span>        imports <span style=color:#ff79c6>=</span> [] <span style=color:#ff79c6>++</span> hostConfigs<span style=color:#ff79c6>.</span>host1;
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    nixosConfigurations <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>      host0 <span style=color:#ff79c6>=</span> nixpkgs<span style=color:#ff79c6>.</span>lib<span style=color:#ff79c6>.</span>nixosSystem {
</span></span><span style=display:flex><span>        system <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;x86_64-linux&#34;</span>;
</span></span><span style=display:flex;background-color:#3d3f4a><span>        modules <span style=color:#ff79c6>=</span> [] <span style=color:#ff79c6>++</span> hostConfigs<span style=color:#ff79c6>.</span>host0;
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>      host1 <span style=color:#ff79c6>=</span> nixpkgs<span style=color:#ff79c6>.</span>lib<span style=color:#ff79c6>.</span>nixosSystem {
</span></span><span style=display:flex><span>        system <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;x86_64-linux&#34;</span>;
</span></span><span style=display:flex;background-color:#3d3f4a><span>        modules <span style=color:#ff79c6>=</span> [] <span style=color:#ff79c6>++</span> hostConfigs<span style=color:#ff79c6>.</span>host1;
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=adding-a-development-shell-into-the-mix>Adding a Development Shell into the Mix<a hidden class=anchor aria-hidden=true href=#adding-a-development-shell-into-the-mix>#</a></h2><p>A very nice feature, when it comes to flakes is the development shell, simply
define a shell, then type <code>nix develop</code> (or even let <code>direnv</code> do all the work) and
you end up with a very nice working environment.</p><p>Let&rsquo;s add a development shell to our flake. In order to do that, we can add a
<code>devShell</code> section to our outputs. There is a nice article about how to do this
<a href=https://ghedam.at/a-tour-of-nix-flakes>here</a>. I decided to keep the shell definition in a separate <code>shell.nix</code> file. Add
the following to <code>flake.nix</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-nix data-lang=nix><span style=display:flex><span>{
</span></span><span style=display:flex><span>  description <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;Oblivious Infrastructure&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  inputs <span style=color:#ff79c6>=</span> { <span style=color:#ff79c6>...</span> };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  outputs <span style=color:#ff79c6>=</span> {self<span style=color:#ff79c6>,</span> nixpkgs<span style=color:#ff79c6>,</span> nix<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>...</span> }:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>let</span>
</span></span><span style=display:flex;background-color:#3d3f4a><span>    pkgs <span style=color:#ff79c6>=</span> nixpkgs<span style=color:#ff79c6>.</span>legacyPackages<span style=color:#ff79c6>.</span>x86_64-linux;
</span></span><span style=display:flex><span>    hostConfigs <span style=color:#ff79c6>=</span> { <span style=color:#ff79c6>...</span> };
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>in</span>
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex;background-color:#3d3f4a><span>    devShell<span style=color:#ff79c6>.</span>x86_64-linux <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>import</span> <span style=color:#f1fa8c>./shell.nix</span> {<span style=color:#ff79c6>inherit</span> pkgs;};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    colmena <span style=color:#ff79c6>=</span> { <span style=color:#ff79c6>...</span> };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    nixosConfigurations <span style=color:#ff79c6>=</span> { <span style=color:#ff79c6>...</span> };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Next create a <code>shell.nix</code> file inside the flake repo:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{ pkgs <span style=color:#ff79c6>?</span> <span style=color:#ff79c6>import</span> <span style=color:#f1fa8c>&lt;nixpkgs&gt;</span> {} }:
</span></span><span style=display:flex><span><span style=color:#ff79c6>with</span> pkgs;
</span></span><span style=display:flex><span>mkShell {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  buildInputs <span style=color:#ff79c6>=</span> [ colmena ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  shellHook <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    export PS1=&#39;\n\[\033[1;34m\][oblivious]\$\[\033[0m\] &#39;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    echo &#34;&lt;some ASCII art&gt;&#34; | base64 -d
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    sync () {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      # local state
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      # Update all the Inputs:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      for input in $(cat flake.nix | awk &#39;/inputs = {/,/};/&#39; | grep .url | cut -d &#39;.&#39; -f 1 | tr -d &#39; &#39;)
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      do
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        nix flake lock --update-input $input
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      done
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      if [[ `git status --porcelain` ]]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      then
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        cm=&#34;.&#34;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        read -p &#34;Commit message: &#34; commit_message
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        if ! [[ &#34;$commit_message&#34; == &#34;&#34; ]]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        then
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>          cm=&#34;$commit_message&#34;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        else
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>          cm=&#34;.&#34;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        fi
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        git add .
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        git commit -m &#34;$cm&#34;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        git push
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      fi
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      # get the channel we are following in our flake
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      nixpkgsVersion=$(cat flake.nix | grep nixpkgs.url | cut -d &#39;&#34;&#39; -f 2 | cut -d &#39;/&#39; -f 3)
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      # remote state
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      echo &#39;[INFO ] pulling repo on remote hosts&#39;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      colmena exec -v -- &#39;cd /etc/nixos &amp;&amp; old_rev=$(git rev-parse --short HEAD) &amp;&amp; git pull | grep &#34;Already up to date&#34; || echo &#34;$old_rev -&gt; $(git rev-parse --short HEAD)&#34;&#39;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      echo &#39;[INFO ] updating nix channel on remote hosts&#39;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      colmena exec -v -- &#34;nix-channel --add https://nixos.org/channels/$nixpkgsVersion nixos &amp;&amp; nix-channel --update&#34;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      # check
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      channelSyncSuccessful=$(echo $(
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>          colmena exec -v -- &#39;echo nixos channel revision:$(cat /nix/var/nix/profiles/per-user/root/channels/nixos/.git-revision)&#39; 2&gt;&amp;1 | grep &#39;nixos channel revision&#39; | cut -d &#39;:&#39; -f 2
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>          cat flake.lock | jq &#34;.nodes.$(cat flake.lock | jq &#39;.nodes.root.inputs.nixpkgs&#39;).locked.rev&#34; | tr -d &#39;&#34;&#39;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        ) | tr &#39; &#39; &#39;\n&#39; | uniq | wc -l
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      )
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      if ! [[ &#34;$channelSyncSuccessful&#34; == &#34;1&#34; ]]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      then
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        echo &#34;[WARNING!] - Channels on local repo and remote nodes not synced!&#34;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        echo &#34;[WARNING!] - If you&#39;re trying to e.g. manually start nixos-containers YMMV&#34;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        # exit 1
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      fi
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    }
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    alias build=&#34;sync &amp;&amp; colmena build&#34;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    alias deploy=&#34;sync &amp;&amp; colmena apply&#34;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  &#39;&#39;</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>As you can see I added in a <code>sync</code> function, which makes sure the <code>/etc/nixos/</code>
directory always reflects the most recent git commit on all nodes and also
updates the <code>nixos-channels</code> on the remote nodes <sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>.</p><p>I also added two little aliases <code>build</code> and <code>deploy</code> to make life a bit more easy.</p><p>As a sidenote <code>colmena</code> doesn&rsquo;t seem to like it, when nodes with a set <code>targetHost</code>
are not reachable, a viable solution to this would be to extract the machine
addresses from e.g. the <code>hostConfigs</code> section of the flake, check for their
availability and if not all hosts are reachable use colmenas <code>--on</code> option to make
sure at least the nodes available can be updated without too much of a fuzz.</p><p>At this point we have a wonderful little devshell, we can jump into from
basically anywhere in order to manage our systems:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff79c6>[</span>user@host:~/git/infrastructure<span style=color:#ff79c6>]</span>$ nix develop
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                 _     _ _       _
</span></span><span style=display:flex><span>                | |   | <span style=color:#ff79c6>(</span>_<span style=color:#ff79c6>)</span>     <span style=color:#ff79c6>(</span>_<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>            ___ | |__ | |___   ___  ___  _   _ ___
</span></span><span style=display:flex><span>           / _ <span style=color:#f1fa8c>\|</span> <span style=color:#f1fa8c>&#39;_ \| | \ \ / / |/ _ \| | | / __|
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>          | (_) | |_) | | |\ V /| | (_) | |_| \__ \
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>           \___/|_.__/|_|_| \_/ |_|\___/ \__,_|___/
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c> _        __               _                   _
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>(_)      / _|             | |                 | |
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c> _ _ __ | |_ _ __ __ _ ___| |_ _ __ _   _  ___| |_ _   _ _ __ ___
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>| | &#39;</span>_ <span style=color:#f1fa8c>\|</span>  _| <span style=color:#f1fa8c>&#39;__/ _` / __| __| &#39;</span>__| | | |/ __| __| | | | <span style=color:#f1fa8c>&#39;__/ _ \
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>| | | | | | | | | (_| \__ \ |_| |  | |_| | (__| |_| |_| | | |  __/
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>|_|_| |_|_| |_|  \__,_|___/\__|_|   \__,_|\___|\__|\__,_|_|  \___|
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>[oblivious]$ sync
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>warning: updating lock file &#39;</span>/home/user/git/infrastructure/flake.lock<span style=color:#f1fa8c>&#39;:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>• Updated input &#39;</span>nixpkgs<span style=color:#f1fa8c>&#39;:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    &#39;</span>github:NixOS/nixpkgs/fcc147b1e9358a8386b2c4368bd928e1f63a7df2<span style=color:#f1fa8c>&#39; (2023-07-13)
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  → &#39;</span>github:NixOS/nixpkgs/fa793b06f56896b7d1909e4b69977c7bf842b2f0<span style=color:#f1fa8c>&#39; (2023-07-20)
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>warning: Git tree &#39;</span>/home/user/git/infrastructure<span style=color:#f1fa8c>&#39; is dirty
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>warning: Git tree &#39;</span>/home/user/git/infrastructure<span style=color:#f1fa8c>&#39; is dirty
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>warning: Git tree &#39;</span>/home/user/git/infrastructure<span style=color:#f1fa8c>&#39; is dirty
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>warning: Git tree &#39;</span>/home/user/git/infrastructure&#39; is dirty
</span></span><span style=display:flex><span>Commit message:
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>master 204c4ba<span style=color:#ff79c6>]</span> .
</span></span><span style=display:flex><span> <span style=color:#bd93f9>1</span> file changed, <span style=color:#bd93f9>3</span> insertions<span style=color:#ff79c6>(</span>+<span style=color:#ff79c6>)</span>, <span style=color:#bd93f9>3</span> deletions<span style=color:#ff79c6>(</span>-<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>Enumerating objects: 5, <span style=color:#ff79c6>done</span>.
</span></span><span style=display:flex><span>Counting objects: 100% <span style=color:#ff79c6>(</span>5/5<span style=color:#ff79c6>)</span>, <span style=color:#ff79c6>done</span>.
</span></span><span style=display:flex><span>Delta compression using up to <span style=color:#bd93f9>12</span> threads
</span></span><span style=display:flex><span>Compressing objects: 100% <span style=color:#ff79c6>(</span>3/3<span style=color:#ff79c6>)</span>, <span style=color:#ff79c6>done</span>.
</span></span><span style=display:flex><span>Writing objects: 100% <span style=color:#ff79c6>(</span>3/3<span style=color:#ff79c6>)</span>, <span style=color:#bd93f9>368</span> bytes | 368.00 KiB/s, <span style=color:#ff79c6>done</span>.
</span></span><span style=display:flex><span>Total <span style=color:#bd93f9>3</span> <span style=color:#ff79c6>(</span>delta 2<span style=color:#ff79c6>)</span>, reused <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>(</span>delta 0<span style=color:#ff79c6>)</span>, pack-reused <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span>remote: Resolving deltas: 100% <span style=color:#ff79c6>(</span>2/2<span style=color:#ff79c6>)</span>, completed with <span style=color:#bd93f9>2</span> <span style=color:#8be9fd;font-style:italic>local</span> objects.
</span></span><span style=display:flex><span>To github...
</span></span><span style=display:flex><span>   4733c2c..204c4ba  master -&gt; master
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>INFO <span style=color:#ff79c6>]</span> pulling repo on remote hosts
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>INFO <span style=color:#ff79c6>]</span> Using flake: git+file:///home/user/git/infrastructure
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>INFO <span style=color:#ff79c6>]</span> Enumerating nodes...
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>INFO <span style=color:#ff79c6>]</span> Selected all <span style=color:#bd93f9>2</span> nodes.
</span></span><span style=display:flex><span>  host0 |
</span></span><span style=display:flex><span>  host1 |
</span></span><span style=display:flex><span>  host1 | From github...
</span></span><span style=display:flex><span>  host1 |    4733c2c..204c4ba  master     -&gt; origin/master
</span></span><span style=display:flex><span>  host0 | From github...
</span></span><span style=display:flex><span>  host0 |    4733c2c..204c4ba  master     -&gt; origin/master
</span></span><span style=display:flex><span>  host1 | 4733c2c -&gt; 204c4ba
</span></span><span style=display:flex><span>  host1 | Succeeded
</span></span><span style=display:flex><span>  host0 | 4733c2c -&gt; 204c4ba
</span></span><span style=display:flex><span>  host0 | Succeeded
</span></span><span style=display:flex><span>        | All <span style=color:#ff79c6>done</span>!
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>INFO <span style=color:#ff79c6>]</span> updating nix channel on remote hosts
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>INFO <span style=color:#ff79c6>]</span> Using flake: git+file:///home/user/git/infrastructure
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>INFO <span style=color:#ff79c6>]</span> Enumerating nodes...
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>INFO <span style=color:#ff79c6>]</span> Selected all <span style=color:#bd93f9>2</span> nodes.
</span></span><span style=display:flex><span>  host1 |
</span></span><span style=display:flex><span>  host0 |
</span></span><span style=display:flex><span>  host0 | unpacking channels...
</span></span><span style=display:flex><span>  host1 | unpacking channels...
</span></span><span style=display:flex><span>  host0 | Succeeded
</span></span><span style=display:flex><span>  host1 | Succeeded
</span></span><span style=display:flex><span>        | All <span style=color:#ff79c6>done</span>!
</span></span></code></pre></div><h2 id=diy-secret-management>DIY Secret Management<a hidden class=anchor aria-hidden=true href=#diy-secret-management>#</a></h2><p>Next let&rsquo;s take a quick look into how to manage secrets. With <code>colmena</code> a
<code>keyComand</code> can be defined, so we can basically build our secret management with
whatever tooling we want. For this little example, lets just use <code>pass</code> (I won&rsquo;t
go into detail here, how to set it up, there are enough posts on that on the
internet).</p><p>As a quick recap, this is how our file structure currently looks like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff79c6>[</span>user@host:~/git/infrastructure<span style=color:#ff79c6>]</span> tree -CL <span style=color:#bd93f9>2</span>
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>├── flake.nix           <span style=color:#6272a4># our flake file containing information about all hosts and their NixOS configs</span>
</span></span><span style=display:flex><span>├── flake.lock          <span style=color:#6272a4># the flake lock file (autogenerated)</span>
</span></span><span style=display:flex><span>├── shell.nix           <span style=color:#6272a4># our development shell</span>
</span></span><span style=display:flex><span>├── hosts               <span style=color:#6272a4># contains hosts configuration.nix files</span>
</span></span><span style=display:flex><span>│   ├── host0
</span></span><span style=display:flex><span>│   ├── host1
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>│   └── hostN
</span></span><span style=display:flex><span>├── modules             <span style=color:#6272a4># modular configuration bits and pieces</span>
</span></span><span style=display:flex><span>│   ├── baseUtils
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>│   └── zfs
</span></span><span style=display:flex><span>├── pkgs                <span style=color:#6272a4># packages that aren&#39;t part of nixpkgs</span>
</span></span><span style=display:flex><span>├── services            <span style=color:#6272a4># services that are hosted on the hosts</span>
</span></span><span style=display:flex><span>│   ├── host2
</span></span><span style=display:flex><span>│   │   └── nextloud
</span></span><span style=display:flex><span>│   └── host3
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>│       └── navidrome
</span></span><span style=display:flex><span>├── users               <span style=color:#6272a4># user configurations</span>
</span></span><span style=display:flex><span>└── vpn                 <span style=color:#6272a4># vpn configurations</span>
</span></span></code></pre></div><p>First we&rsquo;ll use <code>pass</code> to create a secret, in this case we&rsquo;ll use the following and
incredibly misterious string:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>CuKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKgguKjgOKjiOKjkuKjpOKjpOKgpOKgpOKipOKjgOKjgOKggOKggOKggOKggOKggOKggOKggOKhgOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggArioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioITioKDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioqDioaDioIDioIDioZTio7/io7/io7/io7/io7/io7/io7/io6bio4TioIjioJHioJLioIDioILioIDioIDioIDioIDioIjioJLioJLioIrioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIAK4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qGA4qCA4qGF4qC54qGE4qKA4qKk4qG84qO54qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qGm4qC04qO24qCy4qCA4qCA4qCA4qKA4qGk4qGE4qCA4qCS4qCA4qCC4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCACuKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKgsOKgguKgkeKgkuKgkuKgk+Kgg+KgmOKivuKjv+KjvuKhh+KggOKggOKgieKggeKgiOKgieKiu+Kjv+Khh+KgoOKghOKgpOKjgOKggOKggOKggOKgu+KiheKjgOKjiOKjkuKggOKggOKggOKggOKggOKggOKggOKgsuKhhOKggOKggOKggArioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDiobDioIPioqDioLTioKbioKbioqbio5jiorvio7/io7fio6bio6TioKDio4Tio4DioYDiorjio7/io6fioYDioIDioLjio7vioYfioIDioKDio6bioYDioInioJnioqTio4Dio4DioIDioIDioIDioIDioIDioIDioIPioIDioIDioIAK4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qGA4qKA4qCA4qCA4qCA4qCA4qCA4qGg4qCS4qGH4qCC4qKy4qCS4qCS4qO84qOu4qO/4qCJ4qCJ4qCZ4qCA4qC74qCb4qCb4qK64qGP4qCs4qGt4qO14qOA4qCI4qCB4qCA4qCA4qG/4qOf4qOG4qCA4qCA4qCA4qCA4qCj4qOE4qGA4qCA4qCi4qGA4qCA4qCA4qCA4qCACuKggOKggOKggOKggOKhgOKggOKggOKggOKggOKggOKggOKgnuKjgOKgouKggOKggOKggOKggOKikeKhpOKghOKgoOKgrOKij+KjieKjueKjv+Khl+KggOKggOKhv+KhkuKggOKggOKggOKiv+Khl+KgkuKgkuKiuuKgiuKhteKggOKggOKggOKhv+KjreKgj+KhhOKggOKggeKigOKggOKggOKgk+KipOKhgOKgiOKhhuKggOKhgOKggArioIDioIDioITioIDioIDiornioIDioIDioIDioIDiooDiobDioJvioLfioYDioIDioIDioIDiopfioJLioJLioJLioJrioILioKTioLzioqTio6fioYjioJnioK/ioL3ioLLioIDioZbioLvioIDiooDio4nio7nio4nio6fioIDioIDioIDioInio7XioobioJHioobioIDiooDioajioIbio4Dio4DioIDioInioIDioIDioIDioIAK4qCA4qCA4qCA4qCA4qCA4qCJ4qCI4qCB4qCi4qKE4qCP4qCA4qCS4qCS4qGH4qCA4qCA4qC04qGI4qCR4qOO4qOA4qOB4qOA4qG04qCK4qKB4qGf4qC34qKE4qGA4qCA4qCk4qKj4qOk4qGQ4qCS4qCS4qCm4qK84qCW4qCL4qGA4qCA4qCA4qO24qOf4qOK4qOi4qGI4qCS4qOB4qCA4qK44qO/4qG/4qCB4qCA4qCA4qCA4qCA4qCACuKggOKggOKggOKggOKggOKggOKggOKggOKjgOKjuOKggOKggOKggOKggOKgh+KggOKggOKigOKhqOKghuKgiOKgieKgkuKgmuKioOKjpOKiv+Kjh+KggOKggOKggOKggOKigOKgnuKjv+Kjv+Kjn+KjpOKjluKjiuKgoOKgnuKgg+KggOKggOKiu+KgpOKhp+KgpOKio+KjiuKggeKggeKhgOKgieKjgOKghOKggOKggOKggOKggOKggArioIDioIDioIDioIDioaDioIDioIjio4/io7nioKTio4bioaTioIDioIDioIDioIDioIDioIjiooDioZTio6vioK3iornio7/ioq/iob/io77io7/io6TioYTio4DioLTioIvioqDio7/io7/io7/io7fio6bio63io63io5bio7rio7bio6TioYTioJLioJPiorrioIjioKDio4DioqDioJ/ioIDioIvioIHioIDioJLioILioIDioIAK4qCA4qCA4qCA4qKw4qCA4qCA4qCg4qGI4qOs4qK14qCf4qOY4qCy4qC24qCA4qCA4qCA4qO04qCf4qOJ4qO04qO+4qO/4qO/4qO44qK34qK44qCB4qC54qGf4qCD4qCA4qOg4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO34qGA4qKA4qG/4qOI4qCy4qOk4qCP4qG04qCm4qGA4qGW4qCS4qCy4qCE4qCA4qCACuKggOKggOKggOKgoOKgpOKgguKgiuKggeKgiOKgieKjjuKjiOKgteKihOKggOKggOKggOKjuOKjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+KjgOKjh+Kjn+Kjk+KjtuKjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjh+KggOKioOKgkeKgh+Kgj+KitOKhseKgkuKjh+KgmOKihOKggOKggOKggOKggArioIDioILioIDio6DioILioIDioIDioIDioIDioLjioYDiorDioYDiorjioIDioIDioIDio7/io7/io7/io7/io7/io7/io7/io7/io7/io7/ioJ/io7/io5Liobrior/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/ioIbioIDioKfioIDioIDioIDioInioJHioJvioIDioqfioIDioIDioIDioIAK4qKA4qCk4qC+4qC34qOA4qOA4qCH4qG04qOG4qCA4qCz4qGA4qCA4qK54qCA4qCA4qCA4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qOb4qOA4qG/4qC24qCt4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qOm4qCA4qCA4qCA4qKA4qCA4qOf4qCv4qKm4qGA4qCI4qCT4qKk4qGA4qCACuKhjuKgk+KgkuKgguKgpOKhnuKioOKgk+KguuKhgOKggOKip+KggOKhmOKggOKggOKgsOKjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+KhvuKjjeKhr+KgreKjveKjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+KjpuKjhOKggOKgiOKjhuKgs+KirOKgkuKgmuKgkuKhhOKggOKggOKggArioJjioKLioYDioJLiopLioIHioY7iooDiobDioIPioKTioYjioaTior/ioIDioIDioIDio7/io7/io7/io7/io7/io7/io7/io7/io7/ioq3io7/io5/io5Pio7/io7/io7/io7/io7/io4/ioKnioInioInioLvio7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7fio6bio5jioIjioIDioofio6nio4nio7nioILioIDioIAK4qKA4qCQ4qKN4qCB4qCY4qKw4qKJ4qG94qKA4qGA4qKN4qKz4qC44qG34qCA4qCA4qCA4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qOb4qO/4qOS4qO+4qO/4qO/4qO/4qO/4qO/4qC34qGA4qCC4qCA4qCA4qC54qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qOm4qCI4qKJ4qKA4qOW4qCB4qCA4qGG4qCACuKgiOKgseKggOKggOKggOKgm+KgieKhtOKgm+KgmOKgouKhieKggOKggOKggOKggOKggOKjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Khv+Kjv+KgreKiveKjv+Kjv+Kjv+Kjv+Kjv+Kjv+KjreKjpOKhhOKggOKggOKiu+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+KggOKjgOKglOKii+KhpOKhhOKgkOKgggrioIDioIDioIDioIDioIDioaDioJrioIDioIDioKnioY3ioJPio4TioIDioIDioIDiorjio7/io7/io7/io7/ioL/ioL/ioJvio5vio7viob/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7bio7bio77io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/ioIDioIDiooDioafioIDioIjioqLioIAK4qCA4qCA4qKw4qCA4qCA4qKP4qCJ4qCJ4qCJ4qCA4qCJ4qCx4qG84qCA4qCA4qCA4qCw4qO/4qO/4qOv4qOk4qGO4qCt4qCk4qCc4qO/4qO/4qO/4qOT4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qG/4qC/4qKl4qCA4qCw4qO/4qOE4qOA4qCA4qCA4qCACuKggOKggOKguOKggOKggOKhgOKgieKhgOKggOKggOKhsOKgieKggOKggOKggOKggOKggOKguOKjv+Kjv+Kjv+Khg+KgkuKjkuKjveKjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kju+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Khh+KggOKgieKgieKgoeKghOKggOKggOKgoOKgnOKggOKggOKgh+KggOKggOKggOKggOKggArioIDioIDioIDioIDiorBORVZFUiBHT05OQSBHSVZFIFlPVSBVUOKjv+Kjv+Kjv+Kjv+Kjv05FVkVSIEdPTk5BIExFVCBZT1UgRE9XTuKggOKggOKggOKggOKggArioIDioIDioIDioIDioLjioIDioIjiorPioIDioJTioInioIDio7jioIDioIDioIDioIDioIDioJnioqLioIDioIzio73io7/io7/iob/ioL/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/ioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIAK4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCK4qCA4qCA4qCE4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qOA4qCM4qCA4qKg4qK/4qO/4qO/4qGH4qCA4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qGG4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCACgo=
</span></span></code></pre></div><p>Add it to your password store using something along the lines of:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pass edit colmena-test-secret
</span></span></code></pre></div><p>Next create a module which deploys this secret, e.g.
<code>./modules/colmena-test-secret/default.nix</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{
</span></span><span style=display:flex><span>  deployment<span style=color:#ff79c6>.</span>keys<span style=color:#ff79c6>.</span><span style=color:#f1fa8c>&#34;colmena-test-secret&#34;</span> <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>    keyCommand <span style=color:#ff79c6>=</span> [ <span style=color:#f1fa8c>&#34;pass&#34;</span> <span style=color:#f1fa8c>&#34;colmena-test-secret&#34;</span> ];
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Then add it to the configuration of on of our hosts <code>configuration.nix</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{ config<span style=color:#ff79c6>,</span> pkgs<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>...</span> }:
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  imports <span style=color:#ff79c6>=</span>
</span></span><span style=display:flex><span>    [
</span></span><span style=display:flex><span>      <span style=color:#f1fa8c>./base.nix</span>
</span></span><span style=display:flex><span>      <span style=color:#f1fa8c>../../modules/colmena-test-secrets</span>
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And finally run <code>deploy</code> from the development shell<sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup>. After finishing, check if the
secret has been properly put on the host, or if our little deployment tool has
let us down:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo cat /run/keys/colmena-testing-secret | base64 -d
</span></span><span style=display:flex><span>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠂⣀⣈⣒⣤⣤⠤⠤⢤⣀⣀⠀⠀⠀⠀⠀⠀⠀⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
</span></span><span style=display:flex><span>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠄⠠⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⡠⠀⠀⡔⣿⣿⣿⣿⣿⣿⣿⣦⣄⠈⠑⠒⠀⠂⠀⠀⠀⠀⠈⠒⠒⠊⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
</span></span><span style=display:flex><span>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡀⠀⡅⠹⡄⢀⢤⡼⣹⣿⣿⣿⣿⣿⣿⣿⣿⣿⡦⠴⣶⠲⠀⠀⠀⢀⡤⡄⠀⠒⠀⠂⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
</span></span><span style=display:flex><span>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠰⠂⠑⠒⠒⠓⠃⠘⢾⣿⣾⡇⠀⠀⠉⠁⠈⠉⢻⣿⡇⠠⠄⠤⣀⠀⠀⠀⠻⢅⣀⣈⣒⠀⠀⠀⠀⠀⠀⠀⠲⡄⠀⠀⠀
</span></span><span style=display:flex><span>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡰⠃⢠⠴⠦⠦⢦⣘⢻⣿⣷⣦⣤⠠⣄⣀⡀⢸⣿⣧⡀⠀⠸⣻⡇⠀⠠⣦⡀⠉⠙⢤⣀⣀⠀⠀⠀⠀⠀⠀⠃⠀⠀⠀
</span></span><span style=display:flex><span>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡀⢀⠀⠀⠀⠀⠀⡠⠒⡇⠂⢲⠒⠒⣼⣮⣿⠉⠉⠙⠀⠻⠛⠛⢺⡏⠬⡭⣵⣀⠈⠁⠀⠀⡿⣟⣆⠀⠀⠀⠀⠣⣄⡀⠀⠢⡀⠀⠀⠀⠀
</span></span><span style=display:flex><span>⠀⠀⠀⠀⡀⠀⠀⠀⠀⠀⠀⠞⣀⠢⠀⠀⠀⠀⢑⡤⠄⠠⠬⢏⣉⣹⣿⡗⠀⠀⡿⡒⠀⠀⠀⢿⡗⠒⠒⢺⠊⡵⠀⠀⠀⡿⣭⠏⡄⠀⠁⢀⠀⠀⠓⢤⡀⠈⡆⠀⡀⠀
</span></span><span style=display:flex><span>⠀⠀⠄⠀⠀⢹⠀⠀⠀⠀⢀⡰⠛⠷⡀⠀⠀⠀⢗⠒⠒⠒⠚⠂⠤⠼⢤⣧⡈⠙⠯⠽⠲⠀⡖⠻⠀⢀⣉⣹⣉⣧⠀⠀⠀⠉⣵⢆⠑⢆⠀⢀⡨⠆⣀⣀⠀⠉⠀⠀⠀⠀
</span></span><span style=display:flex><span>⠀⠀⠀⠀⠀⠉⠈⠁⠢⢄⠏⠀⠒⠒⡇⠀⠀⠴⡈⠑⣎⣀⣁⣀⡴⠊⢁⡟⠷⢄⡀⠀⠤⢣⣤⡐⠒⠒⠦⢼⠖⠋⡀⠀⠀⣶⣟⣊⣢⡈⠒⣁⠀⢸⣿⡿⠁⠀⠀⠀⠀⠀
</span></span><span style=display:flex><span>⠀⠀⠀⠀⠀⠀⠀⠀⣀⣸⠀⠀⠀⠀⠇⠀⠀⢀⡨⠆⠈⠉⠒⠚⢠⣤⢿⣇⠀⠀⠀⠀⢀⠞⣿⣿⣟⣤⣖⣊⠠⠞⠃⠀⠀⢻⠤⡧⠤⢣⣊⠁⠁⡀⠉⣀⠄⠀⠀⠀⠀⠀
</span></span><span style=display:flex><span>⠀⠀⠀⠀⡠⠀⠈⣏⣹⠤⣆⡤⠀⠀⠀⠀⠀⠈⢀⡔⣫⠭⢹⣿⢯⡿⣾⣿⣤⡄⣀⠴⠋⢠⣿⣿⣿⣷⣦⣭⣭⣖⣺⣶⣤⡄⠒⠓⢺⠈⠠⣀⢠⠟⠀⠋⠁⠀⠒⠂⠀⠀
</span></span><span style=display:flex><span>⠀⠀⠀⢰⠀⠀⠠⡈⣬⢵⠟⣘⠲⠶⠀⠀⠀⣴⠟⣉⣴⣾⣿⣿⣸⢷⢸⠁⠹⡟⠃⠀⣠⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣷⡀⢀⡿⣈⠲⣤⠏⡴⠦⡀⡖⠒⠲⠄⠀⠀
</span></span><span style=display:flex><span>⠀⠀⠀⠠⠤⠂⠊⠁⠈⠉⣎⣈⠵⢄⠀⠀⠀⣸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣀⣇⣟⣓⣶⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣇⠀⢠⠑⠇⠏⢴⡱⠒⣇⠘⢄⠀⠀⠀⠀
</span></span><span style=display:flex><span>⠀⠂⠀⣠⠂⠀⠀⠀⠀⠸⡀⢰⡀⢸⠀⠀⠀⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠟⣿⣒⡺⢿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠆⠀⠧⠀⠀⠀⠉⠑⠛⠀⢧⠀⠀⠀⠀
</span></span><span style=display:flex><span>⢀⠤⠾⠷⣀⣀⠇⡴⣆⠀⠳⡀⠀⢹⠀⠀⠀⣿⣿⣿⣿⣿⣿⣿⣿⣿⣛⣀⡿⠶⠭⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣦⠀⠀⠀⢀⠀⣟⠯⢦⡀⠈⠓⢤⡀⠀
</span></span><span style=display:flex><span>⡎⠓⠒⠂⠤⡞⢠⠓⠺⡀⠀⢧⠀⡘⠀⠀⠰⣿⣿⣿⣿⣿⣿⣿⣿⣿⡾⣍⡯⠭⣽⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣦⣄⠀⠈⣆⠳⢬⠒⠚⠒⡄⠀⠀⠀
</span></span><span style=display:flex><span>⠘⠢⡀⠒⢒⠁⡎⢀⡰⠃⠤⡈⡤⢿⠀⠀⠀⣿⣿⣿⣿⣿⣿⣿⣿⣿⢭⣿⣟⣓⣿⣿⣿⣿⣿⣏⠩⠉⠉⠻⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣷⣦⣘⠈⠀⢇⣩⣉⣹⠂⠀⠀
</span></span><span style=display:flex><span>⢀⠐⢍⠁⠘⢰⢉⡽⢀⡀⢍⢳⠸⡷⠀⠀⠀⣿⣿⣿⣿⣿⣿⣿⣿⣿⣛⣿⣒⣾⣿⣿⣿⣿⣿⠷⡀⠂⠀⠀⠹⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣦⠈⢉⢀⣖⠁⠀⡆⠀
</span></span><span style=display:flex><span>⠈⠱⠀⠀⠀⠛⠉⡴⠛⠘⠢⡉⠀⠀⠀⠀⠀⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⣿⠭⢽⣿⣿⣿⣿⣿⣿⣭⣤⡄⠀⠀⢻⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠀⣀⠔⢋⡤⡄⠐⠂
</span></span><span style=display:flex><span>⠀⠀⠀⠀⠀⡠⠚⠀⠀⠩⡍⠓⣄⠀⠀⠀⢸⣿⣿⣿⣿⠿⠿⠛⣛⣻⡿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣶⣶⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠀⠀⢀⡧⠀⠈⢢⠀
</span></span><span style=display:flex><span>⠀⠀⢰⠀⠀⢏⠉⠉⠉⠀⠉⠱⡼⠀⠀⠀⠰⣿⣿⣯⣤⡎⠭⠤⠜⣿⣿⣿⣓⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⠿⢥⠀⠰⣿⣄⣀⠀⠀⠀
</span></span><span style=display:flex><span>⠀⠀⠸⠀⠀⡀⠉⡀⠀⠀⡰⠉⠀⠀⠀⠀⠀⠸⣿⣿⣿⡃⠒⣒⣽⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣻⣿⣿⣿⣿⣿⣿⡇⠀⠉⠉⠡⠄⠀⠀⠠⠜⠀⠀⠇⠀⠀⠀⠀⠀
</span></span><span style=display:flex><span>⠀⠀⠀⠀⢰NEVER GONNA GIVE YOU UP⣿⣿⣿⣿⣿NEVER GONNA LET YOU DOWN⠀⠀⠀⠀⠀
</span></span><span style=display:flex><span>⠀⠀⠀⠀⠸⠀⠈⢳⠀⠔⠉⠀⣸⠀⠀⠀⠀⠀⠙⢢⠀⠌⣽⣿⣿⡿⠿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
</span></span><span style=display:flex><span>⠀⠀⠀⠀⠀⠀⠀⠊⠀⠀⠄⠀⠀⠀⠀⠀⠀⠀⣀⠌⠀⢠⢿⣿⣿⡇⠀⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
</span></span></code></pre></div><p>I&rsquo;d say that looks about right.</p><p>Colmena also supports other options than <code>keyCommand</code>, such as <code>string</code> or
<code>keyFile</code>, but i kind of like the idea of not having all my secrets lying around
unencrypted. Also there are a bunch of other options on how to configure secrets
documented <a href=https://colmena.cli.rs/unstable/reference/deployment.html>here</a>.</p><h2 id=setting-some-boundaries>Setting some Boundaries<a hidden class=anchor aria-hidden=true href=#setting-some-boundaries>#</a></h2><p>While my relationship with <code>colmena</code> can so far be described as incredibly time
saving and quite a bit of fun, there were a couple of things I ran into that
should be considered. When going down the path of automated deployment you can
actually run into a bit of trouble in paradise: the more time you spend with
<code>colmena</code>, the more it will over time - and quite sneakily - steal away your
storage space.</p><p>There are two main issues I ran into kind of frequently with <code>colmena</code>, that I
wasn&rsquo;t used to when (not regularly) updating my hosts manually:</p><ul><li>firstly, the size of the nix store simply explodes</li><li>secondly, the amount of boot configurations gets so big, the <code>/boot</code> partition
runs out of space</li></ul><p>The size of the nix store can be easily constrained by creating a module for the
nix garbage collector (<code>./modules/nix-settings/default.nix</code>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{ config<span style=color:#ff79c6>,</span> lib<span style=color:#ff79c6>,</span> pkgs<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>...</span> }:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  nix <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>    gc <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>      automatic <span style=color:#ff79c6>=</span> true;
</span></span><span style=display:flex><span>      dates <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;weekly&#34;</span>;
</span></span><span style=display:flex><span>      options <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;--delete-older-than 14d&#34;</span>;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    extraOptions <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      min-free = </span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>toString</span> (<span style=color:#bd93f9>100</span> <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>1024</span> <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>1024</span>)<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      max-free = </span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>toString</span> (<span style=color:#bd93f9>1024</span> <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>1024</span> <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>1024</span>)<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    &#39;&#39;</span>;
</span></span><span style=display:flex><span>    autoOptimiseStore <span style=color:#ff79c6>=</span> true; <span style=color:#6272a4># &lt;- this option will hardlink identical files</span>
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Also we can limit the size of the systemd journal, by creating
<code>./modules/limit-journal-size/default.nix</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{ config<span style=color:#ff79c6>,</span> lib<span style=color:#ff79c6>,</span> pkgs<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>...</span> }:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  services<span style=color:#ff79c6>.</span>journald<span style=color:#ff79c6>.</span>extraConfig <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    SystemMaxUse=100M
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    MaxFileSec=7day
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  &#39;&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And then referencing them inside our <code>./modules/colmena/default.nix</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-nix data-lang=nix><span style=display:flex><span>{
</span></span><span style=display:flex><span>
</span></span><span style=display:flex;background-color:#3d3f4a><span>  imports <span style=color:#ff79c6>=</span> [
</span></span><span style=display:flex;background-color:#3d3f4a><span>    <span style=color:#f1fa8c>../nix-settings</span>
</span></span><span style=display:flex;background-color:#3d3f4a><span>    <span style=color:#f1fa8c>../limit-journal-size</span>
</span></span><span style=display:flex;background-color:#3d3f4a><span>  ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4># https://github.com/NixOS/nix/issues/2330#issuecomment-451650296</span>
</span></span><span style=display:flex><span>  nix<span style=color:#ff79c6>.</span>settings<span style=color:#ff79c6>.</span>trusted-users <span style=color:#ff79c6>=</span> [ <span style=color:#f1fa8c>&#34;root&#34;</span> <span style=color:#f1fa8c>&#34;@wheel&#34;</span> ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  users<span style=color:#ff79c6>.</span>users<span style=color:#ff79c6>.</span>root<span style=color:#ff79c6>.</span>openssh<span style=color:#ff79c6>.</span>authorizedKeys<span style=color:#ff79c6>.</span>keys <span style=color:#ff79c6>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;ssh-ed25519 ...&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;ssh-rsa     ...&#34;</span>
</span></span><span style=display:flex><span>  ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The second problem can be solved by creating a module, which constrains the max
amount of available boot configurations. Create
<code>./modules/bootConfigurationLimit/grub/default.nix</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{ config<span style=color:#ff79c6>,</span> pkgs<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>...</span> }:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  boot<span style=color:#ff79c6>.</span>loader<span style=color:#ff79c6>.</span>grub<span style=color:#ff79c6>.</span>configurationLimit <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>16</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Respectively <code>./modules/bootConfigurationLimit/systemdboot/default.nix</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{ config<span style=color:#ff79c6>,</span> pkgs<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>...</span> }:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  boot<span style=color:#ff79c6>.</span>loader<span style=color:#ff79c6>.</span>systemd-boot<span style=color:#ff79c6>.</span>configurationLimit <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>16</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And then import whichever applies to your hosts in their
<code>./hosts/&lt;hostname>/default.nix</code> files.</p><p>After rebuilding and deploying you should be somewhat save from <code>colmenas</code> nature
of taking up your personal space.</p><p>At this point in time you should be able to manage and rollout your
infrastructure fairly easily from a single flake. From here on setting up new
services over multiple hosts gets to be way more fun.</p><p>There is maybe one last thing I should mention: sometimes <code>colmena</code> will fail to
deploy properly on some of your hosts. This actually happens rather frequently,
however most of the times this happens, a simple rerun of the deployment step
will sucessfully activate the new configuration and sometimes, depending on what
you do, it helps turning things off and on again.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>there is an option called <code>deployment.keys</code>,
but that is for secret management&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>Note, using the <code>-v</code> flag returns the
output of executed commands, whereas not using it simply returns success or
failure with colmena.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>This is of course not
strictly necessary, however I feel kind of comfortable to know there is always a
description of what is running on a node, which you can use to look up what is
going on&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p>When playing around with
containers I noticed they apparently followed the channels, so it was possible
to deploy a 22.05 container, whereas a container created on the remote host
would still be on 21.11. Not sure how much of the <code>sync</code> function still applies,
but it works for me (TM)&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5><p>When using colmena, I&rsquo;ve
found, that inputing the password during an <code>apply</code> operation does not really seem
to work nicely, so as a workaround I&rsquo;ve created an empty entry in my password
store called <code>dummy</code>, which I can use to unlock it before deploying by simply
executing <code>pass dummy</code> before the <code>deploy</code> command.&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://oblivious.observer/tags/nixos/>NixOS</a></li><li><a href=https://oblivious.observer/tags/flakes/>flakes</a></li><li><a href=https://oblivious.observer/tags/colmena/>colmena</a></li><li><a href=https://oblivious.observer/tags/deployment/>Deployment</a></li></ul></footer><script src=https://utteranc.es/client.js repo=observer/observer.github.io issue-term=url label=💬 theme=photon-dark crossorigin=anonymous async></script></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>