<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Tinc different! - Part I: The Fellowship of the Ping | oblivious observer</title><meta name=keywords content="NixOS,tinc"><meta name=description content="This is a post about tinc - a nifty little Mesh VPN service. It is also the first part of a little series of posts related to tinc and NixOS. In this first part I&rsquo;ll just write a bit about how to set up tinc, then in the second part I&rsquo;ll take a closer look into how writing a NixOS module can managing tinc networks easier. And finally in the third part I&rsquo;ll present a rewrite of the module with a bunch more features."><meta name=author content="oblivious observer"><link rel=canonical href=https://oblivious.observer/posts/tincdifferent-i-tinc-nixos/><link crossorigin=anonymous href=/assets/css/stylesheet.7140587df96a2b1a49eb723fa7063dc0c641a6cb638f3140e8d3beb4deae4f5c.css integrity="sha256-cUBYfflqKxpJ63I/pwY9wMZBpstjjzFA6NO+tN6uT1w=" rel="preload stylesheet" as=style><link rel=icon href=https://oblivious.observer/observer-16x16.png><link rel=icon type=image/png sizes=16x16 href=https://oblivious.observer/observer-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://oblivious.observer/observer-32x32.png><link rel=apple-touch-icon href=https://oblivious.observer/observer-512x512.png><link rel=mask-icon href=https://oblivious.observer/observer-512x512.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://oblivious.observer/css/syntax.css><meta property="og:title" content="Tinc different! - Part I: The Fellowship of the Ping"><meta property="og:description" content="This is a post about tinc - a nifty little Mesh VPN service. It is also the first part of a little series of posts related to tinc and NixOS. In this first part I&rsquo;ll just write a bit about how to set up tinc, then in the second part I&rsquo;ll take a closer look into how writing a NixOS module can managing tinc networks easier. And finally in the third part I&rsquo;ll present a rewrite of the module with a bunch more features."><meta property="og:type" content="article"><meta property="og:url" content="https://oblivious.observer/posts/tincdifferent-i-tinc-nixos/"><meta property="og:image" content="https://oblivious.observer/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-04-03T00:00:00+02:00"><meta property="article:modified_time" content="2021-04-03T00:00:00+02:00"><meta property="og:site_name" content="oblivious.observer"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://oblivious.observer/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Tinc different! - Part I: The Fellowship of the Ping"><meta name=twitter:description content="This is a post about tinc - a nifty little Mesh VPN service. It is also the first part of a little series of posts related to tinc and NixOS. In this first part I&rsquo;ll just write a bit about how to set up tinc, then in the second part I&rsquo;ll take a closer look into how writing a NixOS module can managing tinc networks easier. And finally in the third part I&rsquo;ll present a rewrite of the module with a bunch more features."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://oblivious.observer/posts/"},{"@type":"ListItem","position":3,"name":"Tinc different! - Part I: The Fellowship of the Ping","item":"https://oblivious.observer/posts/tincdifferent-i-tinc-nixos/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Tinc different! - Part I: The Fellowship of the Ping","name":"Tinc different! - Part I: The Fellowship of the Ping","description":"This is a post about tinc - a nifty little Mesh VPN service. It is also the first part of a little series of posts related to tinc and NixOS. In this first part I\u0026rsquo;ll just write a bit about how to set up tinc, then in the second part I\u0026rsquo;ll take a closer look into how writing a NixOS module can managing tinc networks easier. And finally in the third part I\u0026rsquo;ll present a rewrite of the module with a bunch more features.","keywords":["NixOS","tinc"],"articleBody":"This is a post about tinc - a nifty little Mesh VPN service. It is also the first part of a little series of posts related to tinc and NixOS. In this first part I’ll just write a bit about how to set up tinc, then in the second part I’ll take a closer look into how writing a NixOS module can managing tinc networks easier. And finally in the third part I’ll present a rewrite of the module with a bunch more features. For now, lets take a look at tinc..\nTINC - a low maintainance VPN tinc is one of my all-time favourite little tools, a nice little VPN daemon that has a bunch of really interesting properties such as NAT traversal, automatic use of TCP and UDP, a per node option of publishing of subnets and of course the fact that it is a mesh VPN, so nodes can go down without breaking everything. Also while most people apparently haven’t heard about tinc it has been around for ages.\nIn order to create a minimal tinc network you need to set up a network interface, create a tinc.conf file which contains information on the name of the node, the network device to use as well as the device type (tun or tap). There are a bunch of more or less optional files involved in configuring tinc : For example using two little scripts called tinc-up and tinc-down, the aforementioned network device that tinc is using can be created or removed on demand using whatever tools you prefer (e.g. iproute2 or ifconfig). Next a public-private key-pair (RSA and/or ECDSA) has to be generated. tinc provides an easy way to do so and generates a little node configuration, which only contains the public key(s) of the node. This config file can then filled with a bunch of configuration options such as the nodes IP address inside the mesh, it’s (optional) public IP address or subnets connected to a node that you want to make available to the rest of the mesh. Sounds good? Great, let’s look at the whole process in a bit more detail.\nSetting up a TINC Mesh on Linux Let’s set up a little example Mesh on a bunch of imaginary machines:\nnode0: with a public IP address, e.g. 10.10.10.1 node1: with a private IP address node2: with a private IP address and connected to the network 192.168.0.0/24, which should be made accessible to node0 and node1 First lets install tinc on all of our hosts using something like this:\nsudo apt install tinc Then the VPN network has to be set up on each of the nodes. tinc allows for more than one concurrent VPN connection, and keeps these VPN networks configured inside /etc/tinc/, so create an example VPN network on all of the nodes (note that I’m using node{0,1,2} to express that this line should be executed on all three nodes):\n[user@node{0,1,2}:/etc/tinc/example]$ sudo mkdir /etc/tinc/example Next create the configuration file for this little example VPN network inside /etc/tinc/example/tinc.conf:\n[user@node0:/etc/tinc/example]$ cat tinc.conf Name = node0 DeviceType = tun [user@node1:/etc/tinc/example]$ cat tinc.conf Name = node1 DeviceType = tun ConnectTo = node0 [user@node2:/etc/tinc/example]$ cat tinc.conf Name = node2 DeviceType = tun ConnectTo = node0 Note that inside the configuration file, we set up the network device type only, not the device name, this can be done however using the Interface option. Also we set the nodes up in such a way that node1 as well as node2 will initially try to connect to node0 using the ConnectTo option. Interestingly some of the options seem to be optional, e.g. the NixOS tinc module sets up the explicit network interface name using the Interface option, but does not seem to use the ConnectTo option.\nNext on all of the hosts the keypairs need to be configured. In order to set up a VPN using a RSA key of length 4096, execute the following command on the nodes:\n[user@node{0,1,2}:/etc/tinc/example]$ sudo tincd -n example -K4096 tinc will then create a private-public keypair and store the private key inside of the node configuration file in /etc/tinc/example/hosts/ on each of the nodes. Apart from the public key these files will be empty:\n[user@node0:/etc/tinc/example]$ cat hosts/node0 -----BEGIN RSA PUBLIC KEY----- ... -----END RSA PUBLIC KEY----- [user@node1:/etc/tinc/example]$ cat hosts/node1 -----BEGIN RSA PUBLIC KEY----- ... -----END RSA PUBLIC KEY----- [user@node2:/etc/tinc/example]$ cat hosts/node2 -----BEGIN RSA PUBLIC KEY----- ... -----END RSA PUBLIC KEY----- At this point it makes sense to think about stuff such as ports used by the VPN and the subnet to use for the nodes. Let’s use 10.0.0.0/24 to address our nodes and use the default tinc port 655. Additionally on node0 let’s add the nodes Public IP address and on node2 lets add the 192.168.0.0/24 subnet:\n[user@node0:/etc/tinc/example]$ cat hosts/node0 Address = 10.10.10.1 Subnet = 10.0.0.0 Port = 655 -----BEGIN RSA PUBLIC KEY----- ... -----END RSA PUBLIC KEY----- [user@node1:/etc/tinc/example]$ cat hosts/node1 Subnet = 10.0.0.1 Port = 655 -----BEGIN RSA PUBLIC KEY----- ... -----END RSA PUBLIC KEY----- [user@node2:/etc/tinc/example]$ cat hosts/node2 Subnet = 10.0.0.1 Subnet = 192.168.0.0/24 Port = 655 -----BEGIN RSA PUBLIC KEY----- ... -----END RSA PUBLIC KEY----- After setting up the nodes configuration files, they need to be shared, since in our little example only node0 has a publicly reachable IP address the easiest thing would be to upload the config of node1 and node2 to node0 and at the same time grab the config files of node0. Ideally of course the configuration files should be synchronized between all nodes, but this is not a requirement for tinc, the example VPN will be accessible without having the config of node1 on node2 and vice versa as well.\nAt this point the setup of the network interface as well as the routes is still missing. Remember these optional setup files I mentioned earlier? Lets create /etc/tinc/example/tinc-{up,down} on all of the nodes:\n[user@node0:/etc/tinc/example]$ cat tinc-up #!/bin/sh ip link set $INTERFACE up ip addr add 10.0.0.0/32 dev $INTERFACE ip route add 192.168.0.0/24 dev $INTERFACE [user@node0:/etc/tinc/example]$ cat tinc-down #!/bin/sh ip route del 192.168.0.0/24 dev $INTERFACE ip addr del 10.0.0.0/32 dev $INTERFACE ip link set $INTERFACE down [user@node2:/etc/tinc/example]$ cat tinc-up #!/bin/sh ip link set $INTERFACE up ip addr add 10.0.0.2/32 dev $INTERFACE [user@node2:/etc/tinc/example]$ cat tinc-down #!/bin/sh ip addr del 10.0.0.2/32 dev $INTERFACE ip link set $INTERFACE down Note that since the configuration on node1 and node0 is pretty much identical (apart from the ip address of course) I have omitted the tinc-{up,down} scripts from node1.\nThe content of these scripts is pretty much straightforward:\ntinc-up creates a new network interface (tinc uses the environment variable INTERFACE to store the interfaces name), then assigns the IP address of the node and optionally (node0 and node1) add a route to a subnet that’s shared by one of the other nodes (in this case node2). tinc-down removes the IP address and route from the nodes and takes down the interface. Both tinc-up and tinc-down are really only shell scripts, which are run before respectively after the tinc VPN is created so writing anything custom should be relatively straight forward.\nOne important part is to make sure the tinc-{up,down} scripts are executable:\n[user@node{0,1,2}:/etc/tinc/example]$ sudo chmod +x tinc-{up,down} At this point everything is set up and enabling and starting the example VPN is as simple as:\n[user@node{0,1,2}:/etc/tinc/example]$ sudo systemctl enable tinc@example [user@node{0,1,2}:/etc/tinc/example]$ sudo systemctl start tinc@example After starting the example network, all nodes should be accessible via their VPN IP addresses and the 192.168.0.0/24 subnet should be accessible from all nodes as well.\nSetting up a TINC Mesh on NixOS As with a lot of other things, when using tinc on NixOS everything works a bit different. Instead of setting everything up by hand there is a neat little tinc module.\nSidenote: Using a little alias, it is possible to search for NixOS options without using the options search on the NixOS website:\n$ alias nix-search-options='man configuration.nix | less -p ' $ nix-search-options services.tinc This will drop you inside of a less buffer looking like this, where you can navigate using n and N to jump to the next respectively previous match:\n... services.tinc.networks Defines the tinc networks which will be started. Each network invokes a different daemon. Type: attribute set of submodules Default: { } Declared by: services.tinc.networks..package The package to use for the tinc daemon's binary. Type: package Default: \"pkgs.tinc_pre\" Declared by: ... All in all there are a bunch of available options, but in order to get started you really only need the following two (that is from the tinc module specifically):\nservices.tinc.networks Defines the tinc networks which will be started. Each network invokes a different daemon. services.tinc.networks..hosts The name of the host in the network as well as the configuration for that host. This name should only contain alphanumerics and underscores. services.tinc.networks..name The name of the node which is used as an identifier when communicating with the remote nodes in the mesh. If null then the hostname of the system is used to derive a name (note that tinc may replace non- alphanumeric characters in hostnames by underscores). Apart from these configuration options we need to set up a bunch of other things, such as the networking interface, routes or ports on the firewall. This is similiar to what we did using the tinc-{up,down} scripts in the previous section using iproute2:\nThe interface tinc expects in NixOS is named tinc., so in this case tinc.example has to be created and set up, here is how this would look like for node0 from our little example:\n... networking.interfaces.\"tinc.example\".ipv4 = { addresses = [ { address = \"10.0.0.0\"; prefixLength = 24; } ]; routes = [ { address = \"192.168.0.0\"; prefixLength = 24; via = \"10.0.0.2\"; } ]; }; ... If the firewall is enabled on the nodes, the port used (e.g. 655) has to be opened as well:\n... networking.firewall.allowedTCPPorts = [ 655 ]; networking.firewall.allowedUDPPorts = [ 655 ]; ... Now let’s walk through how to set up tinc using NixOS. In order to make everything less confusing, let’s keep everything inside a nix file, e.g. tinc-example.nix and import this file inside the configuration.nix by adding the former file to the imports statement:\n... imports = [ ... ./tinc-example.nix ... ]; ... Now in getting a tinc node up and running in NixOS is a two-step process: First write down the configuration of the node and rebuild the system.\n{ config, lib, pkgs, ... }: { networking.firewall.allowedTCPPorts = [ 655 ]; networking.firewall.allowedUDPPorts = [ 655 ]; networking.interfaces.\"tinc.example\".ipv4 = { addresses = [ { address = \"10.0.0.0\"; prefixLength = 24; } ]; routes = [ { address = \"192.168.0.0\"; prefixLength = 24; via = \"10.0.0.2\"; } ]; }; services.tinc.networks = { example = { name = \"node0\"; hosts = {}; }; }; } At this point nix will check if the tinc network has already been configured, if not, the node will be bootstrapped, and /etc/tinc/example/hosts/ will be created containing the nodes public keys, but still missing the rest of the configuration.\nNow the node can be added to the hosts attrset, by grabbing the content from the newly generated file (e.g. /etc/tinc/example/hosts/node0) and then add the missing configuration options. From then on, the nodes config file will be overwritten by the configuration (along with all of the other configured hosts). The final tinc configuration will look like this:\n{ config, lib, pkgs, ... }: { networking.firewall.allowedTCPPorts = [ 655 ]; networking.firewall.allowedUDPPorts = [ 655 ]; networking.interfaces.\"tinc.example\".ipv4 = { addresses = [ { address = \"10.0.0.0\"; prefixLength = 24; } ]; routes = [ { address = \"192.168.0.0\"; prefixLength = 24; via = \"10.0.0.2\"; } ]; }; services.tinc.networks = { example = { name = \"node0\"; hosts = { node0 = '' Address = Subnet = 10.0.0.0 Port = 655 Ed25519PublicKey = ... -----BEGIN RSA PUBLIC KEY----- ... -----END RSA PUBLIC KEY----- ''; node1 = '' Subnet = 10.0.0.1 Port = 655 Ed25519PublicKey = ... -----BEGIN RSA PUBLIC KEY----- ... -----END RSA PUBLIC KEY----- ''; node2 = '' Subnet = 10.0.0.2 Subnet = 192.168.0.0/24 Port = 655 Ed25519PublicKey = ... -----BEGIN RSA PUBLIC KEY----- ... -----END RSA PUBLIC KEY----- ''; }; }; }; } At this point the example network can be enabled by simply doing a nixos-rebuild switch and the node should be connected.\nIn the next part we’ll take a closer look at how writing a NixOS module can help with keeping a simpler and readable NixOS configuration.\n","wordCount":"2069","inLanguage":"en","datePublished":"2021-04-03T00:00:00+02:00","dateModified":"2021-04-03T00:00:00+02:00","author":[{"@type":"Person","name":"oblivious observer"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://oblivious.observer/posts/tincdifferent-i-tinc-nixos/"},"publisher":{"@type":"Organization","name":"oblivious observer","logo":{"@type":"ImageObject","url":"https://oblivious.observer/observer-16x16.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://oblivious.observer accesskey=h title="  (Alt + H)"><img src=https://oblivious.observer/observer-64x64.png alt aria-label=logo height=35></a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://oblivious.observer/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://oblivious.observer/posts/ title=posts><span>posts</span></a></li><li><a href=https://oblivious.observer/archives/ title=archive><span>archive</span></a></li><li><a href=https://oblivious.observer/tags/ title=tags><span>tags</span></a></li><li><a href=https://oblivious.observer/index.html title=about><span>about</span></a></li><li><a href=https://oblivious.observer/index.xml title=rss><span>rss</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Tinc different! - Part I: The Fellowship of the Ping</h1><div class=post-meta><span title='2021-04-03 00:00:00 +0200 CEST'>April 3, 2021</span>&nbsp;·&nbsp;10 min&nbsp;·&nbsp;oblivious observer</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#tinc-a-low-maintainance-vpn aria-label="TINC - a low maintainance VPN">TINC - a low maintainance VPN</a><ul><li><a href=#setting-up-a-tinc-mesh-on-linux aria-label="Setting up a TINC Mesh on Linux">Setting up a TINC Mesh on Linux</a></li><li><a href=#setting-up-a-tinc-mesh-on-nixos aria-label="Setting up a TINC Mesh on NixOS">Setting up a TINC Mesh on NixOS</a></li></ul></li></ul></div></details></div><div class=post-content><p>This is a post about <code>tinc</code> - a nifty little Mesh VPN service. It is also the
first part of a little series of posts related to <code>tinc</code> and NixOS. In this first
part I&rsquo;ll just write a bit about how to set up <code>tinc</code>, then in the second part
I&rsquo;ll take a closer look into how writing a NixOS module can managing <code>tinc</code>
networks easier. And finally in the third part I&rsquo;ll present a rewrite of the
module with a bunch more features. For now, lets take a look at <code>tinc</code>..</p><h2 id=tinc-a-low-maintainance-vpn>TINC - a low maintainance VPN<a hidden class=anchor aria-hidden=true href=#tinc-a-low-maintainance-vpn>#</a></h2><p><code>tinc</code> is one of my all-time favourite little tools, a nice little VPN daemon
that has a bunch of really interesting properties such as NAT traversal,
automatic use of TCP and UDP, a per node option of publishing of subnets and of
course the fact that it is a mesh VPN, so nodes can go down without breaking
everything. Also while most people apparently haven&rsquo;t heard about <code>tinc</code> it has
been around for ages.</p><p>In order to create a minimal tinc network you need to set up a network
interface, create a <code>tinc.conf</code> file which contains information on the name of
the node, the network device to use as well as the device type (<code>tun</code> or <code>tap</code>).
There are a bunch of more or less optional files involved in configuring
<code>tinc</code> : For example using two little scripts called <code>tinc-up</code> and <code>tinc-down</code>,
the aforementioned network device that tinc is using can be created or removed
on demand using whatever tools you prefer (e.g. <code>iproute2</code> or <code>ifconfig</code>). Next
a public-private key-pair (RSA and/or ECDSA) has to be generated. <code>tinc</code>
provides an easy way to do so and generates a little node configuration, which
only contains the public key(s) of the node. This config file can then filled
with a bunch of configuration options such as the nodes IP address inside the
mesh, it&rsquo;s (optional) public IP address or subnets connected to a node that you
want to make available to the rest of the mesh. Sounds good? Great, let&rsquo;s look
at the whole process in a bit more detail.</p><h3 id=setting-up-a-tinc-mesh-on-linux>Setting up a TINC Mesh on Linux<a hidden class=anchor aria-hidden=true href=#setting-up-a-tinc-mesh-on-linux>#</a></h3><p>Let&rsquo;s set up a little example Mesh on a bunch of imaginary machines:</p><ul><li><code>node0</code>: with a public IP address, e.g. 10.10.10.1</li><li><code>node1</code>: with a private IP address</li><li><code>node2</code>: with a private IP address and connected to the network
192.168.0.0/24, which should be made accessible to <code>node0</code> and <code>node1</code></li></ul><p>First lets install tinc on all of our hosts using something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt install tinc
</span></span></code></pre></div><p>Then the VPN network has to be set up on each of the nodes. <code>tinc</code> allows for
more than one concurrent VPN connection, and keeps these VPN networks configured
inside <code>/etc/tinc/&lt;vpn-name></code>, so create an example VPN network on all of the
nodes (note that I&rsquo;m using <code>node{0,1,2}</code> to express that this line should be
executed on all three nodes):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff79c6>[</span>user@node<span style=color:#ff79c6>{</span>0,1,2<span style=color:#ff79c6>}</span>:/etc/tinc/example<span style=color:#ff79c6>]</span>$ sudo mkdir /etc/tinc/example
</span></span></code></pre></div><p>Next create the configuration file for this little example VPN network inside
<code>/etc/tinc/example/tinc.conf</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff79c6>[</span>user@node0:/etc/tinc/example<span style=color:#ff79c6>]</span>$ cat tinc.conf
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>Name</span> <span style=color:#ff79c6>=</span> node0
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>DeviceType</span> <span style=color:#ff79c6>=</span> tun
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>user@node1:/etc/tinc/example<span style=color:#ff79c6>]</span>$ cat tinc.conf
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>Name</span> <span style=color:#ff79c6>=</span> node1
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>DeviceType</span> <span style=color:#ff79c6>=</span> tun
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>ConnectTo</span> <span style=color:#ff79c6>=</span> node0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>user@node2:/etc/tinc/example<span style=color:#ff79c6>]</span>$ cat tinc.conf
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>Name</span> <span style=color:#ff79c6>=</span> node2
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>DeviceType</span> <span style=color:#ff79c6>=</span> tun
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>ConnectTo</span> <span style=color:#ff79c6>=</span> node0
</span></span></code></pre></div><p>Note that inside the configuration file, we set up the network device type only,
not the device name, this can be done however using the <code>Interface</code> option. Also
we set the nodes up in such a way that <code>node1</code> as well as <code>node2</code> will initially
try to connect to <code>node0</code> using the <code>ConnectTo</code> option. Interestingly some of
the options seem to be optional, e.g. the NixOS <code>tinc</code> module sets up the
explicit network interface name using the <code>Interface</code> option, but does not seem
to use the <code>ConnectTo</code> option.</p><p>Next on all of the hosts the keypairs need to be configured. In order to set up
a VPN using a RSA key of length 4096, execute the following command on the
nodes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff79c6>[</span>user@node<span style=color:#ff79c6>{</span>0,1,2<span style=color:#ff79c6>}</span>:/etc/tinc/example<span style=color:#ff79c6>]</span>$ sudo tincd -n example -K4096
</span></span></code></pre></div><p><code>tinc</code> will then create a private-public keypair and store the private key
inside of the node configuration file in <code>/etc/tinc/example/hosts/&lt;node-name></code>
on each of the nodes. Apart from the public key these files will be empty:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff79c6>[</span>user@node0:/etc/tinc/example<span style=color:#ff79c6>]</span>$ cat hosts/node0
</span></span><span style=display:flex><span>-----BEGIN RSA PUBLIC KEY-----
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>-----END RSA PUBLIC KEY-----
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>user@node1:/etc/tinc/example<span style=color:#ff79c6>]</span>$ cat hosts/node1
</span></span><span style=display:flex><span>-----BEGIN RSA PUBLIC KEY-----
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>-----END RSA PUBLIC KEY-----
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>user@node2:/etc/tinc/example<span style=color:#ff79c6>]</span>$ cat hosts/node2
</span></span><span style=display:flex><span>-----BEGIN RSA PUBLIC KEY-----
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>-----END RSA PUBLIC KEY-----
</span></span></code></pre></div><p>At this point it makes sense to think about stuff such as ports used by the VPN
and the subnet to use for the nodes. Let&rsquo;s use 10.0.0.0/24 to address our nodes
and use the default <code>tinc</code> port 655. Additionally on <code>node0</code> let&rsquo;s add the nodes
Public IP address and on <code>node2</code> lets add the 192.168.0.0/24 subnet:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff79c6>[</span>user@node0:/etc/tinc/example<span style=color:#ff79c6>]</span>$ cat hosts/node0
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>Address</span> <span style=color:#ff79c6>=</span> 10.10.10.1
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>Subnet</span> <span style=color:#ff79c6>=</span> 10.0.0.0
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>Port</span> <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>655</span>
</span></span><span style=display:flex><span>-----BEGIN RSA PUBLIC KEY-----
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>-----END RSA PUBLIC KEY-----
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>user@node1:/etc/tinc/example<span style=color:#ff79c6>]</span>$ cat hosts/node1
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>Subnet</span> <span style=color:#ff79c6>=</span> 10.0.0.1
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>Port</span> <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>655</span>
</span></span><span style=display:flex><span>-----BEGIN RSA PUBLIC KEY-----
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>-----END RSA PUBLIC KEY-----
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>user@node2:/etc/tinc/example<span style=color:#ff79c6>]</span>$ cat hosts/node2
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>Subnet</span> <span style=color:#ff79c6>=</span> 10.0.0.1
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>Subnet</span> <span style=color:#ff79c6>=</span> 192.168.0.0/24
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>Port</span> <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>655</span>
</span></span><span style=display:flex><span>-----BEGIN RSA PUBLIC KEY-----
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>-----END RSA PUBLIC KEY-----
</span></span></code></pre></div><p>After setting up the nodes configuration files, they need to be shared, since in
our little example only <code>node0</code> has a publicly reachable IP address the easiest
thing would be to upload the config of <code>node1</code> and <code>node2</code> to node0 and at the
same time grab the config files of <code>node0</code>. Ideally of course the configuration
files should be synchronized between all nodes, but this is not a requirement
for <code>tinc</code>, the example VPN will be accessible without having the config of
<code>node1</code> on <code>node2</code> and vice versa as well.</p><p>At this point the setup of the network interface as well as the routes is still
missing. Remember these optional setup files I mentioned earlier? Lets create
<code>/etc/tinc/example/tinc-{up,down}</code> on all of the nodes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff79c6>[</span>user@node0:/etc/tinc/example<span style=color:#ff79c6>]</span>$ cat tinc-up
</span></span><span style=display:flex><span><span style=color:#6272a4>#!/bin/sh</span>
</span></span><span style=display:flex><span>ip link <span style=color:#8be9fd;font-style:italic>set</span> <span style=color:#8be9fd;font-style:italic>$INTERFACE</span> up
</span></span><span style=display:flex><span>ip addr add 10.0.0.0/32 dev <span style=color:#8be9fd;font-style:italic>$INTERFACE</span>
</span></span><span style=display:flex><span>ip route add 192.168.0.0/24 dev <span style=color:#8be9fd;font-style:italic>$INTERFACE</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>user@node0:/etc/tinc/example<span style=color:#ff79c6>]</span>$ cat tinc-down
</span></span><span style=display:flex><span><span style=color:#6272a4>#!/bin/sh</span>
</span></span><span style=display:flex><span>ip route del 192.168.0.0/24 dev <span style=color:#8be9fd;font-style:italic>$INTERFACE</span>
</span></span><span style=display:flex><span>ip addr del 10.0.0.0/32 dev <span style=color:#8be9fd;font-style:italic>$INTERFACE</span>
</span></span><span style=display:flex><span>ip link <span style=color:#8be9fd;font-style:italic>set</span> <span style=color:#8be9fd;font-style:italic>$INTERFACE</span> down
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>user@node2:/etc/tinc/example<span style=color:#ff79c6>]</span>$ cat tinc-up
</span></span><span style=display:flex><span><span style=color:#6272a4>#!/bin/sh</span>
</span></span><span style=display:flex><span>ip link <span style=color:#8be9fd;font-style:italic>set</span> <span style=color:#8be9fd;font-style:italic>$INTERFACE</span> up
</span></span><span style=display:flex><span>ip addr add 10.0.0.2/32 dev <span style=color:#8be9fd;font-style:italic>$INTERFACE</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>user@node2:/etc/tinc/example<span style=color:#ff79c6>]</span>$ cat tinc-down
</span></span><span style=display:flex><span><span style=color:#6272a4>#!/bin/sh</span>
</span></span><span style=display:flex><span>ip addr del 10.0.0.2/32 dev <span style=color:#8be9fd;font-style:italic>$INTERFACE</span>
</span></span><span style=display:flex><span>ip link <span style=color:#8be9fd;font-style:italic>set</span> <span style=color:#8be9fd;font-style:italic>$INTERFACE</span> down
</span></span></code></pre></div><p>Note that since the configuration on <code>node1</code> and <code>node0</code> is pretty much
identical (apart from the ip address of course) I have omitted the
<code>tinc-{up,down}</code> scripts from <code>node1</code>.</p><p>The content of these scripts is pretty much straightforward:</p><ul><li><code>tinc-up</code> creates a new network interface (<code>tinc</code> uses the environment
variable <code>INTERFACE</code> to store the interfaces name), then assigns the IP
address of the node and optionally (<code>node0</code> and <code>node1</code>) add a route to a
subnet that&rsquo;s shared by one of the other nodes (in this case <code>node2</code>).</li><li><code>tinc-down</code> removes the IP address and route from the nodes and takes down the
interface.</li></ul><p>Both <code>tinc-up</code> and <code>tinc-down</code> are really only shell scripts, which are run
before respectively after the <code>tinc</code> VPN is created so writing anything custom
should be relatively straight forward.</p><p>One important part is to make sure the <code>tinc-{up,down}</code> scripts are
executable:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff79c6>[</span>user@node<span style=color:#ff79c6>{</span>0,1,2<span style=color:#ff79c6>}</span>:/etc/tinc/example<span style=color:#ff79c6>]</span>$ sudo chmod +x tinc-<span style=color:#ff79c6>{</span>up,down<span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>At this point everything is set up and enabling and starting the example VPN is
as simple as:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff79c6>[</span>user@node<span style=color:#ff79c6>{</span>0,1,2<span style=color:#ff79c6>}</span>:/etc/tinc/example<span style=color:#ff79c6>]</span>$ sudo systemctl <span style=color:#8be9fd;font-style:italic>enable</span> tinc@example
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>user@node<span style=color:#ff79c6>{</span>0,1,2<span style=color:#ff79c6>}</span>:/etc/tinc/example<span style=color:#ff79c6>]</span>$ sudo systemctl start tinc@example
</span></span></code></pre></div><p>After starting the example network, all nodes should be accessible via their VPN
IP addresses and the 192.168.0.0/24 subnet should be accessible from all nodes
as well.</p><h3 id=setting-up-a-tinc-mesh-on-nixos>Setting up a TINC Mesh on NixOS<a hidden class=anchor aria-hidden=true href=#setting-up-a-tinc-mesh-on-nixos>#</a></h3><p>As with a lot of other things, when using <code>tinc</code> on NixOS everything works a bit
different. Instead of setting everything up by hand there is a neat little
<code>tinc</code> module.</p><p>Sidenote: Using a little alias, it is possible to search for NixOS options
without using the <a href=https://search.nixos.org/options#>options search</a> on the NixOS website:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ <span style=color:#8be9fd;font-style:italic>alias</span> nix-search-options<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;man configuration.nix | less -p &#39;</span>
</span></span><span style=display:flex><span>$ nix-search-options services.tinc
</span></span></code></pre></div><p>This will drop you inside of a <code>less</code> buffer looking like this, where you can
navigate using <code>n</code> and <code>N</code> to jump to the next respectively previous match:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-man data-lang=man><span style=display:flex><span>.<span style=color:#f1fa8c>..</span>
</span></span><span style=display:flex><span>services.tinc.networks
</span></span><span style=display:flex><span>    Defines the tinc networks which will be started. Each network invokes a
</span></span><span style=display:flex><span>    different daemon.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Type: attribute set of submodules
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Default: { }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Declared by:
</span></span><span style=display:flex><span>        &lt;nixpkgs/nixos/modules/services/networking/tinc.nix&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>services.tinc.networks.&lt;name&gt;.package
</span></span><span style=display:flex><span>    The package to use for the tinc daemon&#39;s binary.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Type: package
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Default: &#34;pkgs.tinc_pre&#34;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Declared by:
</span></span><span style=display:flex><span>        &lt;nixpkgs/nixos/modules/services/networking/tinc.nix&gt;
</span></span><span style=display:flex><span>.<span style=color:#f1fa8c>..</span>
</span></span></code></pre></div><p>All in all there are a bunch of available options, but in order to get started
you really only need the following two (that is from the <code>tinc</code> module
specifically):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-man data-lang=man><span style=display:flex><span>services.tinc.networks
</span></span><span style=display:flex><span>    Defines the tinc networks which will be started. Each network invokes
</span></span><span style=display:flex><span>    a different daemon.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>services.tinc.networks.&lt;name&gt;.hosts
</span></span><span style=display:flex><span>    The name of the host in the network as well as the configuration for
</span></span><span style=display:flex><span>    that host. This name should only contain alphanumerics and underscores.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>services.tinc.networks.&lt;name&gt;.name
</span></span><span style=display:flex><span>    The name of the node which is used as an identifier when communicating
</span></span><span style=display:flex><span>    with the remote nodes in the mesh. If null then the hostname of the
</span></span><span style=display:flex><span>    system is used to derive a name (note that tinc may replace non-
</span></span><span style=display:flex><span>    alphanumeric characters in hostnames by underscores).
</span></span></code></pre></div><p>Apart from these configuration options we need to set up a bunch of other
things, such as the networking interface, routes or ports on the firewall. This
is similiar to what we did using the <code>tinc-{up,down}</code> scripts in the previous
section using <code>iproute2</code>:</p><p>The interface <code>tinc</code> expects in NixOS is named <code>tinc.&lt;network-name></code>, so in this
case <code>tinc.example</code> has to be created and set up, here is how this would look
like for <code>node0</code> from our little example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span>  networking<span style=color:#ff79c6>.</span>interfaces<span style=color:#ff79c6>.</span><span style=color:#f1fa8c>&#34;tinc.example&#34;</span><span style=color:#ff79c6>.</span>ipv4 = {
</span></span><span style=display:flex><span>    addresses <span style=color:#ff79c6>=</span> [ { address <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;10.0.0.0&#34;</span>;    prefixLength <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>24</span>; } ];
</span></span><span style=display:flex><span>    routes    <span style=color:#ff79c6>=</span> [ { address <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;192.168.0.0&#34;</span>; prefixLength <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>24</span>; via <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;10.0.0.2&#34;</span>; } ];
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span><span style=color:#ff79c6>...</span>
</span></span></code></pre></div><p>If the firewall is enabled on the nodes, the port used (e.g. 655) has to be
opened as well:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span>  networking<span style=color:#ff79c6>.</span>firewall<span style=color:#ff79c6>.</span>allowedTCPPorts = [ <span style=color:#bd93f9>655</span> ];
</span></span><span style=display:flex><span>  networking<span style=color:#ff79c6>.</span>firewall<span style=color:#ff79c6>.</span>allowedUDPPorts = [ <span style=color:#bd93f9>655</span> ];
</span></span><span style=display:flex><span><span style=color:#ff79c6>...</span>
</span></span></code></pre></div><p>Now let&rsquo;s walk through how to set up <code>tinc</code> using NixOS. In order to make
everything less confusing, let&rsquo;s keep everything inside a <code>nix</code> file, e.g.
<code>tinc-example.nix</code> and import this file inside the <code>configuration.nix</code> by adding
the former file to the <code>imports</code> statement:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span><span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span>  imports = [
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>./tinc-example.nix</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span>  ];
</span></span><span style=display:flex><span><span style=color:#ff79c6>...</span>
</span></span></code></pre></div><p>Now in getting a tinc node up and running in NixOS is a two-step process: First
write down the configuration of the node and rebuild the system.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{ config<span style=color:#ff79c6>,</span> lib<span style=color:#ff79c6>,</span> pkgs<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>...</span> }:
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  networking<span style=color:#ff79c6>.</span>firewall<span style=color:#ff79c6>.</span>allowedTCPPorts <span style=color:#ff79c6>=</span> [ <span style=color:#bd93f9>655</span> ];
</span></span><span style=display:flex><span>  networking<span style=color:#ff79c6>.</span>firewall<span style=color:#ff79c6>.</span>allowedUDPPorts <span style=color:#ff79c6>=</span> [ <span style=color:#bd93f9>655</span> ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  networking<span style=color:#ff79c6>.</span>interfaces<span style=color:#ff79c6>.</span><span style=color:#f1fa8c>&#34;tinc.example&#34;</span><span style=color:#ff79c6>.</span>ipv4 <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>    addresses <span style=color:#ff79c6>=</span> [ { address <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;10.0.0.0&#34;</span>;    prefixLength <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>24</span>; } ];
</span></span><span style=display:flex><span>    routes    <span style=color:#ff79c6>=</span> [ { address <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;192.168.0.0&#34;</span>; prefixLength <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>24</span>; via <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;10.0.0.2&#34;</span>; } ];
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  services<span style=color:#ff79c6>.</span>tinc<span style=color:#ff79c6>.</span>networks <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>    example <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>      name <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;node0&#34;</span>;
</span></span><span style=display:flex><span>      hosts <span style=color:#ff79c6>=</span> {};
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>At this point nix will check if the <code>tinc</code> network has already been configured,
if not, the node will be bootstrapped, and <code>/etc/tinc/example/hosts/&lt;node-name></code>
will be created containing the nodes public keys, but still missing the rest of
the configuration.</p><p>Now the node can be added to the <code>hosts</code> attrset, by grabbing the content from
the newly generated file (e.g. <code>/etc/tinc/example/hosts/node0</code>) and then add the
missing configuration options. From then on, the nodes config file will be
overwritten by the configuration (along with all of the other configured
<code>hosts</code>). The final <code>tinc</code> configuration will look like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{ config<span style=color:#ff79c6>,</span> lib<span style=color:#ff79c6>,</span> pkgs<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>...</span> }:
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  networking<span style=color:#ff79c6>.</span>firewall<span style=color:#ff79c6>.</span>allowedTCPPorts <span style=color:#ff79c6>=</span> [ <span style=color:#bd93f9>655</span> ];
</span></span><span style=display:flex><span>  networking<span style=color:#ff79c6>.</span>firewall<span style=color:#ff79c6>.</span>allowedUDPPorts <span style=color:#ff79c6>=</span> [ <span style=color:#bd93f9>655</span> ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  networking<span style=color:#ff79c6>.</span>interfaces<span style=color:#ff79c6>.</span><span style=color:#f1fa8c>&#34;tinc.example&#34;</span><span style=color:#ff79c6>.</span>ipv4 <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>    addresses <span style=color:#ff79c6>=</span> [ { address <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;10.0.0.0&#34;</span>;    prefixLength <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>24</span>; } ];
</span></span><span style=display:flex><span>    routes    <span style=color:#ff79c6>=</span> [ { address <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;192.168.0.0&#34;</span>; prefixLength <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>24</span>; via <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;10.0.0.2&#34;</span>; } ];
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  services<span style=color:#ff79c6>.</span>tinc<span style=color:#ff79c6>.</span>networks <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>    example <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>      name <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;node0&#34;</span>;
</span></span><span style=display:flex><span>      hosts <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>        node0 <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>          Address =
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>          Subnet = 10.0.0.0
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>          Port = 655
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>          Ed25519PublicKey = ...
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>          -----BEGIN RSA PUBLIC KEY-----
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>          ...
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>          -----END RSA PUBLIC KEY-----
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        &#39;&#39;</span>;
</span></span><span style=display:flex><span>        node1 <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>          Subnet = 10.0.0.1
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>          Port = 655
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>          Ed25519PublicKey = ...
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>          -----BEGIN RSA PUBLIC KEY-----
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>          ...
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>          -----END RSA PUBLIC KEY-----
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        &#39;&#39;</span>;
</span></span><span style=display:flex><span>        node2 <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>          Subnet = 10.0.0.2
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>          Subnet = 192.168.0.0/24
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>          Port = 655
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>          Ed25519PublicKey = ...
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>          -----BEGIN RSA PUBLIC KEY-----
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>          ...
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>          -----END RSA PUBLIC KEY-----
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        &#39;&#39;</span>;
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>At this point the example network can be enabled by simply doing a
<code>nixos-rebuild switch</code> and the node should be connected.</p><p>In the next part we&rsquo;ll take a closer look at how writing a NixOS module can help
with keeping a simpler and readable NixOS configuration.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://oblivious.observer/tags/nixos/>NixOS</a></li><li><a href=https://oblivious.observer/tags/tinc/>tinc</a></li></ul></footer><script src=https://utteranc.es/client.js repo=observer/observer.github.io issue-term=url label=💬 theme=photon-dark crossorigin=anonymous async></script></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>