<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>The Flake Awakens - Switching to a Flake-based Configuration | oblivious observer</title><meta name=keywords content="NixOS,flakes"><meta name=description content="I&rsquo;ve been meaning to write something for a while now, however before I can dive into a couple of more interesting topics here, I feel like it is the best to mention the transition to flakes. I&rsquo;ll try and keep this one short, there are a bunch of other way more detailed posts on flakes already, however I didn&rsquo;t find to many posts about how to switch from an existing configuration to using flakes and it seems to be quite doable."><meta name=author content="oblivious observer"><link rel=canonical href=https://oblivious.observer/posts/nixos-configuration-using-flakes/><link crossorigin=anonymous href=/assets/css/stylesheet.dc96e9e0118e5e264a03d68b104df6ae869cfb73c61f5f89dd91aeb16b0d8c03.css integrity="sha256-3Jbp4BGOXiZKA9aLEE32roac+3PGH1+J3ZGusWsNjAM=" rel="preload stylesheet" as=style><link rel=icon href=https://oblivious.observer/observer-16x16.png><link rel=icon type=image/png sizes=16x16 href=https://oblivious.observer/observer-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://oblivious.observer/observer-32x32.png><link rel=apple-touch-icon href=https://oblivious.observer/observer-512x512.png><link rel=mask-icon href=https://oblivious.observer/observer-512x512.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://oblivious.observer/css/syntax.css><meta property="og:title" content="The Flake Awakens - Switching to a Flake-based Configuration"><meta property="og:description" content="I&rsquo;ve been meaning to write something for a while now, however before I can dive into a couple of more interesting topics here, I feel like it is the best to mention the transition to flakes. I&rsquo;ll try and keep this one short, there are a bunch of other way more detailed posts on flakes already, however I didn&rsquo;t find to many posts about how to switch from an existing configuration to using flakes and it seems to be quite doable."><meta property="og:type" content="article"><meta property="og:url" content="https://oblivious.observer/posts/nixos-configuration-using-flakes/"><meta property="og:image" content="https://oblivious.observer/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-13T00:00:00+00:00"><meta property="article:modified_time" content="2023-03-13T00:00:00+00:00"><meta property="og:site_name" content="oblivious.observer"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://oblivious.observer/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="The Flake Awakens - Switching to a Flake-based Configuration"><meta name=twitter:description content="I&rsquo;ve been meaning to write something for a while now, however before I can dive into a couple of more interesting topics here, I feel like it is the best to mention the transition to flakes. I&rsquo;ll try and keep this one short, there are a bunch of other way more detailed posts on flakes already, however I didn&rsquo;t find to many posts about how to switch from an existing configuration to using flakes and it seems to be quite doable."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://oblivious.observer/posts/"},{"@type":"ListItem","position":3,"name":"The Flake Awakens - Switching to a Flake-based Configuration","item":"https://oblivious.observer/posts/nixos-configuration-using-flakes/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"The Flake Awakens - Switching to a Flake-based Configuration","name":"The Flake Awakens - Switching to a Flake-based Configuration","description":"I\u0026rsquo;ve been meaning to write something for a while now, however before I can dive into a couple of more interesting topics here, I feel like it is the best to mention the transition to flakes. I\u0026rsquo;ll try and keep this one short, there are a bunch of other way more detailed posts on flakes already, however I didn\u0026rsquo;t find to many posts about how to switch from an existing configuration to using flakes and it seems to be quite doable.","keywords":["NixOS","flakes"],"articleBody":"Iâ€™ve been meaning to write something for a while now, however before I can dive into a couple of more interesting topics here, I feel like it is the best to mention the transition to flakes. Iâ€™ll try and keep this one short, there are a bunch of other way more detailed posts on flakes already, however I didnâ€™t find to many posts about how to switch from an existing configuration to using flakes and it seems to be quite doable.\nOn a freshly installed NixOS system, /etc/nixos looks like this:\n[user@host1:/etc/nixos]$ tree -CL 1 . â”œâ”€â”€ configuration.nix â””â”€â”€ hardware-configuration.nix If youâ€™ve played around a bunch, have more than one machine and have at some point in time started using imports, itâ€™ll probably look more like this:\n[user@host1:/etc/nixos]$ tree -CL 1 . â”œâ”€â”€ configuration.nix -\u003e hosts/host1/configuration.nix # symlinked nixos configuration (.gitignored) â”œâ”€â”€ hardware # hardware specific config â”œâ”€â”€ hosts # contains hosts configuration.nix files â”‚Â â”œâ”€â”€ host0 â”‚Â â”œâ”€â”€ host1 ... â”‚Â â””â”€â”€ hostN â”œâ”€â”€ modules # modular configuration bits and pieces â”‚Â â”œâ”€â”€ baseUtils ... â”‚Â â””â”€â”€ zfs â”œâ”€â”€ pkgs # packages that aren't part of nixpkgs â”œâ”€â”€ services # services that are hosted on the hosts â”‚Â â”œâ”€â”€ host2 â”‚Â â”‚Â â””â”€â”€ nextloud â”‚Â â””â”€â”€ host3 â”‚Â â”œâ”€â”€ gitea â”‚Â â”œâ”€â”€ calendar â”‚Â â””â”€â”€ navidrome â”œâ”€â”€ users # user configurations â””â”€â”€ vpn # vpn configurations In my case Iâ€™ve created a bunch of directories containing the bits and pieces of configuration I use. Among them is a hosts directory, which contains all the host-specific files in host-specific directories and I symlink the configuration.nix from there into /etx/nixos/, so I can conveniently execute nixos-rebuild switch. The whole /etc/nixos directory is a git repo I share among all of my machines and the .gitignore file currently contains a single line:\n[user@host1:/etc/nixos]$ cat .gitignore /configuration.nix A typical /etc/nixos/configuration.nix then looks like this, note the paths are relative from the /etc/nixos/hosts/hostname/ directory:\n{ config, pkgs, ... }: { imports = [ ../../modules/baseUtils ../../services/host2/nextcloud ../../users ./hardware-configuration.nix ./vpn/tinc/networkname ]; boot.loader.grub.enable = true; boot.loader.grub.version = 2; boot.initrd.availableKernelModules = [ \"e1000e\" \"virtio_pci\" \"e1000\" ]; ... } Before switching to flakes I decided to do a bit of housekeeping inside the /etc/nixos/hosts/hostname direcories. While this is strictly unnecessary, I kind of liked the idea:\nI renamed /etc/nixos/hosts/host/configuration.nix to default.nix and created a new configuration.nix, which includes default.nix:\n[user@host1:/etc/nixos/hosts/host0]$ tree -CL 1 . â”œâ”€â”€ configuration.nix â”œâ”€â”€ default.nix â””â”€â”€ hardware.nix Now I can just split my system configurations up into the more host-specific part, which I very rarely have to look into, containing options such as boot.loader.grub and another much shorter part that contains, what the system is actually configured for in form of module imports. The new configuration looks so far pretty empty, since weâ€™ve renamed the configuration to default.nix, we can just reference it using ./.:\n{ config, pkgs, ... }: { imports = [ ./. # \u003c- isn't this just beautiful ]; } But back to topic: in order to start using flakes, we need be enable flakes on the system, so create ./modules/flakes/default.nix and import it in default.nix:\n{ lib, pkgs, config, ... }: { nix = { package = pkgs.nixFlakes; extraOptions = '' experimental-features = nix-command flakes ''; }; } Rebuild the system to enable the feature.\nThen in /etc/nixos create a minimal flake.nix file, which contains a link to the hosts configuration.nix inside nixosConfigurations:\n{ description = \"Oblivious Infrastructure\"; inputs = { flake-utils.url = \"github:numtide/flake-utils\"; nix.url = \"github:NixOS/nix/2.5.1\"; nixpkgs.url = \"github:NixOS/nixpkgs/nixos-21.11\"; nixos-hardware.url = \"github:NixOS/nixos-hardware\"; }; outputs = { self, nixpkgs, nix, ... }: { nixosConfigurations = { host0 = nixpkgs.lib.nixosSystem { system = \"x86_64-linux\"; modules = [ ./hosts/host0/configuration.nix ]; }; host1 = nixpkgs.lib.nixosSystem { system = \"x86_64-linux\"; modules = [ ./hosts/host1/configuration.nix ]; }; }; }; } In order to check if everything works just run nixos-rebuild switch --flake .#host from /etc/nixos/ or nixos-rebuild switch --flake /etc/nixos/#host from anywhere else.\nCongratulations, your system now runs on flakes.\n","wordCount":"653","inLanguage":"en","datePublished":"2023-03-13T00:00:00Z","dateModified":"2023-03-13T00:00:00Z","author":[{"@type":"Person","name":"oblivious observer"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://oblivious.observer/posts/nixos-configuration-using-flakes/"},"publisher":{"@type":"Organization","name":"oblivious observer","logo":{"@type":"ImageObject","url":"https://oblivious.observer/observer-16x16.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://oblivious.observer accesskey=h title="  (Alt + H)"><img src=https://oblivious.observer/observer-64x64.png alt aria-label=logo height=35></a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://oblivious.observer/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://oblivious.observer/posts/ title=posts><span>posts</span></a></li><li><a href=https://oblivious.observer/archives/ title=archive><span>archive</span></a></li><li><a href=https://oblivious.observer/tags/ title=tags><span>tags</span></a></li><li><a href=https://oblivious.observer/index.html title=about><span>about</span></a></li><li><a href=https://oblivious.observer/index.xml title=rss><span>rss</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>The Flake Awakens - Switching to a Flake-based Configuration</h1><div class=post-meta><span title='2023-03-13 00:00:00 +0000 UTC'>March 13, 2023</span>&nbsp;Â·&nbsp;4 min&nbsp;Â·&nbsp;oblivious observer</div></header><div class=post-content><p>I&rsquo;ve been meaning to write something for a while now, however before I can dive
into a couple of more interesting topics here, I feel like it is the best to
mention the transition to flakes. I&rsquo;ll try and keep this one short, there are a
bunch of other way more detailed posts on flakes already, however I didn&rsquo;t find
to many posts about how to switch from an existing configuration to using flakes
and it seems to be quite doable.</p><p>On a freshly installed NixOS system, <code>/etc/nixos</code> looks like this:</p><pre tabindex=0><code class=language-nil data-lang=nil>[user@host1:/etc/nixos]$ tree -CL 1
.
â”œâ”€â”€ configuration.nix
â””â”€â”€ hardware-configuration.nix
</code></pre><p>If you&rsquo;ve played around a bunch, have more than one machine and have at some
point in time started using <code>imports</code>, it&rsquo;ll probably look more like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff79c6>[</span>user@host1:/etc/nixos<span style=color:#ff79c6>]</span>$ tree -CL <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>â”œâ”€â”€ configuration.nix -&gt; hosts/host1/configuration.nix <span style=color:#6272a4># symlinked nixos configuration (.gitignored)</span>
</span></span><span style=display:flex><span>â”œâ”€â”€ hardware                                           <span style=color:#6272a4># hardware specific config</span>
</span></span><span style=display:flex><span>â”œâ”€â”€ hosts                                              <span style=color:#6272a4># contains hosts configuration.nix files</span>
</span></span><span style=display:flex><span>â”‚Â Â  â”œâ”€â”€ host0
</span></span><span style=display:flex><span>â”‚Â Â  â”œâ”€â”€ host1
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>â”‚Â Â  â””â”€â”€ hostN
</span></span><span style=display:flex><span>â”œâ”€â”€ modules                                            <span style=color:#6272a4># modular configuration bits and pieces</span>
</span></span><span style=display:flex><span>â”‚Â Â  â”œâ”€â”€ baseUtils
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>â”‚Â Â  â””â”€â”€ zfs
</span></span><span style=display:flex><span>â”œâ”€â”€ pkgs                                               <span style=color:#6272a4># packages that aren&#39;t part of nixpkgs</span>
</span></span><span style=display:flex><span>â”œâ”€â”€ services                                           <span style=color:#6272a4># services that are hosted on the hosts</span>
</span></span><span style=display:flex><span>â”‚Â Â  â”œâ”€â”€ host2
</span></span><span style=display:flex><span>â”‚Â Â  â”‚Â Â  â””â”€â”€ nextloud
</span></span><span style=display:flex><span>â”‚Â Â  â””â”€â”€ host3
</span></span><span style=display:flex><span>â”‚Â Â      â”œâ”€â”€ gitea
</span></span><span style=display:flex><span>â”‚Â Â      â”œâ”€â”€ calendar
</span></span><span style=display:flex><span>â”‚Â Â      â””â”€â”€ navidrome
</span></span><span style=display:flex><span>â”œâ”€â”€ users                                              <span style=color:#6272a4># user configurations</span>
</span></span><span style=display:flex><span>â””â”€â”€ vpn                                                <span style=color:#6272a4># vpn configurations</span>
</span></span></code></pre></div><p>In my case I&rsquo;ve created a bunch of directories containing the bits and pieces of
configuration I use. Among them is a <code>hosts</code> directory, which contains all the
host-specific files in host-specific directories and I symlink the
<code>configuration.nix</code> from there into <code>/etx/nixos/</code>, so I can conveniently execute
<code>nixos-rebuild switch</code>. The whole <code>/etc/nixos</code> directory is a git repo I share
among all of my machines and the <code>.gitignore</code> file currently contains a single
line:</p><pre tabindex=0><code class=language-config data-lang=config>[user@host1:/etc/nixos]$ cat .gitignore
/configuration.nix
</code></pre><p>A typical <code>/etc/nixos/configuration.nix</code> then looks like this, note the paths
are relative from the <code>/etc/nixos/hosts/hostname/</code> directory:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{ config<span style=color:#ff79c6>,</span> pkgs<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>...</span> }:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  imports <span style=color:#ff79c6>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>../../modules/baseUtils</span>
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>../../services/host2/nextcloud</span>
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>../../users</span>
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>./hardware-configuration.nix</span>
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>./vpn/tinc/networkname</span>
</span></span><span style=display:flex><span>  ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  boot<span style=color:#ff79c6>.</span>loader<span style=color:#ff79c6>.</span>grub<span style=color:#ff79c6>.</span>enable <span style=color:#ff79c6>=</span> true;
</span></span><span style=display:flex><span>  boot<span style=color:#ff79c6>.</span>loader<span style=color:#ff79c6>.</span>grub<span style=color:#ff79c6>.</span>version <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>2</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  boot<span style=color:#ff79c6>.</span>initrd<span style=color:#ff79c6>.</span>availableKernelModules <span style=color:#ff79c6>=</span> [ <span style=color:#f1fa8c>&#34;e1000e&#34;</span> <span style=color:#f1fa8c>&#34;virtio_pci&#34;</span> <span style=color:#f1fa8c>&#34;e1000&#34;</span> ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Before switching to flakes I decided to do a bit of housekeeping inside the
<code>/etc/nixos/hosts/hostname</code> direcories. While this is strictly unnecessary, I
kind of liked the idea:</p><p>I renamed <code>/etc/nixos/hosts/host/configuration.nix</code> to <code>default.nix</code> and created
a new <code>configuration.nix</code>, which includes <code>default.nix</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff79c6>[</span>user@host1:/etc/nixos/hosts/host0<span style=color:#ff79c6>]</span>$ tree -CL <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>â”œâ”€â”€ configuration.nix
</span></span><span style=display:flex><span>â”œâ”€â”€ default.nix
</span></span><span style=display:flex><span>â””â”€â”€ hardware.nix
</span></span></code></pre></div><p>Now I can just split my system configurations up into the more host-specific
part, which I very rarely have to look into, containing options such as
<code>boot.loader.grub</code> and another much shorter part that contains, what the system
is actually configured for in form of module imports. The new configuration
looks so far pretty empty, since we&rsquo;ve renamed the configuration to
<code>default.nix</code>, we can just reference it using <code>./.</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{ config<span style=color:#ff79c6>,</span> pkgs<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>...</span> }:
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  imports <span style=color:#ff79c6>=</span> [
</span></span><span style=display:flex><span>      <span style=color:#f1fa8c>./.</span> <span style=color:#6272a4># &lt;- isn&#39;t this just beautiful</span>
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>But back to topic: in order to start using flakes, we need be enable flakes on
the system, so create <code>./modules/flakes/default.nix</code> and import it in
<code>default.nix</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{ lib<span style=color:#ff79c6>,</span> pkgs<span style=color:#ff79c6>,</span> config<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>...</span> }:
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  nix <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>    package <span style=color:#ff79c6>=</span> pkgs<span style=color:#ff79c6>.</span>nixFlakes;
</span></span><span style=display:flex><span>    extraOptions <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      experimental-features = nix-command flakes
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    &#39;&#39;</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Rebuild the system to enable the feature.</p><p>Then in <code>/etc/nixos</code> create a minimal <code>flake.nix</code> file, which contains a link to
the hosts <code>configuration.nix</code> inside <code>nixosConfigurations</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{
</span></span><span style=display:flex><span>  description <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;Oblivious Infrastructure&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  inputs <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>    flake-utils<span style=color:#ff79c6>.</span>url    <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;github:numtide/flake-utils&#34;</span>;
</span></span><span style=display:flex><span>    nix<span style=color:#ff79c6>.</span>url            <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;github:NixOS/nix/2.5.1&#34;</span>;
</span></span><span style=display:flex><span>    nixpkgs<span style=color:#ff79c6>.</span>url        <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;github:NixOS/nixpkgs/nixos-21.11&#34;</span>;
</span></span><span style=display:flex><span>    nixos-hardware<span style=color:#ff79c6>.</span>url <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;github:NixOS/nixos-hardware&#34;</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  outputs <span style=color:#ff79c6>=</span> { self<span style=color:#ff79c6>,</span> nixpkgs<span style=color:#ff79c6>,</span> nix<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>...</span> }: {
</span></span><span style=display:flex><span>    nixosConfigurations <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>      host0 <span style=color:#ff79c6>=</span> nixpkgs<span style=color:#ff79c6>.</span>lib<span style=color:#ff79c6>.</span>nixosSystem {
</span></span><span style=display:flex><span>        system <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;x86_64-linux&#34;</span>;
</span></span><span style=display:flex><span>        modules <span style=color:#ff79c6>=</span> [
</span></span><span style=display:flex><span>          <span style=color:#f1fa8c>./hosts/host0/configuration.nix</span>
</span></span><span style=display:flex><span>        ];
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>      host1 <span style=color:#ff79c6>=</span> nixpkgs<span style=color:#ff79c6>.</span>lib<span style=color:#ff79c6>.</span>nixosSystem {
</span></span><span style=display:flex><span>        system <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;x86_64-linux&#34;</span>;
</span></span><span style=display:flex><span>        modules <span style=color:#ff79c6>=</span> [
</span></span><span style=display:flex><span>          <span style=color:#f1fa8c>./hosts/host1/configuration.nix</span>
</span></span><span style=display:flex><span>        ];
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>In order to check if everything works just run <code>nixos-rebuild switch --flake .#host</code> from <code>/etc/nixos/</code> or <code>nixos-rebuild switch --flake /etc/nixos/#host</code>
from anywhere else.</p><p>Congratulations, your system now runs on flakes.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://oblivious.observer/tags/nixos/>NixOS</a></li><li><a href=https://oblivious.observer/tags/flakes/>flakes</a></li></ul></footer><script src=https://utteranc.es/client.js repo=observer/observer.github.io issue-term=url label=ðŸ’¬ theme=photon-dark crossorigin=anonymous async></script></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>