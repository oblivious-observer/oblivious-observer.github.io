<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>NixOS on ZFS Install Script | oblivious observer</title><meta name=keywords content="NixOS,ZFS"><meta name=description content="This is a rather short post and the start of what will hopefully become a nice little series of posts related to NixOS.
I just had to bulk install NixOS on a bunch of Intel NUCs, here is a little script to automate the installation process. Some bits and pieces are taken from other installation scripts, but it&rsquo;s been a while, so I don&rsquo;t know who to credit for them, I&rsquo;m fairly sure this wonderful post from the NixOS discourse was involved though."><meta name=author content="oblivious observer"><link rel=canonical href=https://oblivious.observer/posts/nixos-zfs-install-script/><link crossorigin=anonymous href=/assets/css/stylesheet.0c4fd3725171366f335155acde6fb3c7b7042cd2fd075bebf5023d9b28a701b2.css integrity="sha256-DE/TclFxNm8zUVWs3m+zx7cELNL9B1vr9QI9myinAbI=" rel="preload stylesheet" as=style><link rel=icon href=https://oblivious.observer/observer-16x16.png><link rel=icon type=image/png sizes=16x16 href=https://oblivious.observer/observer-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://oblivious.observer/observer-32x32.png><link rel=apple-touch-icon href=https://oblivious.observer/observer-512x512.png><link rel=mask-icon href=https://oblivious.observer/observer-512x512.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://oblivious.observer/css/syntax.css><meta property="og:title" content="NixOS on ZFS Install Script"><meta property="og:description" content="This is a rather short post and the start of what will hopefully become a nice little series of posts related to NixOS.
I just had to bulk install NixOS on a bunch of Intel NUCs, here is a little script to automate the installation process. Some bits and pieces are taken from other installation scripts, but it&rsquo;s been a while, so I don&rsquo;t know who to credit for them, I&rsquo;m fairly sure this wonderful post from the NixOS discourse was involved though."><meta property="og:type" content="article"><meta property="og:url" content="https://oblivious.observer/posts/nixos-zfs-install-script/"><meta property="og:image" content="https://oblivious.observer/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-08-26T00:00:00+02:00"><meta property="article:modified_time" content="2020-08-26T00:00:00+02:00"><meta property="og:site_name" content="oblivious.observer"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://oblivious.observer/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="NixOS on ZFS Install Script"><meta name=twitter:description content="This is a rather short post and the start of what will hopefully become a nice little series of posts related to NixOS.
I just had to bulk install NixOS on a bunch of Intel NUCs, here is a little script to automate the installation process. Some bits and pieces are taken from other installation scripts, but it&rsquo;s been a while, so I don&rsquo;t know who to credit for them, I&rsquo;m fairly sure this wonderful post from the NixOS discourse was involved though."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://oblivious.observer/posts/"},{"@type":"ListItem","position":3,"name":"NixOS on ZFS Install Script","item":"https://oblivious.observer/posts/nixos-zfs-install-script/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"NixOS on ZFS Install Script","name":"NixOS on ZFS Install Script","description":"This is a rather short post and the start of what will hopefully become a nice little series of posts related to NixOS.\nI just had to bulk install NixOS on a bunch of Intel NUCs, here is a little script to automate the installation process. Some bits and pieces are taken from other installation scripts, but it\u0026rsquo;s been a while, so I don\u0026rsquo;t know who to credit for them, I\u0026rsquo;m fairly sure this wonderful post from the NixOS discourse was involved though.","keywords":["NixOS","ZFS"],"articleBody":"This is a rather short post and the start of what will hopefully become a nice little series of posts related to NixOS.\nI just had to bulk install NixOS on a bunch of Intel NUCs, here is a little script to automate the installation process. Some bits and pieces are taken from other installation scripts, but itâ€™s been a while, so I donâ€™t know who to credit for them, Iâ€™m fairly sure this wonderful post from the NixOS discourse was involved though. The whole script can be found here as gist as well.\nStart with the usual #! and set the script up to exit on errors using set -e:\n#!/usr/bin/env bash set -e Next add a function for pretty printing, (I stole this part from somewhere else).\npprint () { local cyan=\"\\e[96m\" local default=\"\\e[39m\" # ISO8601 timestamp + ms local timestamp timestamp=$(date +%FT%T.%3NZ) echo -e \"${cyan}${timestamp} $1${default}\" 1\u003e\u00262 } Instead of using a DISK variable and changing its value inside the script everytime it is run, simply let the user pick the device.\necho \"These are the disks available:\" ls -l /dev/disk/by-id/ | awk '{print $11, $10, $9}' | tr -d './' | column -t echo # Set DISK select ENTRY in $(ls /dev/disk/by-id/); do echo $ENTRY DISK=\"/dev/disk/by-id/$ENTRY\" echo \"Installing system on $ENTRY.\" break done Next set up the SWAP Size:\necho -n \"Enter Swap size (e.g. 10GiB, 5MiB)\" echo read SWAP_SIZE if [[ $SWAP_SIZE =~ ^[0-9]*(GiB|MiB)$ ]] then echo \"Swap size set to $SWAP_SIZE\" else echo \"Please enter correct size\" break fi Ask for confirmation and wipe the disk:\nread -p \"\u003e Do you want to wipe all data on $ENTRY ?\" -n 1 -r echo # move to a new line if [[ \"$REPLY\" =~ ^[Yy]$ ]] then # Clear disk wipefs -af \"$DISK\" sgdisk -Zo \"$DISK\" partprobe $DISK else exit 1 fi Initially I was using sgdisk in order to create all partitions. This usually seems to work, however I noticed, that on some hardware devices (NUC Canyons), the boot flag had to be set in order for them to actually boot up, so i switched to parted instead.\nparted $DISK -- mklabel gpt pprint \"Creating system partition\" parted $DISK -- mkpart primary 512MiB -${SWAP_SIZE} ROOT=\"$DISK-part1\" pprint \"Creating swap partition\" parted $DISK -- mkpart primary linux-swap -${SWAP_SIZE} 100% SWAP=\"$DISK-part2\" pprint \"Creating boot (EFI) partition\" parted $DISK -- mkpart ESP fat32 1MiB 512MiB parted $DISK -- set 3 boot on BOOT=\"$DISK-part3\" pprint \"Running partprobe on $DISK\" partprobe $DISK Now that the partitions have been created, lets create filesystems and mount them. The sleep at the beginning seems to be necessary, otherwise there are problems with creating the swap partition.\nsleep 2 # not sure why, but if we don't wait, the following swap does not work properly pprint \"Enable SWAP on $SWAP\" mkswap -L swap $SWAP swapon -L swap # ZFS partition pprint \"Create zfs pool rpool\" zpool create -f -O mountpoint=none -O acltype=posixacl -O xattr=sa -R /mnt rpool $ROOT pprint \"Create zfs dataset rpool/root\" zfs create -o mountpoint=none rpool/root pprint \"Create zfs dataset rpool/root/nixos\" zfs create -o mountpoint=legacy rpool/root/nixos pprint \"Create zfs dataset rpool/home\" zfs create -o mountpoint=legacy rpool/home pprint \"Mount datasets: rpool/root/nixos\" mount -t zfs rpool/root/nixos /mnt pprint \"Mount datasets: rpool/home\" mkdir /mnt/home mount -t zfs rpool/home /mnt/home pprint \"Mount boot partition\" mkfs.fat -F 32 -n boot $BOOT mkdir /mnt/boot mount $BOOT /mnt/boot Finally create a nixos configuration and set the system up to boot from ZFS:\npprint \"Generate NixOS configuration\" nixos-generate-config --root /mnt # Add ZFS configuration HOSTID=$(head -c8 /etc/machine-id) HARDWARE_CONFIG=$(mktemp) cat \u003c\u003c CONFIG \u003e \"$HARDWARE_CONFIG\" networking.hostId = \"$HOSTID\"; boot.supportedFilesystems = [ \"zfs\" ]; boot.zfs.devNodes = \"$ROOT\"; } CONFIG #pprint \"Append configuration to hardware-configuration.nix\" sed -i \"\\$ s/.}\\$//;\\$e cat $HARDWARE_CONFIG\" /mnt/etc/nixos/configuration.nix pprint \"You can now install nixos using the 'nixos-install' command.\" ","wordCount":"628","inLanguage":"en","datePublished":"2020-08-26T00:00:00+02:00","dateModified":"2020-08-26T00:00:00+02:00","author":[{"@type":"Person","name":"oblivious observer"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://oblivious.observer/posts/nixos-zfs-install-script/"},"publisher":{"@type":"Organization","name":"oblivious observer","logo":{"@type":"ImageObject","url":"https://oblivious.observer/observer-16x16.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://oblivious.observer accesskey=h title="  (Alt + H)"><img src=https://oblivious.observer/observer-64x64.png alt aria-label=logo height=35></a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://oblivious.observer/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://oblivious.observer/posts/ title=posts><span>posts</span></a></li><li><a href=https://oblivious.observer/archives/ title=archive><span>archive</span></a></li><li><a href=https://oblivious.observer/tags/ title=tags><span>tags</span></a></li><li><a href=https://oblivious.observer/index.html title=about><span>about</span></a></li><li><a href=https://oblivious.observer/index.xml title=rss><span>rss</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>NixOS on ZFS Install Script</h1><div class=post-meta><span title='2020-08-26 00:00:00 +0200 CEST'>August 26, 2020</span>&nbsp;Â·&nbsp;3 min&nbsp;Â·&nbsp;oblivious observer</div></header><div class=post-content><p>This is a rather short post and the start of what will hopefully become a nice
little series of posts related to NixOS.</p><p>I just had to bulk install NixOS on a bunch of Intel NUCs, here is a little
script to automate the installation process. Some bits and pieces are taken from
other installation scripts, but it&rsquo;s been a while, so I don&rsquo;t know who to credit
for them, I&rsquo;m fairly sure this <a href="https://discourse.nixos.org/t/nixos-on-luks-encrypted-partition-with-zfs-and-swap/6873?u=observer">wonderful post</a> from the NixOS discourse was
involved though. The whole script can be found <a href=https://gist.githubusercontent.com/observer/ceded0ee4468c931c716b5b2ddc07e77/raw/fb7ca15c62937fd570a7c045b4346d521ba75610/gistfile1.txt>here</a> as gist as well.</p><p>Start with the usual <code>#!</code> and set the script up to exit on errors using <code>set -e</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff79c6>#!/usr/bin/env bash
</span></span></span><span style=display:flex><span><span style=color:#ff79c6></span><span style=color:#8be9fd;font-style:italic>set</span> -e
</span></span></code></pre></div><p>Next add a function for pretty printing, (I stole this part from somewhere else).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pprint <span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>local</span> <span style=color:#8be9fd;font-style:italic>cyan</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;\e[96m&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>local</span> <span style=color:#8be9fd;font-style:italic>default</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;\e[39m&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4># ISO8601 timestamp + ms</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>local</span> timestamp
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>timestamp</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>date +%FT%T.%3NZ<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>echo</span> -e <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>cyan</span><span style=color:#f1fa8c>}${</span><span style=color:#8be9fd;font-style:italic>timestamp</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c> </span><span style=color:#8be9fd;font-style:italic>$1</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>default</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span> 1&gt;&amp;<span style=color:#bd93f9>2</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>Instead of using a <code>DISK</code> variable and changing its value inside the script
everytime it is run, simply let the user pick the device.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;These are the disks available:&#34;</span>
</span></span><span style=display:flex><span>ls -l /dev/disk/by-id/ | awk <span style=color:#f1fa8c>&#39;{print $11, $10, $9}&#39;</span> | tr -d <span style=color:#f1fa8c>&#39;./&#39;</span> | column -t
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>echo</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># Set DISK</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>select</span> ENTRY in <span style=color:#ff79c6>$(</span>ls /dev/disk/by-id/<span style=color:#ff79c6>)</span>;
</span></span><span style=display:flex><span><span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#8be9fd;font-style:italic>$ENTRY</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>DISK</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;/dev/disk/by-id/</span><span style=color:#8be9fd;font-style:italic>$ENTRY</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;Installing system on </span><span style=color:#8be9fd;font-style:italic>$ENTRY</span><span style=color:#f1fa8c>.&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>break</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>done</span>
</span></span></code></pre></div><p>Next set up the SWAP Size:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>echo</span> -n <span style=color:#f1fa8c>&#34;Enter Swap size (e.g. 10GiB, 5MiB)&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>echo</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>read</span> SWAP_SIZE
</span></span><span style=display:flex><span><span style=color:#ff79c6>if</span> <span style=color:#ff79c6>[[</span> <span style=color:#8be9fd;font-style:italic>$SWAP_SIZE</span> <span style=color:#ff79c6>=</span>~ ^<span style=color:#ff79c6>[</span>0-9<span style=color:#ff79c6>]</span>*<span style=color:#ff79c6>(</span>GiB|MiB<span style=color:#ff79c6>)</span>$ <span style=color:#ff79c6>]]</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>then</span>
</span></span><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;Swap size set to </span><span style=color:#8be9fd;font-style:italic>$SWAP_SIZE</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>else</span>
</span></span><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;Please enter correct size&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>break</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>fi</span>
</span></span></code></pre></div><p>Ask for confirmation and wipe the disk:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>read</span> -p <span style=color:#f1fa8c>&#34;&gt; Do you want to wipe all data on </span><span style=color:#8be9fd;font-style:italic>$ENTRY</span><span style=color:#f1fa8c> ?&#34;</span> -n <span style=color:#bd93f9>1</span> -r
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#6272a4># move to a new line</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>if</span> <span style=color:#ff79c6>[[</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$REPLY</span><span style=color:#f1fa8c>&#34;</span> <span style=color:#ff79c6>=</span>~ ^<span style=color:#ff79c6>[</span>Yy<span style=color:#ff79c6>]</span>$ <span style=color:#ff79c6>]]</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>then</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4># Clear disk</span>
</span></span><span style=display:flex><span>    wipefs -af <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$DISK</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>    sgdisk -Zo <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$DISK</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>    partprobe <span style=color:#8be9fd;font-style:italic>$DISK</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>else</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>exit</span> <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>fi</span>
</span></span></code></pre></div><p>Initially I was using <code>sgdisk</code> in order to create all partitions. This usually
seems to work, however I noticed, that on some hardware devices (NUC Canyons),
the boot flag had to be set in order for them to actually boot up, so i switched
to <code>parted</code> instead.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>parted <span style=color:#8be9fd;font-style:italic>$DISK</span> -- mklabel gpt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pprint <span style=color:#f1fa8c>&#34;Creating system partition&#34;</span>
</span></span><span style=display:flex><span>parted <span style=color:#8be9fd;font-style:italic>$DISK</span> -- mkpart primary 512MiB -<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>SWAP_SIZE</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>ROOT</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$DISK</span><span style=color:#f1fa8c>-part1&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pprint <span style=color:#f1fa8c>&#34;Creating swap partition&#34;</span>
</span></span><span style=display:flex><span>parted <span style=color:#8be9fd;font-style:italic>$DISK</span> -- mkpart primary linux-swap -<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>SWAP_SIZE</span><span style=color:#f1fa8c>}</span> 100%
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>SWAP</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$DISK</span><span style=color:#f1fa8c>-part2&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pprint <span style=color:#f1fa8c>&#34;Creating boot (EFI) partition&#34;</span>
</span></span><span style=display:flex><span>parted <span style=color:#8be9fd;font-style:italic>$DISK</span> -- mkpart ESP fat32 1MiB 512MiB
</span></span><span style=display:flex><span>parted <span style=color:#8be9fd;font-style:italic>$DISK</span> -- <span style=color:#8be9fd;font-style:italic>set</span> <span style=color:#bd93f9>3</span> boot on
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>BOOT</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$DISK</span><span style=color:#f1fa8c>-part3&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pprint <span style=color:#f1fa8c>&#34;Running partprobe on </span><span style=color:#8be9fd;font-style:italic>$DISK</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>partprobe <span style=color:#8be9fd;font-style:italic>$DISK</span>
</span></span></code></pre></div><p>Now that the partitions have been created, lets create filesystems and mount
them. The <code>sleep</code> at the beginning seems to be necessary, otherwise there are
problems with creating the swap partition.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sleep <span style=color:#bd93f9>2</span> <span style=color:#6272a4># not sure why, but if we don&#39;t wait, the following swap does not work properly</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pprint <span style=color:#f1fa8c>&#34;Enable SWAP on </span><span style=color:#8be9fd;font-style:italic>$SWAP</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>mkswap -L swap <span style=color:#8be9fd;font-style:italic>$SWAP</span>
</span></span><span style=display:flex><span>swapon -L swap
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># ZFS partition</span>
</span></span><span style=display:flex><span>pprint <span style=color:#f1fa8c>&#34;Create zfs pool rpool&#34;</span>
</span></span><span style=display:flex><span>zpool create -f -O <span style=color:#8be9fd;font-style:italic>mountpoint</span><span style=color:#ff79c6>=</span>none -O <span style=color:#8be9fd;font-style:italic>acltype</span><span style=color:#ff79c6>=</span>posixacl -O <span style=color:#8be9fd;font-style:italic>xattr</span><span style=color:#ff79c6>=</span>sa -R /mnt rpool <span style=color:#8be9fd;font-style:italic>$ROOT</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pprint <span style=color:#f1fa8c>&#34;Create zfs dataset rpool/root&#34;</span>
</span></span><span style=display:flex><span>zfs create -o <span style=color:#8be9fd;font-style:italic>mountpoint</span><span style=color:#ff79c6>=</span>none   rpool/root
</span></span><span style=display:flex><span>pprint <span style=color:#f1fa8c>&#34;Create zfs dataset rpool/root/nixos&#34;</span>
</span></span><span style=display:flex><span>zfs create -o <span style=color:#8be9fd;font-style:italic>mountpoint</span><span style=color:#ff79c6>=</span>legacy rpool/root/nixos
</span></span><span style=display:flex><span>pprint <span style=color:#f1fa8c>&#34;Create zfs dataset rpool/home&#34;</span>
</span></span><span style=display:flex><span>zfs create -o <span style=color:#8be9fd;font-style:italic>mountpoint</span><span style=color:#ff79c6>=</span>legacy rpool/home
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pprint <span style=color:#f1fa8c>&#34;Mount datasets: rpool/root/nixos&#34;</span>
</span></span><span style=display:flex><span>mount -t zfs rpool/root/nixos /mnt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pprint <span style=color:#f1fa8c>&#34;Mount datasets: rpool/home&#34;</span>
</span></span><span style=display:flex><span>mkdir /mnt/home
</span></span><span style=display:flex><span>mount -t zfs rpool/home /mnt/home
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pprint <span style=color:#f1fa8c>&#34;Mount boot partition&#34;</span>
</span></span><span style=display:flex><span>mkfs.fat -F <span style=color:#bd93f9>32</span> -n boot <span style=color:#8be9fd;font-style:italic>$BOOT</span>
</span></span><span style=display:flex><span>mkdir /mnt/boot
</span></span><span style=display:flex><span>mount <span style=color:#8be9fd;font-style:italic>$BOOT</span> /mnt/boot
</span></span></code></pre></div><p>Finally create a nixos configuration and set the system up to boot from ZFS:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pprint <span style=color:#f1fa8c>&#34;Generate NixOS configuration&#34;</span>
</span></span><span style=display:flex><span>nixos-generate-config --root /mnt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># Add ZFS configuration</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>HOSTID</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>head -c8 /etc/machine-id<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>HARDWARE_CONFIG</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>mktemp<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>cat <span style=color:#f1fa8c>&lt;&lt; CONFIG &gt; &#34;$HARDWARE_CONFIG</span><span style=color:#f1fa8c>&#34;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>networking.hostId = &#34;</span><span style=color:#8be9fd;font-style:italic>$HOSTID</span><span style=color:#f1fa8c>&#34;;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>boot.supportedFilesystems = [ &#34;</span>zfs<span style=color:#f1fa8c>&#34; ];
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>boot.zfs.devNodes = &#34;</span><span style=color:#8be9fd;font-style:italic>$ROOT</span><span style=color:#f1fa8c>&#34;;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>}
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>CONFIG
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>#pprint &#34;</span>Append configuration to hardware-configuration.nix<span style=color:#f1fa8c>&#34;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>sed -i &#34;</span><span style=color:#f1fa8c>\$</span> s/.<span style=color:#ff79c6>}</span><span style=color:#f1fa8c>\$</span>//;<span style=color:#f1fa8c>\$</span>e cat <span style=color:#8be9fd;font-style:italic>$HARDWARE_CONFIG</span><span style=color:#f1fa8c>&#34; /mnt/etc/nixos/configuration.nix
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>pprint &#34;</span>You can now install nixos using the <span style=color:#f1fa8c>&#39;nixos-install&#39;</span> command.<span style=color:#f1fa8c>&#34;
</span></span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://oblivious.observer/tags/nixos/>NixOS</a></li><li><a href=https://oblivious.observer/tags/zfs/>ZFS</a></li></ul></footer><script src=https://utteranc.es/client.js repo=observer/observer.github.io issue-term=url label=ðŸ’¬ theme=photon-dark crossorigin=anonymous async></script></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>