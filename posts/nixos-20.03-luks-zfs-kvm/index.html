<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>NixOS encrypted VM installation | oblivious observer</title><meta name=keywords content="NixOS,ZFS,LUKS,libguestfs,dropbear"><meta name=description content="In this post I&rsquo;ll describe how to set up a sparse VM image with full disk encryption and NixOS on ZFS, which can be uploaded to a VPS provider and then unlocked on boot using ssh.
First we need to create a virtual machine image file. Initially I tried using qemu-img, but somehow the image file was missing some information and the VM would not recognize a disk. Instead I went with the easy way and used virt-manager to create a new VM with the correct image size."><meta name=author content="oblivious observer"><link rel=canonical href=https://oblivious.observer/posts/nixos-20.03-luks-zfs-kvm/><link crossorigin=anonymous href=/assets/css/stylesheet.0c4fd3725171366f335155acde6fb3c7b7042cd2fd075bebf5023d9b28a701b2.css integrity="sha256-DE/TclFxNm8zUVWs3m+zx7cELNL9B1vr9QI9myinAbI=" rel="preload stylesheet" as=style><link rel=icon href=https://oblivious.observer/observer-16x16.png><link rel=icon type=image/png sizes=16x16 href=https://oblivious.observer/observer-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://oblivious.observer/observer-32x32.png><link rel=apple-touch-icon href=https://oblivious.observer/observer-512x512.png><link rel=mask-icon href=https://oblivious.observer/observer-512x512.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://oblivious.observer/css/syntax.css><meta property="og:title" content="NixOS encrypted VM installation"><meta property="og:description" content="In this post I&rsquo;ll describe how to set up a sparse VM image with full disk encryption and NixOS on ZFS, which can be uploaded to a VPS provider and then unlocked on boot using ssh.
First we need to create a virtual machine image file. Initially I tried using qemu-img, but somehow the image file was missing some information and the VM would not recognize a disk. Instead I went with the easy way and used virt-manager to create a new VM with the correct image size."><meta property="og:type" content="article"><meta property="og:url" content="https://oblivious.observer/posts/nixos-20.03-luks-zfs-kvm/"><meta property="og:image" content="https://oblivious.observer/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-08-29T00:00:00+02:00"><meta property="article:modified_time" content="2020-08-29T00:00:00+02:00"><meta property="og:site_name" content="oblivious.observer"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://oblivious.observer/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="NixOS encrypted VM installation"><meta name=twitter:description content="In this post I&rsquo;ll describe how to set up a sparse VM image with full disk encryption and NixOS on ZFS, which can be uploaded to a VPS provider and then unlocked on boot using ssh.
First we need to create a virtual machine image file. Initially I tried using qemu-img, but somehow the image file was missing some information and the VM would not recognize a disk. Instead I went with the easy way and used virt-manager to create a new VM with the correct image size."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://oblivious.observer/posts/"},{"@type":"ListItem","position":3,"name":"NixOS encrypted VM installation","item":"https://oblivious.observer/posts/nixos-20.03-luks-zfs-kvm/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"NixOS encrypted VM installation","name":"NixOS encrypted VM installation","description":"In this post I\u0026rsquo;ll describe how to set up a sparse VM image with full disk encryption and NixOS on ZFS, which can be uploaded to a VPS provider and then unlocked on boot using ssh.\nFirst we need to create a virtual machine image file. Initially I tried using qemu-img, but somehow the image file was missing some information and the VM would not recognize a disk. Instead I went with the easy way and used virt-manager to create a new VM with the correct image size.","keywords":["NixOS","ZFS","LUKS","libguestfs","dropbear"],"articleBody":"In this post I’ll describe how to set up a sparse VM image with full disk encryption and NixOS on ZFS, which can be uploaded to a VPS provider and then unlocked on boot using ssh.\nFirst we need to create a virtual machine image file. Initially I tried using qemu-img, but somehow the image file was missing some information and the VM would not recognize a disk. Instead I went with the easy way and used virt-manager to create a new VM with the correct image size. virt-manager seems to create images allocated with the full size:\n$ ls -lh /var/lib/libvirt/images -rw------- 1 root root 161G Aug 24 08:59 nixosVM160GB.qcow2 -rw------- 1 root root 41G Aug 24 00:22 nixosVM40GB.qcow2 Uploading 200GB of mostly empty VM images can take quite a while, lets make them smaller using the wonderful libguestfs-tools.\n$ nix-shell -p libguestfs-with-appliance --run \"sudo virt-sparsify /var/lib/libvirt/images/nixosVM40GB.qcow2 \\ /var/lib/libvirt/images/nixosVM40GB-sparse.qcow2\" [ 0.1] Create overlay file in /tmp to protect source disk [ 0.1] Examine source disk [ 1.8] Copy to destination and make sparse [ 46.6] Sparsify operation completed with no errors. .virt-sparsify-wrapped: Before deleting the old disk, carefully check that the target disk boots and works correctly. $ nix-shell -p libguestfs-with-appliance --run \"sudo virt-sparsify /var/lib/libvirt/images/nixosVM160GB.qcow2 \\ /var/lib/libvirt/images/nixosVM160GB-sparse.qcow2\" [ 0.0] Create overlay file in /tmp to protect source disk [ 0.1] Examine source disk [ 1.6] Copy to destination and make sparse [ 172.0] Sparsify operation completed with no errors. .virt-sparsify-wrapped: Before deleting the old disk, carefully check that the target disk boots and works correctly. Now the files are considerably smaller:\n$ ls -lh /var/lib/libvirt/images -rw------- 1 root root 161G Aug 24 08:59 nixosVM160GB.qcow2 -rw-r--r-- 1 root root 195K Aug 28 16:13 nixosVM160GB-sparse.qcow2 -rw------- 1 root root 41G Aug 24 00:22 nixosVM40GB.qcow2 -rw-r--r-- 1 root root 193K Aug 28 16:11 nixosVM40GB-sparse.qcow2 Next install the VMs. In order to do so, create a new VM in virt-manager using the sparse image, add a CDROM type storage device with the NixOS install iso and set up the virtual machine to boot from this device.\nThe following script will create a virtual machine with the following partition layout, (I’m using ZFS inside lvm in this setup):\nsda ├─sda1 GRUB ├─sda2 BOOT └─sda3 LINUX (LUKS CONTAINER) └─cryptroot LUKS MAPPER └─lvmvg-swap SWAP └─lvmvg-root ZFS 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 #!/usr/bin/env bash set -e pprint () { local cyan=\"\\e[96m\" local default=\"\\e[39m\" # ISO8601 timestamp + ms local timestamp timestamp=$(date +%FT%T.%3NZ) echo -e \"${cyan}${timestamp} $1${default}\" 1\u003e\u00262 } echo \"These are the disks available:\" ls -l /dev/disk/by-id/ | awk '{print $11, $10, $9}' | tr -d './' | column -t echo # Set DISK select ENTRY in $(ls /dev/disk/by-id/); do echo $ENTRY DISK=\"/dev/disk/by-id/$ENTRY\" echo \"Installing system on $ENTRY.\" break done echo -n \"Enter Swap size (e.g. 10G, 5M)\" echo read SWAP_SIZE if [[ $SWAP_SIZE =~ ^[0-9]*(G|M)$ ]] then echo \"Swap size set to $SWAP_SIZE\" else echo \"Please enter correct size\" break fi read -p \"\u003e Do you want to wipe all data on $ENTRY ?\" -n 1 -r echo # move to a new line if [[ \"$REPLY\" =~ ^[Yy]$ ]] then # Clear disk wipefs -af \"$DISK\" sgdisk -Zo \"$DISK\" fi pprint \"Creating grub partition\" sgdisk -n 0:0:+1000K -t 1:EF02 \"$DISK\" GRUB=\"$DISK-part1\" pprint \"Creating boot partition\" sgdisk -n 0:0:+512M -t 0:EF00 \"$DISK\" BOOT=\"$DISK-part2\" pprint \"Creating Linux partition\" sgdisk -n 0:0:0 -t 3:8300 \"$DISK\" LINUX=\"$DISK-part3\" # Inform kernel partprobe \"$DISK\" sleep 1 pprint \"Format BOOT partition $BOOT\" mkfs.vfat \"$BOOT\" pprint \"Creating LUKS container on $LINUX\" cryptsetup --type luks2 luksFormat \"$LINUX\" LUKS_DEVICE_NAME=cryptroot cryptsetup luksOpen \"$LINUX\" \"$LUKS_DEVICE_NAME\" LUKS_DISK=\"/dev/mapper/$LUKS_DEVICE_NAME\" # Create LVM physical volume pvcreate $LUKS_DISK LVM_VOLUME_GROUP=vg0 vgcreate \"$LVM_VOLUME_GROUP\" \"$LUKS_DISK\" lvcreate --name swap --size $SWAP_SIZE \"$LVM_VOLUME_GROUP\" SWAP=\"/dev/$LVM_VOLUME_GROUP/swap\" pprint \"Enable SWAP on $SWAP\" mkswap $SWAP swapon $SWAP # ZFS partition lvcreate --name root --extents 100%FREE \"$LVM_VOLUME_GROUP\" ZFS=\"/dev/$LVM_VOLUME_GROUP/root\" pprint \"Create ZFS pool on $ZFS\" # -f force # -m mountpoint zpool create -f -m none -R /mnt rpool \"$ZFS\" pprint \"Create ZFS datasets\" zfs create -o mountpoint=legacy rpool/root zfs create -o mountpoint=legacy rpool/root/nix zfs create -o mountpoint=legacy rpool/home zfs set com.sun:auto-snapshot=true rpool/home zfs snapshot rpool/root@blank pprint \"Mount ZFS datasets\" mount -t zfs rpool/root /mnt mkdir /mnt/nix mount -t zfs rpool/root/nix /mnt/nix mkdir /mnt/home mount -t zfs rpool/home /mnt/home mkdir /mnt/boot mount \"$BOOT\" /mnt/boot pprint \"Generate NixOS configuration\" nixos-generate-config --root /mnt # Add LUKS and ZFS configuration HOSTID=$(head -c8 /etc/machine-id) LINUX_DISK_UUID=$(blkid --match-tag UUID --output value \"$LINUX\") HARDWARE_CONFIG=$(mktemp) cat \u003c \"$HARDWARE_CONFIG\" networking.hostId = \"$HOSTID\"; boot.initrd.luks.devices.\"$LUKS_DEVICE_NAME\".device = \"/dev/disk/by-uuid/$LINUX_DISK_UUID\"; boot.zfs.devNodes = \"$ZFS\"; CONFIG pprint \"Append configuration to hardware-configuration.nix\" sed -i \"\\$e cat $HARDWARE_CONFIG\" /mnt/etc/nixos/hardware-configuration.nix After running the script, create the dropbear ssh keys:\n$ nix-shell -p dropbear --command \"dropbearkey -t ecdsa -f /tmp/initrd-ssh-key\" Copy the key into / as well as /mnt (for some reason the installer seems to fail, when the keys aren’t found in /):\n$ sudo mkdir -p /var/dropbear /mnt/var/dropbear $ sudo cp /tmp/initrd-ssh-key /var/dropbear/ $ sudo cp /tmp/initrd-ssh-key /mnt/var/dropbear/ Add in the boot config:\nboot.loader.grub.device = \"/dev/sda\"; boot.initrd.network.enable = true; boot.initrd.network.ssh = { enable = true; port = 2222; authorizedKeys = [ \"ssh-rsa ...\" ]; \u003c-------- this is your list of ssh keys, which are allowed to log in hostECDSAKey = /var/dropbear/initrd-ssh-key; }; boot.initrd.network.postCommands = '' echo \"cryptsetup-askpass\" \u003e\u003e /root/.profile ''; Finally the VM has to be able to connect to the network, so the initramdisk needs to have the correct kernel modules available. It is possible to find out which kernel modules are necessary for a specific provider by simply launching a VM and looking at lsmod or clicking through the VM configuration and looking for a section on virtualisation drivers.\nboot.initrd.availableKernelModules = [ \"e1000e\" \"virtio_pci\" \"e1000\" ]; Finally install nixos using nixos-install and reboot.\nUsing different entries in ~/.ssh/config can make rebooting and decrypting the luks devices easier:\nHost vm Hostname 1.2.3.4 User user Host unlock.vm Hostname 1.2.3.4 User root Port 2222 This way there won’t be any key conflicts and you can conveniently unlock the VMs using:\n$ ssh unlock.vm # alternatively use: ssh -p 2222 root@192.168.122.x The authenticity of host '[192.168.122.x]:2222 ([192.168.122.x]:2222)' can't be established. ECDSA key fingerprint is SHA256:... Are you sure you want to continue connecting (yes/no/[fingerprint])? yes Warning: Permanently added '[192.168.122.x]:2222' (ECDSA) to the list of known hosts. Passphrase for /dev/disk/by-uuid/...: ********************************* Waiting 10 seconds for LUKS to request a passphrase.......Connection to 192.168.122.x closed by remote host. Connection to 192.168.122.x closed. After installation these are the file sizes:\n$ sudo ls -lh /var/lib/libvirt/images/ -rw-r--r-- 1 root root 195K Aug 28 16:54 160GB-sparse-disk-template.qcow2 -rw-r--r-- 1 root root 193K Jul 31 18:36 20GB-sparse-disk-template.qcow2 -rw-r--r-- 1 root root 193K Aug 28 16:54 40GB-sparse-disk-template.qcow2 -rw------- 1 root root 161G Aug 24 08:59 nixosVM160GB.qcow2 -rw-r--r-- 1 root root 1.9G Aug 29 14:11 nixosVM160GB-sparse.qcow2 -rw------- 1 root root 41G Aug 24 00:22 nixosVM40GB.qcow2 -rw-r--r-- 1 root root 2.0G Aug 29 14:01 nixosVM40GB-sparse.qcow2 ","wordCount":"1250","inLanguage":"en","datePublished":"2020-08-29T00:00:00+02:00","dateModified":"2020-08-29T00:00:00+02:00","author":[{"@type":"Person","name":"oblivious observer"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://oblivious.observer/posts/nixos-20.03-luks-zfs-kvm/"},"publisher":{"@type":"Organization","name":"oblivious observer","logo":{"@type":"ImageObject","url":"https://oblivious.observer/observer-16x16.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://oblivious.observer accesskey=h title="  (Alt + H)"><img src=https://oblivious.observer/observer-64x64.png alt aria-label=logo height=35></a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://oblivious.observer/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://oblivious.observer/posts/ title=posts><span>posts</span></a></li><li><a href=https://oblivious.observer/archives/ title=archive><span>archive</span></a></li><li><a href=https://oblivious.observer/tags/ title=tags><span>tags</span></a></li><li><a href=https://oblivious.observer/index.html title=about><span>about</span></a></li><li><a href=https://oblivious.observer/index.xml title=rss><span>rss</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>NixOS encrypted VM installation</h1><div class=post-meta><span title='2020-08-29 00:00:00 +0200 CEST'>August 29, 2020</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;oblivious observer</div></header><div class=post-content><p>In this post I&rsquo;ll describe how to set up a sparse VM image with full disk
encryption and NixOS on ZFS, which can be uploaded to a VPS provider and
then unlocked on boot using ssh.</p><p>First we need to create a virtual machine image file. Initially I tried using
<code>qemu-img</code>, but somehow the image file was missing some information and the VM
would not recognize a disk. Instead I went with the easy way and used
<code>virt-manager</code> to create a new VM with the correct image size. <code>virt-manager</code>
seems to create images allocated with the full size:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ls -lh /var/lib/libvirt/images
</span></span><span style=display:flex><span>-rw------- <span style=color:#bd93f9>1</span> root root  161G Aug <span style=color:#bd93f9>24</span> 08:59 nixosVM160GB.qcow2
</span></span><span style=display:flex><span>-rw------- <span style=color:#bd93f9>1</span> root root   41G Aug <span style=color:#bd93f9>24</span> 00:22 nixosVM40GB.qcow2
</span></span></code></pre></div><p>Uploading 200GB of mostly empty VM images can take quite a while, lets make them
smaller using the wonderful <code>libguestfs-tools</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ nix-shell -p libguestfs-with-appliance --run <span style=color:#f1fa8c>&#34;sudo virt-sparsify /var/lib/libvirt/images/nixosVM40GB.qcow2 \
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  /var/lib/libvirt/images/nixosVM40GB-sparse.qcow2&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>   0.1<span style=color:#ff79c6>]</span> Create overlay file in /tmp to protect <span style=color:#8be9fd;font-style:italic>source</span> disk
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>   0.1<span style=color:#ff79c6>]</span> Examine <span style=color:#8be9fd;font-style:italic>source</span> disk
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>   1.8<span style=color:#ff79c6>]</span> Copy to destination and make sparse
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>  46.6<span style=color:#ff79c6>]</span> Sparsify operation completed with no errors.
</span></span><span style=display:flex><span>.virt-sparsify-wrapped: Before deleting the old disk, carefully check that
</span></span><span style=display:flex><span>the target disk boots and works correctly.
</span></span><span style=display:flex><span>$ nix-shell -p libguestfs-with-appliance --run <span style=color:#f1fa8c>&#34;sudo virt-sparsify /var/lib/libvirt/images/nixosVM160GB.qcow2 \
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  /var/lib/libvirt/images/nixosVM160GB-sparse.qcow2&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>   0.0<span style=color:#ff79c6>]</span> Create overlay file in /tmp to protect <span style=color:#8be9fd;font-style:italic>source</span> disk
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>   0.1<span style=color:#ff79c6>]</span> Examine <span style=color:#8be9fd;font-style:italic>source</span> disk
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>   1.6<span style=color:#ff79c6>]</span> Copy to destination and make sparse
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span> 172.0<span style=color:#ff79c6>]</span> Sparsify operation completed with no errors.
</span></span><span style=display:flex><span>.virt-sparsify-wrapped: Before deleting the old disk, carefully check that
</span></span><span style=display:flex><span>the target disk boots and works correctly.
</span></span></code></pre></div><p>Now the files are considerably smaller:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ls -lh /var/lib/libvirt/images
</span></span><span style=display:flex><span>-rw------- <span style=color:#bd93f9>1</span> root root  161G Aug <span style=color:#bd93f9>24</span> 08:59 nixosVM160GB.qcow2
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#bd93f9>1</span> root root  195K Aug <span style=color:#bd93f9>28</span> 16:13 nixosVM160GB-sparse.qcow2
</span></span><span style=display:flex><span>-rw------- <span style=color:#bd93f9>1</span> root root   41G Aug <span style=color:#bd93f9>24</span> 00:22 nixosVM40GB.qcow2
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#bd93f9>1</span> root root  193K Aug <span style=color:#bd93f9>28</span> 16:11 nixosVM40GB-sparse.qcow2
</span></span></code></pre></div><p>Next install the VMs. In order to do so, create a new VM in virt-manager using
the sparse image, add a CDROM type storage device with the NixOS install iso and
set up the virtual machine to boot from this device.</p><p>The following script will create a virtual machine with the following partition
layout, (I&rsquo;m using ZFS inside lvm in this setup):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>sda
</span></span><span style=display:flex><span>├─sda1            GRUB
</span></span><span style=display:flex><span>├─sda2            BOOT
</span></span><span style=display:flex><span>└─sda3            LINUX (LUKS CONTAINER)
</span></span><span style=display:flex><span>  └─cryptroot     LUKS MAPPER
</span></span><span style=display:flex><span>    └─lvmvg-swap  SWAP
</span></span><span style=display:flex><span>    └─lvmvg-root  ZFS
</span></span></code></pre></div><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">125
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">126
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">127
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">128
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">129
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">130
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">131
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">132
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">133
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff79c6>#!/usr/bin/env bash
</span></span></span><span style=display:flex><span><span style=color:#ff79c6></span><span style=color:#8be9fd;font-style:italic>set</span> -e
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pprint <span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>local</span> <span style=color:#8be9fd;font-style:italic>cyan</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;\e[96m&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>local</span> <span style=color:#8be9fd;font-style:italic>default</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;\e[39m&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4># ISO8601 timestamp + ms</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>local</span> timestamp
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>timestamp</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>date +%FT%T.%3NZ<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>echo</span> -e <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>cyan</span><span style=color:#f1fa8c>}${</span><span style=color:#8be9fd;font-style:italic>timestamp</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c> </span><span style=color:#8be9fd;font-style:italic>$1</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>default</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span> 1&gt;&amp;<span style=color:#bd93f9>2</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;These are the disks available:&#34;</span>
</span></span><span style=display:flex><span>ls -l /dev/disk/by-id/ | awk <span style=color:#f1fa8c>&#39;{print $11, $10, $9}&#39;</span> | tr -d <span style=color:#f1fa8c>&#39;./&#39;</span> | column -t
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>echo</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># Set DISK</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>select</span> ENTRY in <span style=color:#ff79c6>$(</span>ls /dev/disk/by-id/<span style=color:#ff79c6>)</span>;
</span></span><span style=display:flex><span><span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#8be9fd;font-style:italic>$ENTRY</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>DISK</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;/dev/disk/by-id/</span><span style=color:#8be9fd;font-style:italic>$ENTRY</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;Installing system on </span><span style=color:#8be9fd;font-style:italic>$ENTRY</span><span style=color:#f1fa8c>.&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>break</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>done</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>echo</span> -n <span style=color:#f1fa8c>&#34;Enter Swap size (e.g. 10G, 5M)&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>echo</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>read</span> SWAP_SIZE
</span></span><span style=display:flex><span><span style=color:#ff79c6>if</span> <span style=color:#ff79c6>[[</span> <span style=color:#8be9fd;font-style:italic>$SWAP_SIZE</span> <span style=color:#ff79c6>=</span>~ ^<span style=color:#ff79c6>[</span>0-9<span style=color:#ff79c6>]</span>*<span style=color:#ff79c6>(</span>G|M<span style=color:#ff79c6>)</span>$ <span style=color:#ff79c6>]]</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>then</span>
</span></span><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;Swap size set to </span><span style=color:#8be9fd;font-style:italic>$SWAP_SIZE</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>else</span>
</span></span><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;Please enter correct size&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>break</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>read</span> -p <span style=color:#f1fa8c>&#34;&gt; Do you want to wipe all data on </span><span style=color:#8be9fd;font-style:italic>$ENTRY</span><span style=color:#f1fa8c> ?&#34;</span> -n <span style=color:#bd93f9>1</span> -r
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#6272a4># move to a new line</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>if</span> <span style=color:#ff79c6>[[</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$REPLY</span><span style=color:#f1fa8c>&#34;</span> <span style=color:#ff79c6>=</span>~ ^<span style=color:#ff79c6>[</span>Yy<span style=color:#ff79c6>]</span>$ <span style=color:#ff79c6>]]</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>then</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4># Clear disk</span>
</span></span><span style=display:flex><span>    wipefs -af <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$DISK</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>    sgdisk -Zo <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$DISK</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pprint <span style=color:#f1fa8c>&#34;Creating grub partition&#34;</span>
</span></span><span style=display:flex><span>sgdisk -n 0:0:+1000K    -t 1:EF02 <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$DISK</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>GRUB</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$DISK</span><span style=color:#f1fa8c>-part1&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pprint <span style=color:#f1fa8c>&#34;Creating boot partition&#34;</span>
</span></span><span style=display:flex><span>sgdisk -n 0:0:+512M -t 0:EF00 <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$DISK</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>BOOT</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$DISK</span><span style=color:#f1fa8c>-part2&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pprint <span style=color:#f1fa8c>&#34;Creating Linux partition&#34;</span>
</span></span><span style=display:flex><span>sgdisk -n 0:0:0 -t 3:8300 <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$DISK</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>LINUX</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$DISK</span><span style=color:#f1fa8c>-part3&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># Inform kernel</span>
</span></span><span style=display:flex><span>partprobe <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$DISK</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>sleep <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pprint <span style=color:#f1fa8c>&#34;Format BOOT partition </span><span style=color:#8be9fd;font-style:italic>$BOOT</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>mkfs.vfat <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$BOOT</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pprint <span style=color:#f1fa8c>&#34;Creating LUKS container on </span><span style=color:#8be9fd;font-style:italic>$LINUX</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>cryptsetup --type luks2 luksFormat <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$LINUX</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>LUKS_DEVICE_NAME</span><span style=color:#ff79c6>=</span>cryptroot
</span></span><span style=display:flex><span>cryptsetup luksOpen <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$LINUX</span><span style=color:#f1fa8c>&#34;</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$LUKS_DEVICE_NAME</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>LUKS_DISK</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;/dev/mapper/</span><span style=color:#8be9fd;font-style:italic>$LUKS_DEVICE_NAME</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># Create LVM physical volume</span>
</span></span><span style=display:flex><span>pvcreate <span style=color:#8be9fd;font-style:italic>$LUKS_DISK</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>LVM_VOLUME_GROUP</span><span style=color:#ff79c6>=</span>vg0
</span></span><span style=display:flex><span>vgcreate <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$LVM_VOLUME_GROUP</span><span style=color:#f1fa8c>&#34;</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$LUKS_DISK</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>lvcreate --name swap --size <span style=color:#8be9fd;font-style:italic>$SWAP_SIZE</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$LVM_VOLUME_GROUP</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>SWAP</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;/dev/</span><span style=color:#8be9fd;font-style:italic>$LVM_VOLUME_GROUP</span><span style=color:#f1fa8c>/swap&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pprint <span style=color:#f1fa8c>&#34;Enable SWAP on </span><span style=color:#8be9fd;font-style:italic>$SWAP</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>mkswap <span style=color:#8be9fd;font-style:italic>$SWAP</span>
</span></span><span style=display:flex><span>swapon <span style=color:#8be9fd;font-style:italic>$SWAP</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># ZFS partition</span>
</span></span><span style=display:flex><span>lvcreate --name root --extents 100%FREE <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$LVM_VOLUME_GROUP</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>ZFS</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;/dev/</span><span style=color:#8be9fd;font-style:italic>$LVM_VOLUME_GROUP</span><span style=color:#f1fa8c>/root&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pprint <span style=color:#f1fa8c>&#34;Create ZFS pool on </span><span style=color:#8be9fd;font-style:italic>$ZFS</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># -f force</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># -m mountpoint</span>
</span></span><span style=display:flex><span>zpool create -f -m none -R /mnt rpool <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$ZFS</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pprint <span style=color:#f1fa8c>&#34;Create ZFS datasets&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>zfs create -o <span style=color:#8be9fd;font-style:italic>mountpoint</span><span style=color:#ff79c6>=</span>legacy rpool/root
</span></span><span style=display:flex><span>zfs create -o <span style=color:#8be9fd;font-style:italic>mountpoint</span><span style=color:#ff79c6>=</span>legacy rpool/root/nix
</span></span><span style=display:flex><span>zfs create -o <span style=color:#8be9fd;font-style:italic>mountpoint</span><span style=color:#ff79c6>=</span>legacy rpool/home
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>zfs <span style=color:#8be9fd;font-style:italic>set</span> com.sun:auto-snapshot<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>true</span> rpool/home
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>zfs snapshot rpool/root@blank
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pprint <span style=color:#f1fa8c>&#34;Mount ZFS datasets&#34;</span>
</span></span><span style=display:flex><span>mount -t zfs rpool/root /mnt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mkdir /mnt/nix
</span></span><span style=display:flex><span>mount -t zfs rpool/root/nix /mnt/nix
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mkdir /mnt/home
</span></span><span style=display:flex><span>mount -t zfs rpool/home /mnt/home
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mkdir /mnt/boot
</span></span><span style=display:flex><span>mount <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$BOOT</span><span style=color:#f1fa8c>&#34;</span> /mnt/boot
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pprint <span style=color:#f1fa8c>&#34;Generate NixOS configuration&#34;</span>
</span></span><span style=display:flex><span>nixos-generate-config --root /mnt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># Add LUKS and ZFS configuration</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>HOSTID</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>head -c8 /etc/machine-id<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>LINUX_DISK_UUID</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>blkid --match-tag UUID --output value <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$LINUX</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>HARDWARE_CONFIG</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>mktemp<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>cat <span style=color:#f1fa8c>&lt;&lt;CONFIG &gt; &#34;$HARDWARE_CONFIG</span><span style=color:#f1fa8c>&#34;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  networking.hostId = &#34;</span><span style=color:#8be9fd;font-style:italic>$HOSTID</span><span style=color:#f1fa8c>&#34;;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  boot.initrd.luks.devices.&#34;</span><span style=color:#8be9fd;font-style:italic>$LUKS_DEVICE_NAME</span><span style=color:#f1fa8c>&#34;.device = &#34;</span>/dev/disk/by-uuid/<span style=color:#8be9fd;font-style:italic>$LINUX_DISK_UUID</span><span style=color:#f1fa8c>&#34;;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  boot.zfs.devNodes = &#34;</span><span style=color:#8be9fd;font-style:italic>$ZFS</span><span style=color:#f1fa8c>&#34;;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>CONFIG
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>pprint &#34;</span>Append configuration to hardware-configuration.nix<span style=color:#f1fa8c>&#34;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>sed -i &#34;</span><span style=color:#f1fa8c>\$</span>e cat <span style=color:#8be9fd;font-style:italic>$HARDWARE_CONFIG</span><span style=color:#f1fa8c>&#34; /mnt/etc/nixos/hardware-configuration.nix</span></span></span></code></pre></td></tr></table></div></div><p>After running the script, create the dropbear ssh keys:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ nix-shell -p dropbear --command <span style=color:#f1fa8c>&#34;dropbearkey -t ecdsa -f /tmp/initrd-ssh-key&#34;</span>
</span></span></code></pre></div><p>Copy the key into <code>/</code> as well as <code>/mnt</code> (for some reason the installer seems to
fail, when the keys aren&rsquo;t found in <code>/</code>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo mkdir -p /var/dropbear /mnt/var/dropbear
</span></span><span style=display:flex><span>$ sudo cp /tmp/initrd-ssh-key /var/dropbear/
</span></span><span style=display:flex><span>$ sudo cp /tmp/initrd-ssh-key /mnt/var/dropbear/
</span></span></code></pre></div><p>Add in the boot config:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>  boot<span style=color:#ff79c6>.</span>loader<span style=color:#ff79c6>.</span>grub<span style=color:#ff79c6>.</span>device = <span style=color:#f1fa8c>&#34;/dev/sda&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  boot<span style=color:#ff79c6>.</span>initrd<span style=color:#ff79c6>.</span>network<span style=color:#ff79c6>.</span>enable = true;
</span></span><span style=display:flex><span>  boot<span style=color:#ff79c6>.</span>initrd<span style=color:#ff79c6>.</span>network<span style=color:#ff79c6>.</span>ssh = {
</span></span><span style=display:flex><span>    enable <span style=color:#ff79c6>=</span> true;
</span></span><span style=display:flex><span>    port <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>2222</span>;
</span></span><span style=display:flex><span>    authorizedKeys <span style=color:#ff79c6>=</span> [ <span style=color:#f1fa8c>&#34;ssh-rsa ...&#34;</span> ];   <span style=color:#ff79c6>&lt;</span>-------- this is your list of ssh keys<span style=color:#ff79c6>,</span> which are allowed to log <span style=color:#ff79c6>in</span>
</span></span><span style=display:flex><span>    hostECDSAKey = <span style=color:#f1fa8c>/var/dropbear/initrd-ssh-key</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  boot<span style=color:#ff79c6>.</span>initrd<span style=color:#ff79c6>.</span>network<span style=color:#ff79c6>.</span>postCommands = <span style=color:#f1fa8c>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    echo &#34;cryptsetup-askpass&#34; &gt;&gt; /root/.profile
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  &#39;&#39;</span>;
</span></span></code></pre></div><p>Finally the VM has to be able to connect to the network, so the initramdisk
needs to have the correct kernel modules available. It is possible to find out
which kernel modules are necessary for a specific provider by simply launching a
VM and looking at <code>lsmod</code> or clicking through the VM configuration and looking
for a section on virtualisation drivers.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>  boot<span style=color:#ff79c6>.</span>initrd<span style=color:#ff79c6>.</span>availableKernelModules = [ <span style=color:#f1fa8c>&#34;e1000e&#34;</span> <span style=color:#f1fa8c>&#34;virtio_pci&#34;</span> <span style=color:#f1fa8c>&#34;e1000&#34;</span> ];
</span></span></code></pre></div><p>Finally install nixos using <code>nixos-install</code> and reboot.</p><p>Using different entries in <code>~/.ssh/config</code> can make rebooting and decrypting the luks devices easier:</p><pre tabindex=0><code class=language-conf data-lang=conf>Host vm
  Hostname 1.2.3.4
  User user

Host unlock.vm
  Hostname 1.2.3.4
  User root
  Port 2222
</code></pre><p>This way there won&rsquo;t be any key conflicts and you can conveniently unlock the VMs using:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ssh unlock.vm <span style=color:#6272a4># alternatively use: ssh -p 2222 root@192.168.122.x</span>
</span></span><span style=display:flex><span>The authenticity of host <span style=color:#f1fa8c>&#39;[192.168.122.x]:2222 ([192.168.122.x]:2222)&#39;</span> can<span style=color:#f1fa8c>&#39;t be established.
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>ECDSA key fingerprint is SHA256:...
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>Warning: Permanently added &#39;</span><span style=color:#ff79c6>[</span>192.168.122.x<span style=color:#ff79c6>]</span>:2222&#39; <span style=color:#ff79c6>(</span>ECDSA<span style=color:#ff79c6>)</span> to the list of known hosts.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Passphrase <span style=color:#ff79c6>for</span> /dev/disk/by-uuid/...: *********************************
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Waiting <span style=color:#bd93f9>10</span> seconds <span style=color:#ff79c6>for</span> LUKS to request a passphrase.......Connection to 192.168.122.x closed by remote host.
</span></span><span style=display:flex><span>Connection to 192.168.122.x closed.
</span></span></code></pre></div><p>After installation these are the file sizes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo ls -lh /var/lib/libvirt/images/
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#bd93f9>1</span> root root  195K Aug <span style=color:#bd93f9>28</span> 16:54 160GB-sparse-disk-template.qcow2
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#bd93f9>1</span> root root  193K Jul <span style=color:#bd93f9>31</span> 18:36 20GB-sparse-disk-template.qcow2
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#bd93f9>1</span> root root  193K Aug <span style=color:#bd93f9>28</span> 16:54 40GB-sparse-disk-template.qcow2
</span></span><span style=display:flex><span>-rw------- <span style=color:#bd93f9>1</span> root root  161G Aug <span style=color:#bd93f9>24</span> 08:59 nixosVM160GB.qcow2
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#bd93f9>1</span> root root  1.9G Aug <span style=color:#bd93f9>29</span> 14:11 nixosVM160GB-sparse.qcow2
</span></span><span style=display:flex><span>-rw------- <span style=color:#bd93f9>1</span> root root   41G Aug <span style=color:#bd93f9>24</span> 00:22 nixosVM40GB.qcow2
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#bd93f9>1</span> root root  2.0G Aug <span style=color:#bd93f9>29</span> 14:01 nixosVM40GB-sparse.qcow2
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://oblivious.observer/tags/nixos/>NixOS</a></li><li><a href=https://oblivious.observer/tags/zfs/>ZFS</a></li><li><a href=https://oblivious.observer/tags/luks/>LUKS</a></li><li><a href=https://oblivious.observer/tags/libguestfs/>libguestfs</a></li><li><a href=https://oblivious.observer/tags/dropbear/>dropbear</a></li></ul></footer><script src=https://utteranc.es/client.js repo=observer/observer.github.io issue-term=url label=💬 theme=photon-dark crossorigin=anonymous async></script></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>