<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Introducing a Boot Environment Manager for Proxmox | oblivious observer</title><meta name=keywords content="proxmox,ZFS,systemd-boot,beadm"><meta name=description content="This post introduces a fork of the FreeBSD beadm utility which can be used to manage Boot Environments on Proxmox ZFS Installations.
In this Post I will showcase how to use the beadm Boot Environment manager in Proxmox. After the showcase there are some notes on what I did to make beadm run on Linux in general and finally a part about what has been changed in order to make beadm work with Proxmox specifically."><meta name=author content="oblivious observer"><link rel=canonical href=https://oblivious.observer/posts/proxmoxve6-boot-environment-manager/><link crossorigin=anonymous href=/assets/css/stylesheet.dc96e9e0118e5e264a03d68b104df6ae869cfb73c61f5f89dd91aeb16b0d8c03.css integrity="sha256-3Jbp4BGOXiZKA9aLEE32roac+3PGH1+J3ZGusWsNjAM=" rel="preload stylesheet" as=style><link rel=icon href=https://oblivious.observer/observer-16x16.png><link rel=icon type=image/png sizes=16x16 href=https://oblivious.observer/observer-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://oblivious.observer/observer-32x32.png><link rel=apple-touch-icon href=https://oblivious.observer/observer-512x512.png><link rel=mask-icon href=https://oblivious.observer/observer-512x512.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://oblivious.observer/css/syntax.css><meta property="og:title" content="Introducing a Boot Environment Manager for Proxmox"><meta property="og:description" content="This post introduces a fork of the FreeBSD beadm utility which can be used to manage Boot Environments on Proxmox ZFS Installations.
In this Post I will showcase how to use the beadm Boot Environment manager in Proxmox. After the showcase there are some notes on what I did to make beadm run on Linux in general and finally a part about what has been changed in order to make beadm work with Proxmox specifically."><meta property="og:type" content="article"><meta property="og:url" content="https://oblivious.observer/posts/proxmoxve6-boot-environment-manager/"><meta property="og:image" content="https://oblivious.observer/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-10-29T00:00:00+01:00"><meta property="article:modified_time" content="2019-10-29T00:00:00+01:00"><meta property="og:site_name" content="oblivious.observer"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://oblivious.observer/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Introducing a Boot Environment Manager for Proxmox"><meta name=twitter:description content="This post introduces a fork of the FreeBSD beadm utility which can be used to manage Boot Environments on Proxmox ZFS Installations.
In this Post I will showcase how to use the beadm Boot Environment manager in Proxmox. After the showcase there are some notes on what I did to make beadm run on Linux in general and finally a part about what has been changed in order to make beadm work with Proxmox specifically."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://oblivious.observer/posts/"},{"@type":"ListItem","position":3,"name":"Introducing a Boot Environment Manager for Proxmox","item":"https://oblivious.observer/posts/proxmoxve6-boot-environment-manager/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Introducing a Boot Environment Manager for Proxmox","name":"Introducing a Boot Environment Manager for Proxmox","description":"This post introduces a fork of the FreeBSD beadm utility which can be used to manage Boot Environments on Proxmox ZFS Installations.\nIn this Post I will showcase how to use the beadm Boot Environment manager in Proxmox. After the showcase there are some notes on what I did to make beadm run on Linux in general and finally a part about what has been changed in order to make beadm work with Proxmox specifically.","keywords":["proxmox","ZFS","systemd-boot","beadm"],"articleBody":"This post introduces a fork of the FreeBSD beadm utility which can be used to manage Boot Environments on Proxmox ZFS Installations.\nIn this Post I will showcase how to use the beadm Boot Environment manager in Proxmox. After the showcase there are some notes on what I did to make beadm run on Linux in general and finally a part about what has been changed in order to make beadm work with Proxmox specifically.\nThe version of beadm that is compatible with Proxmox can be found on github.\nOverview Introduction Managing Boot Environments in Proxmox Making beadm work under Linux Making beadm work with Proxmox Conclusion and Further Work Introduction In my previous post I’ve already outlined how boot environments work in general, how you can make them work under Proxmox VE 6 and presented a Proof of Concept solution of how they can be set up programmatically using zedenv, a python-based manager for Boot Environments.\nSince my last post I’ve taken a bit of a closer look at both the code of zedenv as well as beadm and decided to fork the latter and make it work with Proxmox.\nWhile this is still a Proof of Concept, it can be simply plugged into an existing Proxmox ZFS installation in order to enable and manage Boot Environments.\nAs with the previous PoC, I’ve written the code in such a way that no parts of Proxmox have been changed. Apart from some additional files that are created, your system stays as it is, also all Boot Entries created by Proxmox are still available in parallel to the Boot Environment entries in your bootloader.\nSince the last post I’ve simply reinstalled Proxmox with 10GB ESPs on both of my system drives, so I have enough space to store more Boot Environments. In order to install with a bigger ESP, install the system with custom (smaller) ZFS partition size, then after the installation, remove a drive from your ZFS pool, delete the ZFS partition, resize the ESP, create a new ZFS partition, add it back to the pool, resilver and repeat these steps for the second drive.\nManaging Boot Environments in Proxmox In order to use beadm with Proxmox you can grab a copy from github, make it executable and start using it right away. I do strongly encurage you to either use a test installation or look at the code and read through this post and the previous one first, so you know what is going on.\nOn the first run you’ll see the following error message, read it, create the template file and you are good to go (also remember that from now on, any changes to the cmdline file should be made to the template file instead, because the cmdline file will be autogenerated):\nroot@caliban:~# ./beadm ERROR: /etc/kernel/cmdline.template not found! You need a template file for the kernel commandline. The template file has to be identical to the /etc/kernel/cmdline file, but instead of a specific root it must contain the string \"__BE_NAME\" The template file is used in order to create a valid kernel commandline for systemd-boot, which points to the correct boot environment. In order to use beadm, create a valid /etc/kernel/cmdline.template Example: if your /etc/kernel/cmdline looks like this: root=ZFS=rpool/ROOT/pve-1 boot=zfs then the template file should contain: root=ZFS=rpool/ROOT/__BE_NAME boot=zfs After that you can list your boot environments with:\nroot@caliban:~# ./beadm list Boot Environments on caliban: name state used ds snaps ubrr refs creation date origin ---- ----- ---- -- ----- ---- ---- --------------------- ------ pve-1 NR 1.20G 1.15G 44.8M 0B 1.15G Sun Sep 1 17:08 2019 - At this point you don’t have a pve-1 Boot Environment, because the file structure of the ESPs is currently just pointing to the default Proxmox config. For the pve-1 dataset (or any dataset you create by hand) we can create the necessary files with the init command:\nroot@caliban:~# ./beadm init pve-1 Boot Environment for pve-1 has been generated successfully! Now you can create a new Boot Environment using create:\nroot@caliban:~# ./beadm init pve-2 Running hook script 'pve-auto-removal'.. Running hook script 'zz-pve-efiboot'.. Re-executing '/etc/kernel/postinst.d/zz-pve-efiboot' in new private mount namespace.. Copying and configuring kernels on /dev/disk/by-uuid/XXXX-XXXX Copying kernel and creating boot-entry for 5.0.15-1-pve Copying kernel and creating boot-entry for 5.0.21-1-pve Copying and configuring kernels on /dev/disk/by-uuid/YYYY-YYYY Copying kernel and creating boot-entry for 5.0.15-1-pve Copying kernel and creating boot-entry for 5.0.21-1-pve Created successfully Now we have a second Boot Environment, but it is not active. As you can see right now (N) pve-1 is active and after the next reboot (R) pve-1 will be active again:\nroot@caliban:~# ./beadm list Boot Environments on caliban: name state used ds snaps ubrr refs creation date origin ---- ----- ---- -- ----- ---- ---- --------------------- ------ pve-1 NR 1.20G 1.15G 44.8M 0B 1.15G Sun Sep 1 17:08 2019 - pve-2 - 8K 8K 0B 0B 1.15G Sun Oct 6 14:12 2019 rpool/ROOT/pve-1@2019-10-06-11:36:14 In order to activate the Boot Environment, run:\nroot@caliban:~# ./beadm activate pve-2 pve-2 has been activated successfully Now you can see that the Boot Environment will be active after a reboot:\nroot@caliban:~# ./beadm list Boot Environments on caliban: name state used ds snaps ubrr refs creation date origin ---- ----- ---- -- ----- ---- ---- --------------------- ------ pve-1 N 1.20G 1.15G 44.8M 0B 1.15G Sun Sep 1 17:08 2019 - pve-2 R 8K 8K 0B 0B 1.15G Sun Oct 6 14:12 2019 rpool/ROOT/pve-1@2019-10-06-11:36:14 If you don’t like the name, you can rename pve-2 with:\nroot@caliban:~# ./beadm rename pve-2 pve-002 root@caliban:~# ./beadm list Boot Environments on caliban: name state used ds snaps ubrr refs creation date origin ---- ----- ---- -- ----- ---- ---- --------------------- ------ pve-1 N 1.20G 1.15G 44.8M 0B 1.15G Sun Sep 1 17:08 2019 - pve-002 R 8K 8K 0B 0B 1.15G Sun Oct 6 14:12 2019 rpool/ROOT/pve-1@2019-10-06-11:36:14 You can also mount Boot Environments:\nroot@caliban:~# ls beadm root@caliban:~# ./beadm mount pve-002 mountpoint Mounted successfully on 'mountpoint' root@caliban:~# ls beadm mountpoint root@caliban:~# ls mountpoint/ bin boot dev etc home lib lib32 lib64 libx32 media mnt opt proc root rpool run sbin srv sys tmp usr var root@caliban:~# ./beadm umount pve-002 Unmounted successfully root@caliban:~# ls beadm mountpoint root@caliban:~# rmdir mountpoint If you reboot, you should be booting into the active Boot Environment. Install something (e.g. htop), open it, then use beadm to activate the previous Boot Environment, reboot and notice how the program you’ve just installed has dissapeared, because you just went back in time.\nIf you plan on setting up your Proxmox host with Boot Environments, don’t forget to make sure you have your ZFS datasets set up properly, I’ve written about that in my previous post.\nMaking beadm work under Linux This part contains notes about which parts of the original beadm I changed to make it work on linux. You can skip this part if you don’t care about the details that are not specific to Proxmox.\nbeadm is originally a Boot Environment manager for FreeBSD by vermaden. It is written in shell and enables you to create new Boot Environments or create them from ZFS snapshots, to activate, rename or destroy Boot Environments, list them and also mount and unmount them:\nroot@caliban:~# beadm usage: beadm activate beadm create [-e nonActiveBe | -e beName@snapshot] beadm create beadm destroy [-F] beadm list [-a] [-s] [-D] [-H] beadm rename beadm mount [mountpoint] beadm { umount | unmount } [-f] beadm version The script was originally about 900 LOC long and consisted of a bunch of helper functions followed by a big case statement, which takes care of running the code specific to the supplied parameter.\nAfter applying the following changes, apart from setting up the boot loader specific stuff, beadm should work on linux:\nRemoving the bootloader specific code Apart from managing the ZFS part it also takes care of managing FreeBSDs own bootloader or optionally grub2. I basically just removed these FreeBSD specific parts.\nReplacing the awk code of the list command The list section of the script also contains a rather large piece of awk code for displaying the available/active Boot Environments. I’ve replaced this part with shell, because I’m not yet familiar enough with awk to use it inside of a script. Therefore the new list command is probably a bit simpler than it’s FreeBSD parent. I also made sure that the correct next boot environment is marked, by looking into the content of /etc/kernel/cmdline.\nReplace FreeBSD date with it’s Linux counterpart For the destroy operation I had to replace the line containing the date command, since FreeBSDs date supports the -f option, while the linux date command does not.\nMissing -u Parameter in the Linux ZFS Implementation The rename operation uses the zfs rename with the -u parameter. This parameter does not exist in linux and according to the FreeBSD man-page, it makes sure that filesystems are not remounted during the rename operation:\n-u Do not remount file systems during rename. If a file system's mountpoint property is set to legacy or none, file system is not unmounted even if this option is not given. Mounting ZFS datasets under Linux In order to make the mount operation work, the -o zfsutil option had to be applied to the zfs mount command.\nZFS automount with systemd As I worked on the linux version of beadm, I also noticed that apart from making sure all the ESPs are working as intended, when booting into a new Boot environment, only / was mounted.\nThis was due to the systemd zfs-mount service not running. This service makes sure that all the zfs datasets are mounted on boot, but was failing to execute zfs mount -a, because there is more than one dataset that should be mounted to /.\nIn order to fix this, we can use the canmount option and set it to off for all Boot Environments:\ncanmount=on | off | noauto If this property is set to off, the file system cannot be mounted, and is ignored by zfs mount -a. Setting this property to off is similar to setting the mountpoint property to none, except that the dataset still has a normal mountpoint property, which can be inherited. Setting this property to off allows datasets to be used solely as a mechanism to inherit properties. One example of setting canmount=off is to have two datasets with the same mountpoint, so that the children of both datasets appear in the same directory, but might have different inherited characteristics. When the noauto option is set, a dataset can only be mounted and unmounted explicitly. The dataset is not mounted automatically when the dataset is created or imported, nor is it mounted by the zfs mount -a command or unmounted by the zfs unmount -a command. This property is not inherited. Making beadm work with Proxmox This part describes the changes I made to beadm that were Proxmox specific.\nIn my last post I described that the content of the Boot Environments could be housed in a ZFS dataset and then copied over to the ESPs (EFI System Partitions). I only proposed this however, because the amount of space boot environments need long term is higher than the amount of space that is available on a default Proxmox ESP and because shrinking a ZFS partition (which usually fills the rest of the harddrive) is not really something ZFS does.\nRecap: How do Boot Environments work on Proxmox systemd-boot is used since there can be multiple ESPs, they are not mounted at runtime a script called pve-efiboot-tool is used to refresh the bootloader configuration on all ESPs the pve-efiboot-tool calls another script zz-pve-efiboot, which iterates over all ESPs, mounts them, updates the boot loader configuration and finally unnmounts them zz-pve-efiboot gets its information about which ESPs exist from /etc/kernel/pve-efiboot-uuids and the kernel commandline from /etc/kernel/cmdline the kernel commandline contains the mountpoint for /, which is the part of this file we need to exchange in order to activate a Boot Environment In the last post I proposed the use of a template file for the kernel commandline /etc/kernel/cmdline.template, from which the /etc/kernel/cmdline file is generated before calling pve-efiboot-tool refresh. We will be using such a file here. On the ESPs we need to create a directory structure housing the Boot Environment configuration files Check for /etc/kernel/cmdline.template We need to make sure that the beadm script fails if no /etc/kernel/cmdline.template is found or if it is found, but does not contain the correct string (”__BE_NAME”), which we replace to create the cmdline file.\nif [ ! -f /etc/kernel/cmdline.template ] || ! $(grep -q \"__BE_NAME\" /etc/kernel/cmdline.template) then echo \"ERROR: /etc/kernel/cmdline.template not found!\" # [...] exit 1 fi Temporary files beadm usually is able to tell which Boot Environment will be active after the next boot, by simply looking into the ESP or boot loader configuration. Since on Proxmox the ESPs are not always mounted, we keep this information inside /tmp/beadm/. We store a version of the current loader.conf as well as the name of the next active boot environment in /tmp/beadm so we don’t have to mount/unmount ESPs every time we use list. We do this in a helper function:\n__get_active_be_from_esp() { if [ ! -f /tmp/beadm/loader.conf ] then mount /dev/disk/by-uuid/$(cat /etc/kernel/pve-efiboot-uuids | head -n 1) /boot/efi mkdir -p /tmp/beadm/ cp /boot/efi/loader/loader.conf /tmp/beadm/loader.conf default_entry=\"$(cat /tmp/beadm/loader.conf | grep default | cut -d ' ' -f2 | sed 's/-\\*$//')\" next_boot_environment=\"$(cat /boot/efi/loader/entries/$(ls /boot/efi/loader/entries/ | \\ grep $default_entry | head -n 1) | grep options | tr ' ' '\\n' | \\ grep root= | cut -d '/' -f3)\" echo $next_boot_environment \u003e /tmp/beadm/next_boot_environment # [...] umount /boot/efi fi } The init Parameter The init operation is a new operation that was added to beadm so a manually created dataset or a dataset that has no Boot Environment files on the ESP (such as the default /rpool/ROOT/pve-1 dataset) can be converted to a working Boot Environment. This command basically just creates some files on the ESPs.\nThis one is new and quite important: use it to initialize a Boot Environment for a dataset that already exists (you probably only need it for rpool/ROOT/pve-1 or whenever you’ve created snapshots by hand), but it’s nice to have.\nif $(zfs get canmount rpool/ROOT/$be_name | grep -q on) then zfs set canmount=off ${POOL}/${BEDS}/$be_name fi __get_active_be_from_esp # [...] old_be_name=\"$(cat /etc/kernel/cmdline | tr ' ' '\\n' | grep root | cut -d '/' -f3)\" cat /etc/kernel/cmdline.template | sed \"s/__BE_NAME/$be_name/\" \u003e /etc/kernel/cmdline pve-efiboot-tool refresh cat /etc/kernel/cmdline.template | sed \"s/__BE_NAME/$old_be_name/\" \u003e /etc/kernel/cmdline for esp in $(cat /etc/kernel/pve-efiboot-uuids) do mount /dev/disk/by-uuid/$esp /boot/efi mkdir -p /boot/efi/env/$be_name cp -r /boot/efi/EFI/proxmox/* /boot/efi/env/$be_name/ cat /boot/efi/loader/loader.conf | sed \"/default/c\\default $be_name-*\" \u003e /boot/efi/env/$be_name/loader.conf for entry in $(ls /boot/efi/loader/entries/ | grep proxmox-.*-pve.conf) do new_entry=\"$(echo $entry | sed \"s/proxmox/$be_name/;s/-pve//\")\" cp /boot/efi/loader/entries/$entry /boot/efi/loader/entries/$new_entry sed -i \"s/EFI/env/\" /boot/efi/loader/entries/$new_entry sed -i \"s/proxmox/$be_name/\" /boot/efi/loader/entries/$new_entry sed -i \"s/Proxmox Virtual Environment/$be_name/\" /boot/efi/loader/entries/$new_entry done rm -f /boot/efi/loader/loader.conf cp /tmp/beadm/loader.conf /boot/efi/loader/loader.conf umount /boot/efi done The list Parameter We check if we find a file containing the loader.conf in /tmp, if not we mount a ESP and copy loader.conf to /tmp, unmount the ESP and use this file to store the name of the next active BE. Apart from that, we can just create some output containing basically the same information as the original beadm list produces:\nzfs_list=\"$(zfs list -H -t filesystem,snapshot,volume -s creation -o name,used,usedds,usedbysnapshots,usedrefreserv,refer,creation,origin -r $POOL/$BEDS | grep \"^$POOL/$BEDS/\" | sed 's/\\t/,/g;s/\\n/;/g;s/ /_/g')\" __get_active_be_from_esp printf \"%-20s %-10s %-10s %-7s %-8s %-7s %-7s %-30s %-10s\\n\" name state used ds snaps ubrr refs \"creation date\" origin printf \"%-20s %-10s %-10s %-7s %-8s %-7s %-7s %-30s %-10s\\n\" ---- ----- ---- -- ----- ---- ---- --------------------- ------ for line in $(echo $zfs_list | tr ';' '\\n'); do BE_NAME=\"$(echo $line | cut -d ',' -f1 | sed \"s/^$POOL\\/$BEDS\\///\")\" BE_ACTIVE=\"$(if [ \"$ROOTFS\" = \"$(echo $line | cut -d ',' -f1)\" ]; then echo N; else echo ' '; fi)\" BE_NEXT=\"$(if [ \"$BE_NAME\" = \"$(cat /tmp/beadm/next_boot_environment)\" ]; then echo R; else echo ' '; fi)\" BE_STATE=\"$(if [ \"$BE_ACTIVE$BE_NEXT\" = \" \" ]; then echo \"-\"; else echo \"$BE_ACTIVE$BE_NEXT\"; fi)\" BE_USED=\"$(echo $line | cut -d ',' -f2)\" BE_USEDDS=\"$(echo $line | cut -d ',' -f3)\" BE_USEDBYSNAPSHOTS=\"$(echo $line | cut -d ',' -f4)\" BE_USEDREFRESERV=\"$(echo $line | cut -d ',' -f5)\" BE_REFER=\"$(echo $line | cut -d ',' -f6)\" BE_DATE=\"$(echo $line | cut -d ',' -f7 | sed 's/_/ /g')\" BE_ORIGIN=\"$(echo $line | cut -d ',' -f8)\" if ! echo $line | cut -d ',' -f 1 | grep -q \"@\"; then printf \"%-20s %-10s %-10s %-7s %-8s %-7s %-7s %-30s %-10s\\n\" $BE_NAME $BE_STATE $BE_USED $BE_USEDDS $BE_USEDBYSNAPSHOTS $BE_USEDREFRESERV $BE_REFER \"$BE_DATE\" \"$BE_ORIGIN\" fi done The create Parameter The create operation is used to create a new bootable dataset. After the operation the newly created Boot Environment is not active.\nIn order to make this operation work with Proxmox, first we need to grab a copy of the currently active Boot Environment from one ESP and store it in /tmp/beadm.\nThen we create a new /etc/kernel/cmdline from the template file and run pve-efiboot-tool refresh, which creates a valid bootloader configuration on all of our ESPs. Next we copy the kernel files into $ESP/env/$BE_NAME, rename all the conf files and restore the previous loader.conf that we saved in /tmp/beadm/loader.conf. This way we can create a new Boot Environment without activating it.\nzfs set canmount=off ${POOL}/${BEDS}/$be_name __get_active_be_from_esp old_be_name=\"$(cat /etc/kernel/cmdline | tr ' ' '\\n' | grep root | cut -d '/' -f3)\" cat /etc/kernel/cmdline.template | sed \"s/__BE_NAME/$be_name/\" \u003e /etc/kernel/cmdline pve-efiboot-tool refresh cat /etc/kernel/cmdline.template | sed \"s/__BE_NAME/$old_be_name/\" \u003e /etc/kernel/cmdline for esp in $(cat /etc/kernel/pve-efiboot-uuids) do mount /dev/disk/by-uuid/$esp /boot/efi mkdir -p /boot/efi/env/$be_name cp -r /boot/efi/EFI/proxmox/* /boot/efi/env/$be_name/ cat /boot/efi/loader/loader.conf | sed \"/default/c\\default $be_name-*\" \u003e /boot/efi/env/$be_name/loader.conf for entry in $(ls /boot/efi/loader/entries/ | grep proxmox-.*-pve.conf) do new_entry=\"$(echo $entry | sed \"s/proxmox/$be_name/;s/-pve//\")\" cp /boot/efi/loader/entries/$entry /boot/efi/loader/entries/$new_entry sed -i \"s/EFI/env/\" /boot/efi/loader/entries/$new_entry sed -i \"s/proxmox/$be_name/\" /boot/efi/loader/entries/$new_entry sed -i \"s/Proxmox Virtual Environment/$be_name/\" /boot/efi/loader/entries/$new_entry done rm /boot/efi/loader/loader.conf cp /tmp/beadm/loader.conf /boot/efi/loader/loader.conf umount /boot/efi done The activate Parameter Here we activate a Boot Environment, that has already been created, so we only need to mount all the ESPs and copy the correct conf file so it replaces the loader.conf. We also need to write the name of the active Boot Environment to /tmp/beadm.\nfor esp in $(cat /etc/kernel/pve-efiboot-uuids) do mount /dev/disk/by-uuid/$esp /boot/efi rm -f /boot/efi/loader/loader.conf # [...] cp /boot/efi/env/$be_name/loader.conf /boot/efi/loader/loader.conf umount /boot/efi done The rename Parameter Here, we need to rename the folder inside the env directory as well as the conf files in the entries directory. We also have to make sure they point to the new directory.\nfor esp in $(cat /etc/kernel/pve-efiboot-uuids) do mount /dev/disk/by-uuid/$esp /boot/efi mv /boot/efi/env/$be_name/ /boot/efi/env/$new_be_name/ sed -i \"s/$be_name/$new_be_name/\" /boot/efi/env/$new_be_name/loader.conf sed -i \"s/$be_name/$new_be_name/\" /boot/efi/loader/loader.conf for entry in $(ls /boot/efi/loader/entries/ | grep $be_name) do sed -i \"s/$be_name/$new_be_name/\" /boot/efi/loader/entries/$entry new_entry_name=$(echo $entry | sed \"s/$be_name/$new_be_name/\") mv /boot/efi/loader/entries/$entry /boot/efi/loader/entries/$new_entry_name done umount /boot/efi done The destroy Parameter We need to delete the content of the env directory as well as the config files.\nfor esp in $(cat /etc/kernel/pve-efiboot-uuids) do mount /dev/disk/by-uuid/$esp /boot/efi rm -rf /boot/efi/env/$be_name/ for entry in $(ls /boot/efi/loader/entries/ | grep $be_name) do rm -f /boot/efi/loader/entries/$entry done umount /boot/efi done Conclusion and Further Work This post has introduced beadm, a Boot Environment Manager for the Proxmox Virtualization Plattform, which has been forked from it’s FreeBSD counterpart. First the usage of beadm is showcased, then some notes on porting beadm from FreeBSD to Linux are presented and finally the Proxmox specific additions to beadm are explained.\nThe way beadm is implemented in this post could partially be considered bad design, however this is due to beadm being an external tool and not part of the native Proxmox tooling. The scope of this was to implement Boot Environments without changing the Proxmox code. I’m sure the design will be improved if this functionality is added to Proxmox. The following Improvements can be made:\ndeduplication of kernel files (Reference counting could help to manage this) minimize the amount of mount / unmount operations add the ability to inject kernels into Boot Environments add the ability to prune kernels from Boot Environments add the ability to export / import Boot Environments together with the relevant files from the ESPs Now that Boot Environments on Proxmox (or more general on Linux) are a possibility, the next thing to do could be to write up how Boot Environments can be used in practice. For now the following scenarios, which could be interesting come to mind:\nUpdate systems using a new Boot Environment using chroot Migrate systems by moving Boot Environments Use a copy of a system in order to do forensic work Find out what has changed between two system states by comparing the filesystem snapshots Use the same “base” Boot Environment to run on multiple bare metal / virtualized machines, make an update on the base Environment, then push it out to multiple systems. Rollbacks in case of system failure: Reduce MTTR on bare metal systems ","wordCount":"3467","inLanguage":"en","datePublished":"2019-10-29T00:00:00+01:00","dateModified":"2019-10-29T00:00:00+01:00","author":[{"@type":"Person","name":"oblivious observer"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://oblivious.observer/posts/proxmoxve6-boot-environment-manager/"},"publisher":{"@type":"Organization","name":"oblivious observer","logo":{"@type":"ImageObject","url":"https://oblivious.observer/observer-16x16.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://oblivious.observer accesskey=h title="  (Alt + H)"><img src=https://oblivious.observer/observer-64x64.png alt aria-label=logo height=35></a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://oblivious.observer/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://oblivious.observer/posts/ title=posts><span>posts</span></a></li><li><a href=https://oblivious.observer/archives/ title=archive><span>archive</span></a></li><li><a href=https://oblivious.observer/tags/ title=tags><span>tags</span></a></li><li><a href=https://oblivious.observer/index.html title=about><span>about</span></a></li><li><a href=https://oblivious.observer/index.xml title=rss><span>rss</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Introducing a Boot Environment Manager for Proxmox</h1><div class=post-meta><span title='2019-10-29 00:00:00 +0100 CET'>October 29, 2019</span>&nbsp;·&nbsp;17 min&nbsp;·&nbsp;oblivious observer</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#overview aria-label=Overview>Overview</a></li><li><a href=#introduction aria-label=Introduction>Introduction</a></li><li><a href=#managing-boot-environments-in-proxmox aria-label="Managing Boot Environments in Proxmox">Managing Boot Environments in Proxmox</a></li><li><a href=#making-beadm-work-under-linux aria-label="Making beadm work under Linux">Making <code>beadm</code> work under Linux</a><ul><li><a href=#removing-the-bootloader-specific-code aria-label="Removing the bootloader specific code">Removing the bootloader specific code</a></li><li><a href=#replacing-the-awk-code-of-the-list-command aria-label="Replacing the awk code of the list command">Replacing the <code>awk</code> code of the <code>list</code> command</a></li><li><a href=#replace-freebsd-date-with-it-s-linux-counterpart aria-label="Replace FreeBSD date with it&amp;rsquo;s Linux counterpart">Replace FreeBSD <code>date</code> with it&rsquo;s Linux counterpart</a></li><li><a href=#missing-u-parameter-in-the-linux-zfs-implementation aria-label="Missing -u Parameter in the Linux ZFS Implementation">Missing <code>-u</code> Parameter in the Linux ZFS Implementation</a></li><li><a href=#mounting-zfs-datasets-under-linux aria-label="Mounting ZFS datasets under Linux">Mounting ZFS datasets under Linux</a></li><li><a href=#zfs-automount-with-systemd aria-label="ZFS automount with systemd">ZFS automount with systemd</a></li></ul></li><li><a href=#making-beadm-work-with-proxmox aria-label="Making beadm work with Proxmox">Making <code>beadm</code> work with Proxmox</a><ul><li><a href=#recap-how-do-boot-environments-work-on-proxmox aria-label="Recap: How do Boot Environments work on Proxmox">Recap: How do Boot Environments work on Proxmox</a></li><li><a href=#check-for-etc-kernel-cmdline-dot-template aria-label="Check for /etc/kernel/cmdline.template">Check for <code>/etc/kernel/cmdline.template</code></a></li><li><a href=#temporary-files aria-label="Temporary files">Temporary files</a></li><li><a href=#the-init-parameter aria-label="The init Parameter">The <code>init</code> Parameter</a></li><li><a href=#the-list-parameter aria-label="The list Parameter">The <code>list</code> Parameter</a></li><li><a href=#the-create-parameter aria-label="The create Parameter">The <code>create</code> Parameter</a></li><li><a href=#the-activate-parameter aria-label="The activate Parameter">The <code>activate</code> Parameter</a></li><li><a href=#the-rename-parameter aria-label="The rename Parameter">The <code>rename</code> Parameter</a></li><li><a href=#the-destroy-parameter aria-label="The destroy Parameter">The <code>destroy</code> Parameter</a></li></ul></li><li><a href=#conclusion-and-further-work aria-label="Conclusion and Further Work">Conclusion and Further Work</a></li></ul></div></details></div><div class=post-content><p>This post introduces a fork of the FreeBSD <code>beadm</code> utility which can be
used to manage Boot Environments on Proxmox ZFS Installations.</p><p>In this Post I will showcase how to use the <code>beadm</code> Boot Environment manager in
Proxmox. After the showcase there are some notes on what I did to make <code>beadm</code>
run on Linux in general and finally a part about what has been changed in order
to make <code>beadm</code> work with Proxmox specifically.</p><p>The version of beadm that is compatible with Proxmox can be found <a href=https://github.com/observer/beadm>on github</a>.</p><h2 id=overview>Overview<a hidden class=anchor aria-hidden=true href=#overview>#</a></h2><ul><li>Introduction</li><li>Managing Boot Environments in Proxmox</li><li>Making <code>beadm</code> work under Linux</li><li>Making <code>beadm</code> work with Proxmox</li><li>Conclusion and Further Work</li></ul><h2 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h2><p>In my <a href=https://tactical-documentation.github.io/post/poc-proxmox-and-boot-environments/>previous post</a> I&rsquo;ve already outlined how boot environments work in general,
how you can make them work under Proxmox VE 6 and presented a Proof of Concept
solution of how they can be set up programmatically using <code>zedenv</code>, a
python-based manager for Boot Environments.</p><p>Since my last post I&rsquo;ve taken a bit of a closer look at both the code of
<code>zedenv</code> as well as <code>beadm</code> and decided to fork the latter and make it
work with Proxmox.</p><p>While this is still a Proof of Concept, it can be simply plugged into an
existing Proxmox ZFS installation in order to enable and manage Boot
Environments.</p><p>As with the previous PoC, I&rsquo;ve written the code in such a way that no
parts of Proxmox have been changed. Apart from some additional files
that are created, your system stays as it is, also all Boot Entries
created by Proxmox are still available in parallel to the Boot
Environment entries in your bootloader.</p><p>Since the last post I&rsquo;ve simply reinstalled Proxmox with 10GB ESPs on
both of my system drives, so I have enough space to store more Boot
Environments. In order to install with a bigger ESP, install the system
with custom (smaller) ZFS partition size, then after the installation,
remove a drive from your ZFS pool, delete the ZFS partition, resize the
ESP, create a new ZFS partition, add it back to the pool, resilver and
repeat these steps for the second drive.</p><h2 id=managing-boot-environments-in-proxmox>Managing Boot Environments in Proxmox<a hidden class=anchor aria-hidden=true href=#managing-boot-environments-in-proxmox>#</a></h2><p>In order to use <code>beadm</code> with Proxmox you can
<a href=https://github.com/tactical-documentation/beadm>grab a copy from
github</a>, make it executable and start using it right away. I do
strongly encurage you to either use a test installation or look at the
code and read through this post and the
<a href=https://tactical-documentation.github.io/post/poc-proxmox-and-boot-environments/>previous
one</a> first, so you know what is going on.</p><p>On the first run you&rsquo;ll see the following error message, read it, create
the template file and you are good to go (also remember that from now
on, any changes to the <code>cmdline</code> file should be made to the template
file instead, because the <code>cmdline</code> file will be autogenerated):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  root@caliban:~# ./beadm
</span></span><span style=display:flex><span>  ERROR: /etc/kernel/cmdline.template not found!
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  You need a template file <span style=color:#ff79c6>for</span> the kernel commandline.
</span></span><span style=display:flex><span>  The template file has to be identical to the /etc/kernel/cmdline file, but instead of a specific root it must contain the string <span style=color:#f1fa8c>&#34;__BE_NAME&#34;</span>
</span></span><span style=display:flex><span>  The template file is used in order to create a valid kernel commandline <span style=color:#ff79c6>for</span> systemd-boot, which points to the correct boot environment.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  In order to use beadm, create a valid /etc/kernel/cmdline.template
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Example: <span style=color:#ff79c6>if</span> your /etc/kernel/cmdline looks like this:
</span></span><span style=display:flex><span>           <span style=color:#8be9fd;font-style:italic>root</span><span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>ZFS</span><span style=color:#ff79c6>=</span>rpool/ROOT/pve-1 <span style=color:#8be9fd;font-style:italic>boot</span><span style=color:#ff79c6>=</span>zfs
</span></span><span style=display:flex><span>           <span style=color:#ff79c6>then</span> the template file should contain:
</span></span><span style=display:flex><span>           <span style=color:#8be9fd;font-style:italic>root</span><span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>ZFS</span><span style=color:#ff79c6>=</span>rpool/ROOT/__BE_NAME <span style=color:#8be9fd;font-style:italic>boot</span><span style=color:#ff79c6>=</span>zfs
</span></span></code></pre></div><p>After that you can list your boot environments with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  root@caliban:~# ./beadm list
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Boot Environments on caliban:
</span></span><span style=display:flex><span>  name                 state      used       ds      snaps    ubrr    refs    creation date                  origin
</span></span><span style=display:flex><span>  ----                 -----      ----       --      -----    ----    ----    ---------------------          ------
</span></span><span style=display:flex><span>  pve-1                NR         1.20G      1.15G   44.8M    0B      1.15G   Sun Sep  <span style=color:#bd93f9>1</span> 17:08 <span style=color:#bd93f9>2019</span>          -
</span></span></code></pre></div><p>At this point you don&rsquo;t have a <code>pve-1</code> Boot Environment, because the
file structure of the ESPs is currently just pointing to the default
Proxmox config. For the <code>pve-1</code> dataset (or any dataset you create by
hand) we can create the necessary files with the <code>init</code> command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  root@caliban:~# ./beadm init pve-1
</span></span><span style=display:flex><span>  Boot Environment <span style=color:#ff79c6>for</span> pve-1 has been generated successfully!
</span></span></code></pre></div><p>Now you can create a new Boot Environment using <code>create</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  root@caliban:~# ./beadm init pve-2
</span></span><span style=display:flex><span>  Running hook script <span style=color:#f1fa8c>&#39;pve-auto-removal&#39;</span>..
</span></span><span style=display:flex><span>  Running hook script <span style=color:#f1fa8c>&#39;zz-pve-efiboot&#39;</span>..
</span></span><span style=display:flex><span>  Re-executing <span style=color:#f1fa8c>&#39;/etc/kernel/postinst.d/zz-pve-efiboot&#39;</span> in new private mount namespace..
</span></span><span style=display:flex><span>  Copying and configuring kernels on /dev/disk/by-uuid/XXXX-XXXX
</span></span><span style=display:flex><span>          Copying kernel and creating boot-entry <span style=color:#ff79c6>for</span> 5.0.15-1-pve
</span></span><span style=display:flex><span>          Copying kernel and creating boot-entry <span style=color:#ff79c6>for</span> 5.0.21-1-pve
</span></span><span style=display:flex><span>  Copying and configuring kernels on /dev/disk/by-uuid/YYYY-YYYY
</span></span><span style=display:flex><span>          Copying kernel and creating boot-entry <span style=color:#ff79c6>for</span> 5.0.15-1-pve
</span></span><span style=display:flex><span>          Copying kernel and creating boot-entry <span style=color:#ff79c6>for</span> 5.0.21-1-pve
</span></span><span style=display:flex><span>  Created successfully
</span></span></code></pre></div><p>Now we have a second Boot Environment, but it is not active. As you can
see right now (<code>N</code>) <code>pve-1</code> is active and after the next reboot (<code>R</code>)
<code>pve-1</code> will be active again:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  root@caliban:~# ./beadm list
</span></span><span style=display:flex><span>  Boot Environments on caliban:
</span></span><span style=display:flex><span>  name                 state      used       ds      snaps    ubrr    refs    creation date                  origin
</span></span><span style=display:flex><span>  ----                 -----      ----       --      -----    ----    ----    ---------------------          ------
</span></span><span style=display:flex><span>  pve-1                NR         1.20G      1.15G   44.8M    0B      1.15G   Sun Sep  <span style=color:#bd93f9>1</span> 17:08 <span style=color:#bd93f9>2019</span>          -
</span></span><span style=display:flex><span>  pve-2                -          8K         8K      0B       0B      1.15G   Sun Oct  <span style=color:#bd93f9>6</span> 14:12 <span style=color:#bd93f9>2019</span>          rpool/ROOT/pve-1@2019-10-06-11:36:14
</span></span></code></pre></div><p>In order to activate the Boot Environment, run:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  root@caliban:~# ./beadm activate pve-2
</span></span><span style=display:flex><span>  pve-2 has been activated successfully
</span></span></code></pre></div><p>Now you can see that the Boot Environment will be active after a reboot:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  root@caliban:~# ./beadm list
</span></span><span style=display:flex><span>  Boot Environments on caliban:
</span></span><span style=display:flex><span>  name                 state      used       ds      snaps    ubrr    refs    creation date                  origin
</span></span><span style=display:flex><span>  ----                 -----      ----       --      -----    ----    ----    ---------------------          ------
</span></span><span style=display:flex><span>  pve-1                N          1.20G      1.15G   44.8M    0B      1.15G   Sun Sep  <span style=color:#bd93f9>1</span> 17:08 <span style=color:#bd93f9>2019</span>          -
</span></span><span style=display:flex><span>  pve-2                R          8K         8K      0B       0B      1.15G   Sun Oct  <span style=color:#bd93f9>6</span> 14:12 <span style=color:#bd93f9>2019</span>          rpool/ROOT/pve-1@2019-10-06-11:36:14
</span></span></code></pre></div><p>If you don&rsquo;t like the name, you can rename <code>pve-2</code> with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  root@caliban:~# ./beadm rename pve-2 pve-002
</span></span><span style=display:flex><span>  root@caliban:~# ./beadm list
</span></span><span style=display:flex><span>  Boot Environments on caliban:
</span></span><span style=display:flex><span>  name                 state      used       ds      snaps    ubrr    refs    creation date                  origin
</span></span><span style=display:flex><span>  ----                 -----      ----       --      -----    ----    ----    ---------------------          ------
</span></span><span style=display:flex><span>  pve-1                N          1.20G      1.15G   44.8M    0B      1.15G   Sun Sep  <span style=color:#bd93f9>1</span> 17:08 <span style=color:#bd93f9>2019</span>          -
</span></span><span style=display:flex><span>  pve-002              R          8K         8K      0B       0B      1.15G   Sun Oct  <span style=color:#bd93f9>6</span> 14:12 <span style=color:#bd93f9>2019</span>          rpool/ROOT/pve-1@2019-10-06-11:36:14
</span></span></code></pre></div><p>You can also mount Boot Environments:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  root@caliban:~# ls
</span></span><span style=display:flex><span>  beadm
</span></span><span style=display:flex><span>  root@caliban:~# ./beadm mount pve-002 mountpoint
</span></span><span style=display:flex><span>  Mounted successfully on <span style=color:#f1fa8c>&#39;mountpoint&#39;</span>
</span></span><span style=display:flex><span>  root@caliban:~# ls
</span></span><span style=display:flex><span>  beadm  mountpoint
</span></span><span style=display:flex><span>  root@caliban:~# ls mountpoint/
</span></span><span style=display:flex><span>  bin  boot  dev  etc  home  lib  lib32  lib64  libx32  media  mnt  opt  proc  root  rpool  run  sbin  srv  sys  tmp  usr  var
</span></span><span style=display:flex><span>  root@caliban:~# ./beadm umount pve-002
</span></span><span style=display:flex><span>  Unmounted successfully
</span></span><span style=display:flex><span>  root@caliban:~# ls
</span></span><span style=display:flex><span>  beadm  mountpoint
</span></span><span style=display:flex><span>  root@caliban:~# rmdir mountpoint
</span></span></code></pre></div><p>If you reboot, you should be booting into the active Boot Environment.
Install something (e.g. <code>htop</code>), open it, then use <code>beadm</code> to activate
the previous Boot Environment, reboot and notice how the program you&rsquo;ve
just installed has dissapeared, because you just went back in time.</p><p>If you plan on setting up your Proxmox host with Boot Environments,
don&rsquo;t forget to make sure you have your ZFS datasets set up properly,
I&rsquo;ve written about that in my
<a href=https://tactical-documentation.github.io/post/poc-proxmox-and-boot-environments/>previous
post</a>.</p><h2 id=making-beadm-work-under-linux>Making <code>beadm</code> work under Linux<a hidden class=anchor aria-hidden=true href=#making-beadm-work-under-linux>#</a></h2><p>This part contains notes about which parts of the original <code>beadm</code> I
changed to make it work on linux. You can skip this part if you don&rsquo;t
care about the details that are not specific to Proxmox.</p><p><code>beadm</code> is originally a Boot Environment manager for FreeBSD by
<a href=https://vermaden.wordpress.com/>vermaden</a>. It is written in shell
and enables you to create new Boot Environments or create them from ZFS
snapshots, to activate, rename or destroy Boot Environments, list them
and also mount and unmount them:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  root@caliban:~# beadm
</span></span><span style=display:flex><span>  usage:
</span></span><span style=display:flex><span>    beadm activate &lt;beName&gt;
</span></span><span style=display:flex><span>    beadm create <span style=color:#ff79c6>[</span>-e nonActiveBe | -e beName@snapshot<span style=color:#ff79c6>]</span> &lt;beName&gt;
</span></span><span style=display:flex><span>    beadm create &lt;beName@snapshot&gt;
</span></span><span style=display:flex><span>    beadm destroy <span style=color:#ff79c6>[</span>-F<span style=color:#ff79c6>]</span> &lt;beName | beName@snapshot&gt;
</span></span><span style=display:flex><span>    beadm list <span style=color:#ff79c6>[</span>-a<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>[</span>-s<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>[</span>-D<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>[</span>-H<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>    beadm rename &lt;origBeName&gt; &lt;newBeName&gt;
</span></span><span style=display:flex><span>    beadm mount &lt;beName&gt; <span style=color:#ff79c6>[</span>mountpoint<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>    beadm <span style=color:#ff79c6>{</span> umount | unmount <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>[</span>-f<span style=color:#ff79c6>]</span> &lt;beName&gt;
</span></span><span style=display:flex><span>    beadm version
</span></span></code></pre></div><p>The script was originally about 900 LOC long and consisted of a bunch of
helper functions followed by a big case statement, which takes care of
running the code specific to the supplied parameter.</p><p>After applying the following changes, apart from setting up the boot
loader specific stuff, <code>beadm</code> should work on linux:</p><h3 id=removing-the-bootloader-specific-code>Removing the bootloader specific code<a hidden class=anchor aria-hidden=true href=#removing-the-bootloader-specific-code>#</a></h3><p>Apart from managing the ZFS part it also takes care of managing FreeBSDs
own bootloader or optionally <code>grub2</code>. I basically just removed these
FreeBSD specific parts.</p><h3 id=replacing-the-awk-code-of-the-list-command>Replacing the <code>awk</code> code of the <code>list</code> command<a hidden class=anchor aria-hidden=true href=#replacing-the-awk-code-of-the-list-command>#</a></h3><p>The <code>list</code> section of the script also contains a rather large piece of
awk code for displaying the available/active Boot Environments. I&rsquo;ve
replaced this part with shell, because I&rsquo;m not yet familiar enough with
awk to use it inside of a script. Therefore the new <code>list</code> command is
probably a bit simpler than it&rsquo;s FreeBSD parent. I also made sure that
the correct next boot environment is marked, by looking into the content
of <code>/etc/kernel/cmdline</code>.</p><h3 id=replace-freebsd-date-with-it-s-linux-counterpart>Replace FreeBSD <code>date</code> with it&rsquo;s Linux counterpart<a hidden class=anchor aria-hidden=true href=#replace-freebsd-date-with-it-s-linux-counterpart>#</a></h3><p>For the <code>destroy</code> operation I had to replace the line containing the
<code>date</code> command, since FreeBSDs <code>date</code> supports the -f option, while the
linux <code>date</code> command does not.</p><h3 id=missing-u-parameter-in-the-linux-zfs-implementation>Missing <code>-u</code> Parameter in the Linux ZFS Implementation<a hidden class=anchor aria-hidden=true href=#missing-u-parameter-in-the-linux-zfs-implementation>#</a></h3><p>The <code>rename</code> operation uses the <code>zfs rename</code> with the <code>-u</code> parameter.
This parameter does not exist in linux and according to the FreeBSD
man-page, it makes sure that filesystems are not remounted during the
rename operation:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-man data-lang=man><span style=display:flex><span>  -u      Do not remount file systems during rename. If a file system&#39;s
</span></span><span style=display:flex><span>          mountpoint  property is set to legacy or none, file system is not
</span></span><span style=display:flex><span>          unmounted even if this option is not given.
</span></span></code></pre></div><h3 id=mounting-zfs-datasets-under-linux>Mounting ZFS datasets under Linux<a hidden class=anchor aria-hidden=true href=#mounting-zfs-datasets-under-linux>#</a></h3><p>In order to make the <code>mount</code> operation work, the <code>-o zfsutil</code> option had
to be applied to the <code>zfs mount</code> command.</p><h3 id=zfs-automount-with-systemd>ZFS automount with systemd<a hidden class=anchor aria-hidden=true href=#zfs-automount-with-systemd>#</a></h3><p>As I worked on the linux version of beadm, I also noticed that apart
from making sure all the ESPs are working as intended, when booting into
a new Boot environment, only <code>/</code> was mounted.</p><p>This was due to the systemd <code>zfs-mount</code> service not running. This
service makes sure that all the zfs datasets are mounted on boot, but
was failing to execute <code>zfs mount -a</code>, because there is more than one
dataset that should be mounted to <code>/</code>.</p><p>In order to fix this, we can use the <code>canmount</code> option and set it to
<code>off</code> for all Boot Environments:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-man data-lang=man><span style=display:flex><span>  canmount=on | off | noauto
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  If this property is set to off, the file system cannot be mounted, and
</span></span><span style=display:flex><span>  is ignored by zfs mount -a. Setting this property to off is similar to
</span></span><span style=display:flex><span>  setting the mountpoint property to none, except that the dataset still
</span></span><span style=display:flex><span>  has a normal mountpoint property, which can be inherited. Setting this
</span></span><span style=display:flex><span>  property to off allows datasets to be used solely as a mechanism to
</span></span><span style=display:flex><span>  inherit properties. One example of setting canmount=off is to have two
</span></span><span style=display:flex><span>  datasets with the same mountpoint, so that the children of both
</span></span><span style=display:flex><span>  datasets appear in the same directory, but might have different
</span></span><span style=display:flex><span>  inherited characteristics.  When the noauto option is set, a dataset
</span></span><span style=display:flex><span>  can only be mounted and unmounted explicitly. The dataset is not
</span></span><span style=display:flex><span>  mounted automatically when the dataset is created or imported, nor is
</span></span><span style=display:flex><span>  it mounted by the zfs mount -a command or unmounted by the zfs unmount
</span></span><span style=display:flex><span>  -a command.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  This property is not inherited.
</span></span></code></pre></div><h2 id=making-beadm-work-with-proxmox>Making <code>beadm</code> work with Proxmox<a hidden class=anchor aria-hidden=true href=#making-beadm-work-with-proxmox>#</a></h2><p>This part describes the changes I made to <code>beadm</code> that were Proxmox
specific.</p><p>In my last post I described that the content of the Boot Environments
could be housed in a ZFS dataset and then copied over to the ESPs (EFI
System Partitions). I only proposed this however, because the amount of
space boot environments need long term is higher than the amount of
space that is available on a default Proxmox ESP and because shrinking a
ZFS partition (which usually fills the rest of the harddrive) is not
really something ZFS does.</p><h3 id=recap-how-do-boot-environments-work-on-proxmox>Recap: How do Boot Environments work on Proxmox<a hidden class=anchor aria-hidden=true href=#recap-how-do-boot-environments-work-on-proxmox>#</a></h3><ul><li>systemd-boot is used</li><li>since there can be multiple ESPs, they are not mounted at runtime</li><li>a script called <code>pve-efiboot-tool</code> is used to refresh the bootloader
configuration on all ESPs</li><li>the <code>pve-efiboot-tool</code> calls another script <code>zz-pve-efiboot</code>, which
iterates over all ESPs, mounts them, updates the boot loader
configuration and finally unnmounts them</li><li><code>zz-pve-efiboot</code> gets its information about which ESPs exist from
<code>/etc/kernel/pve-efiboot-uuids</code> and the kernel commandline from
<code>/etc/kernel/cmdline</code></li><li>the kernel commandline contains the mountpoint for <code>/</code>, which is the
part of this file we need to exchange in order to activate a Boot
Environment</li><li>In the last post I proposed the use of a template file for the kernel
commandline <code>/etc/kernel/cmdline.template</code>, from which the
<code>/etc/kernel/cmdline</code> file is generated before calling
<code>pve-efiboot-tool refresh</code>. We will be using such a file here.</li><li>On the ESPs we need to create a directory structure housing the Boot
Environment configuration files</li></ul><h3 id=check-for-etc-kernel-cmdline-dot-template>Check for <code>/etc/kernel/cmdline.template</code><a hidden class=anchor aria-hidden=true href=#check-for-etc-kernel-cmdline-dot-template>#</a></h3><p>We need to make sure that the <code>beadm</code> script fails if no
<code>/etc/kernel/cmdline.template</code> is found or if it is found, but does not
contain the correct string (”__BE_NAME”), which we replace to create the
<code>cmdline</code> file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>[</span> ! -f /etc/kernel/cmdline.template <span style=color:#ff79c6>]</span> <span style=color:#ff79c6>||</span> ! <span style=color:#ff79c6>$(</span>grep -q <span style=color:#f1fa8c>&#34;__BE_NAME&#34;</span> /etc/kernel/cmdline.template<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>then</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;ERROR: /etc/kernel/cmdline.template not found!&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4># [...]</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>exit</span> <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>fi</span>
</span></span></code></pre></div><h3 id=temporary-files>Temporary files<a hidden class=anchor aria-hidden=true href=#temporary-files>#</a></h3><p><code>beadm</code> usually is able to tell which Boot Environment will be active
after the next boot, by simply looking into the ESP or boot loader
configuration. Since on Proxmox the ESPs are not always mounted, we keep
this information inside <code>/tmp/beadm/</code>. We store a version of the current
<code>loader.conf</code> as well as the name of the next active boot environment in
/tmp/beadm so we don&rsquo;t have to mount/unmount ESPs every time we use
<code>list</code>. We do this in a helper function:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  __get_active_be_from_esp<span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>[</span> ! -f /tmp/beadm/loader.conf <span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>then</span>
</span></span><span style=display:flex><span>      mount /dev/disk/by-uuid/<span style=color:#ff79c6>$(</span>cat /etc/kernel/pve-efiboot-uuids | head -n 1<span style=color:#ff79c6>)</span> /boot/efi
</span></span><span style=display:flex><span>      mkdir -p /tmp/beadm/
</span></span><span style=display:flex><span>      cp /boot/efi/loader/loader.conf /tmp/beadm/loader.conf
</span></span><span style=display:flex><span>      <span style=color:#8be9fd;font-style:italic>default_entry</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span>cat /tmp/beadm/loader.conf | grep default | cut -d <span style=color:#f1fa8c>&#39; &#39;</span> -f2 | sed <span style=color:#f1fa8c>&#39;s/-\*$//&#39;</span><span style=color:#ff79c6>)</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#8be9fd;font-style:italic>next_boot_environment</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span>cat /boot/efi/loader/entries/<span style=color:#ff79c6>$(</span>ls /boot/efi/loader/entries/ | <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>                               grep <span style=color:#8be9fd;font-style:italic>$default_entry</span> | head -n 1<span style=color:#ff79c6>)</span> | grep options | tr <span style=color:#f1fa8c>&#39; &#39;</span> <span style=color:#f1fa8c>&#39;\n&#39;</span> | <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>                               grep <span style=color:#8be9fd;font-style:italic>root</span><span style=color:#ff79c6>=</span> | cut -d <span style=color:#f1fa8c>&#39;/&#39;</span> -f3<span style=color:#ff79c6>)</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#8be9fd;font-style:italic>$next_boot_environment</span> &gt; /tmp/beadm/next_boot_environment
</span></span><span style=display:flex><span>      <span style=color:#6272a4># [...]</span>
</span></span><span style=display:flex><span>      umount /boot/efi
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>fi</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>}</span>
</span></span></code></pre></div><h3 id=the-init-parameter>The <code>init</code> Parameter<a hidden class=anchor aria-hidden=true href=#the-init-parameter>#</a></h3><p>The init operation is a new operation that was added to <code>beadm</code> so a
manually created dataset or a dataset that has no Boot Environment files
on the ESP (such as the default <code>/rpool/ROOT/pve-1</code> dataset) can be
converted to a working Boot Environment. This command basically just
creates some files on the ESPs.</p><p>This one is new and quite important: use it to initialize a Boot
Environment for a dataset that already exists (you probably only need it
for <code>rpool/ROOT/pve-1</code> or whenever you&rsquo;ve created snapshots by hand),
but it&rsquo;s nice to have.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>$(</span>zfs get canmount rpool/ROOT/<span style=color:#8be9fd;font-style:italic>$be_name</span> | grep -q on<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>then</span>
</span></span><span style=display:flex><span>    zfs <span style=color:#8be9fd;font-style:italic>set</span> <span style=color:#8be9fd;font-style:italic>canmount</span><span style=color:#ff79c6>=</span>off <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>POOL</span><span style=color:#f1fa8c>}</span>/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>BEDS</span><span style=color:#f1fa8c>}</span>/<span style=color:#8be9fd;font-style:italic>$be_name</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  __get_active_be_from_esp
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4># [...]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>old_be_name</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span>cat /etc/kernel/cmdline | tr <span style=color:#f1fa8c>&#39; &#39;</span> <span style=color:#f1fa8c>&#39;\n&#39;</span> | grep root | cut -d <span style=color:#f1fa8c>&#39;/&#39;</span> -f3<span style=color:#ff79c6>)</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  cat /etc/kernel/cmdline.template | sed <span style=color:#f1fa8c>&#34;s/__BE_NAME/</span><span style=color:#8be9fd;font-style:italic>$be_name</span><span style=color:#f1fa8c>/&#34;</span> &gt; /etc/kernel/cmdline
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  pve-efiboot-tool refresh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  cat /etc/kernel/cmdline.template | sed <span style=color:#f1fa8c>&#34;s/__BE_NAME/</span><span style=color:#8be9fd;font-style:italic>$old_be_name</span><span style=color:#f1fa8c>/&#34;</span> &gt; /etc/kernel/cmdline
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>for</span> esp in <span style=color:#ff79c6>$(</span>cat /etc/kernel/pve-efiboot-uuids<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span>    mount /dev/disk/by-uuid/<span style=color:#8be9fd;font-style:italic>$esp</span> /boot/efi
</span></span><span style=display:flex><span>    mkdir -p /boot/efi/env/<span style=color:#8be9fd;font-style:italic>$be_name</span>
</span></span><span style=display:flex><span>    cp -r /boot/efi/EFI/proxmox/* /boot/efi/env/<span style=color:#8be9fd;font-style:italic>$be_name</span>/
</span></span><span style=display:flex><span>    cat /boot/efi/loader/loader.conf | sed <span style=color:#f1fa8c>&#34;/default/c\default </span><span style=color:#8be9fd;font-style:italic>$be_name</span><span style=color:#f1fa8c>-*&#34;</span> &gt; /boot/efi/env/<span style=color:#8be9fd;font-style:italic>$be_name</span>/loader.conf
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> entry in <span style=color:#ff79c6>$(</span>ls /boot/efi/loader/entries/ | grep proxmox-.*-pve.conf<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span>      <span style=color:#8be9fd;font-style:italic>new_entry</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span><span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#8be9fd;font-style:italic>$entry</span> | sed <span style=color:#f1fa8c>&#34;s/proxmox/</span><span style=color:#8be9fd;font-style:italic>$be_name</span><span style=color:#f1fa8c>/;s/-pve//&#34;</span><span style=color:#ff79c6>)</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>      cp /boot/efi/loader/entries/<span style=color:#8be9fd;font-style:italic>$entry</span> /boot/efi/loader/entries/<span style=color:#8be9fd;font-style:italic>$new_entry</span>
</span></span><span style=display:flex><span>      sed -i <span style=color:#f1fa8c>&#34;s/EFI/env/&#34;</span> /boot/efi/loader/entries/<span style=color:#8be9fd;font-style:italic>$new_entry</span>
</span></span><span style=display:flex><span>      sed -i <span style=color:#f1fa8c>&#34;s/proxmox/</span><span style=color:#8be9fd;font-style:italic>$be_name</span><span style=color:#f1fa8c>/&#34;</span> /boot/efi/loader/entries/<span style=color:#8be9fd;font-style:italic>$new_entry</span>
</span></span><span style=display:flex><span>      sed -i <span style=color:#f1fa8c>&#34;s/Proxmox Virtual Environment/</span><span style=color:#8be9fd;font-style:italic>$be_name</span><span style=color:#f1fa8c>/&#34;</span> /boot/efi/loader/entries/<span style=color:#8be9fd;font-style:italic>$new_entry</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>done</span>
</span></span><span style=display:flex><span>    rm -f /boot/efi/loader/loader.conf
</span></span><span style=display:flex><span>    cp /tmp/beadm/loader.conf /boot/efi/loader/loader.conf
</span></span><span style=display:flex><span>    umount /boot/efi
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>done</span>
</span></span></code></pre></div><h3 id=the-list-parameter>The <code>list</code> Parameter<a hidden class=anchor aria-hidden=true href=#the-list-parameter>#</a></h3><p>We check if we find a file containing the loader.conf in /tmp, if not we
mount a ESP and copy loader.conf to /tmp, unmount the ESP and use this
file to store the name of the next active BE. Apart from that, we can
just create some output containing basically the same information as the
original <code>beadm list</code> produces:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>zfs_list</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span>zfs list -H -t filesystem,snapshot,volume -s creation -o name,used,usedds,usedbysnapshots,usedrefreserv,refer,creation,origin -r <span style=color:#8be9fd;font-style:italic>$POOL</span>/<span style=color:#8be9fd;font-style:italic>$BEDS</span> | grep <span style=color:#f1fa8c>&#34;^</span><span style=color:#8be9fd;font-style:italic>$POOL</span><span style=color:#f1fa8c>/</span><span style=color:#8be9fd;font-style:italic>$BEDS</span><span style=color:#f1fa8c>/&#34;</span> | sed <span style=color:#f1fa8c>&#39;s/\t/,/g;s/\n/;/g;s/ /_/g&#39;</span><span style=color:#ff79c6>)</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  __get_active_be_from_esp
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>printf</span> <span style=color:#f1fa8c>&#34;%-20s %-10s %-10s %-7s %-8s %-7s %-7s %-30s %-10s\n&#34;</span> name state used ds snaps ubrr refs <span style=color:#f1fa8c>&#34;creation date&#34;</span> origin
</span></span><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>printf</span> <span style=color:#f1fa8c>&#34;%-20s %-10s %-10s %-7s %-8s %-7s %-7s %-30s %-10s\n&#34;</span> ---- ----- ---- -- ----- ---- ---- --------------------- ------
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>for</span> line in <span style=color:#ff79c6>$(</span><span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#8be9fd;font-style:italic>$zfs_list</span> | tr <span style=color:#f1fa8c>&#39;;&#39;</span> <span style=color:#f1fa8c>&#39;\n&#39;</span><span style=color:#ff79c6>)</span>; <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>BE_NAME</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span><span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#8be9fd;font-style:italic>$line</span> | cut -d <span style=color:#f1fa8c>&#39;,&#39;</span> -f1 | sed <span style=color:#f1fa8c>&#34;s/^</span><span style=color:#8be9fd;font-style:italic>$POOL</span><span style=color:#f1fa8c>\/</span><span style=color:#8be9fd;font-style:italic>$BEDS</span><span style=color:#f1fa8c>\///&#34;</span><span style=color:#ff79c6>)</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>BE_ACTIVE</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(if</span> <span style=color:#ff79c6>[</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$ROOTFS</span><span style=color:#f1fa8c>&#34;</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span><span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#8be9fd;font-style:italic>$line</span> | cut -d <span style=color:#f1fa8c>&#39;,&#39;</span> -f1<span style=color:#ff79c6>)</span><span style=color:#f1fa8c>&#34;</span> <span style=color:#ff79c6>]</span>; <span style=color:#ff79c6>then</span> <span style=color:#8be9fd;font-style:italic>echo</span> N; <span style=color:#ff79c6>else</span> <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#39; &#39;</span>; <span style=color:#ff79c6>fi)</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>BE_NEXT</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(if</span> <span style=color:#ff79c6>[</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$BE_NAME</span><span style=color:#f1fa8c>&#34;</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span>cat /tmp/beadm/next_boot_environment<span style=color:#ff79c6>)</span><span style=color:#f1fa8c>&#34;</span> <span style=color:#ff79c6>]</span>; <span style=color:#ff79c6>then</span> <span style=color:#8be9fd;font-style:italic>echo</span> R; <span style=color:#ff79c6>else</span> <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#39; &#39;</span>; <span style=color:#ff79c6>fi)</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>BE_STATE</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(if</span> <span style=color:#ff79c6>[</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$BE_ACTIVE$BE_NEXT</span><span style=color:#f1fa8c>&#34;</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;  &#34;</span> <span style=color:#ff79c6>]</span>; <span style=color:#ff79c6>then</span> <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;-&#34;</span>; <span style=color:#ff79c6>else</span> <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$BE_ACTIVE$BE_NEXT</span><span style=color:#f1fa8c>&#34;</span>; <span style=color:#ff79c6>fi)</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>BE_USED</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span><span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#8be9fd;font-style:italic>$line</span> | cut -d <span style=color:#f1fa8c>&#39;,&#39;</span> -f2<span style=color:#ff79c6>)</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>BE_USEDDS</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span><span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#8be9fd;font-style:italic>$line</span> | cut -d <span style=color:#f1fa8c>&#39;,&#39;</span> -f3<span style=color:#ff79c6>)</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>BE_USEDBYSNAPSHOTS</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span><span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#8be9fd;font-style:italic>$line</span> | cut -d <span style=color:#f1fa8c>&#39;,&#39;</span> -f4<span style=color:#ff79c6>)</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>BE_USEDREFRESERV</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span><span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#8be9fd;font-style:italic>$line</span> | cut -d <span style=color:#f1fa8c>&#39;,&#39;</span> -f5<span style=color:#ff79c6>)</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>BE_REFER</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span><span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#8be9fd;font-style:italic>$line</span> | cut -d <span style=color:#f1fa8c>&#39;,&#39;</span> -f6<span style=color:#ff79c6>)</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>BE_DATE</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span><span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#8be9fd;font-style:italic>$line</span> | cut -d <span style=color:#f1fa8c>&#39;,&#39;</span> -f7 | sed <span style=color:#f1fa8c>&#39;s/_/ /g&#39;</span><span style=color:#ff79c6>)</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>BE_ORIGIN</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span><span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#8be9fd;font-style:italic>$line</span> | cut -d <span style=color:#f1fa8c>&#39;,&#39;</span> -f8<span style=color:#ff79c6>)</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> ! <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#8be9fd;font-style:italic>$line</span> | cut -d <span style=color:#f1fa8c>&#39;,&#39;</span> -f <span style=color:#bd93f9>1</span> | grep -q <span style=color:#f1fa8c>&#34;@&#34;</span>; <span style=color:#ff79c6>then</span>
</span></span><span style=display:flex><span>      <span style=color:#8be9fd;font-style:italic>printf</span> <span style=color:#f1fa8c>&#34;%-20s %-10s %-10s %-7s %-8s %-7s %-7s %-30s %-10s\n&#34;</span> <span style=color:#8be9fd;font-style:italic>$BE_NAME</span> <span style=color:#8be9fd;font-style:italic>$BE_STATE</span> <span style=color:#8be9fd;font-style:italic>$BE_USED</span> <span style=color:#8be9fd;font-style:italic>$BE_USEDDS</span> <span style=color:#8be9fd;font-style:italic>$BE_USEDBYSNAPSHOTS</span> <span style=color:#8be9fd;font-style:italic>$BE_USEDREFRESERV</span> <span style=color:#8be9fd;font-style:italic>$BE_REFER</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$BE_DATE</span><span style=color:#f1fa8c>&#34;</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$BE_ORIGIN</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>fi</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>done</span>
</span></span></code></pre></div><h3 id=the-create-parameter>The <code>create</code> Parameter<a hidden class=anchor aria-hidden=true href=#the-create-parameter>#</a></h3><p>The <code>create</code> operation is used to create a new bootable dataset. After
the operation the newly created Boot Environment is not active.</p><p>In order to make this operation work with Proxmox, first we need to grab
a copy of the currently active Boot Environment from one ESP and store
it in <code>/tmp/beadm</code>.</p><p>Then we create a new <code>/etc/kernel/cmdline</code> from the template file and
run <code>pve-efiboot-tool refresh</code>, which creates a valid bootloader
configuration on all of our ESPs. Next we copy the kernel files into
$ESP/env/$BE_NAME, rename all the conf files and restore the previous
loader.conf that we saved in <code>/tmp/beadm/loader.conf</code>. This way we can
create a new Boot Environment without activating it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  zfs <span style=color:#8be9fd;font-style:italic>set</span> <span style=color:#8be9fd;font-style:italic>canmount</span><span style=color:#ff79c6>=</span>off <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>POOL</span><span style=color:#f1fa8c>}</span>/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>BEDS</span><span style=color:#f1fa8c>}</span>/<span style=color:#8be9fd;font-style:italic>$be_name</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  __get_active_be_from_esp
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>old_be_name</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span>cat /etc/kernel/cmdline | tr <span style=color:#f1fa8c>&#39; &#39;</span> <span style=color:#f1fa8c>&#39;\n&#39;</span> | grep root | cut -d <span style=color:#f1fa8c>&#39;/&#39;</span> -f3<span style=color:#ff79c6>)</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>  cat /etc/kernel/cmdline.template | sed <span style=color:#f1fa8c>&#34;s/__BE_NAME/</span><span style=color:#8be9fd;font-style:italic>$be_name</span><span style=color:#f1fa8c>/&#34;</span> &gt; /etc/kernel/cmdline
</span></span><span style=display:flex><span>  pve-efiboot-tool refresh
</span></span><span style=display:flex><span>  cat /etc/kernel/cmdline.template | sed <span style=color:#f1fa8c>&#34;s/__BE_NAME/</span><span style=color:#8be9fd;font-style:italic>$old_be_name</span><span style=color:#f1fa8c>/&#34;</span> &gt; /etc/kernel/cmdline
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>for</span> esp in <span style=color:#ff79c6>$(</span>cat /etc/kernel/pve-efiboot-uuids<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span>    mount /dev/disk/by-uuid/<span style=color:#8be9fd;font-style:italic>$esp</span> /boot/efi
</span></span><span style=display:flex><span>    mkdir -p /boot/efi/env/<span style=color:#8be9fd;font-style:italic>$be_name</span>
</span></span><span style=display:flex><span>    cp -r /boot/efi/EFI/proxmox/* /boot/efi/env/<span style=color:#8be9fd;font-style:italic>$be_name</span>/
</span></span><span style=display:flex><span>    cat /boot/efi/loader/loader.conf | sed <span style=color:#f1fa8c>&#34;/default/c\default </span><span style=color:#8be9fd;font-style:italic>$be_name</span><span style=color:#f1fa8c>-*&#34;</span> &gt; /boot/efi/env/<span style=color:#8be9fd;font-style:italic>$be_name</span>/loader.conf
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> entry in <span style=color:#ff79c6>$(</span>ls /boot/efi/loader/entries/ | grep proxmox-.*-pve.conf<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span>      <span style=color:#8be9fd;font-style:italic>new_entry</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>$(</span><span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#8be9fd;font-style:italic>$entry</span> | sed <span style=color:#f1fa8c>&#34;s/proxmox/</span><span style=color:#8be9fd;font-style:italic>$be_name</span><span style=color:#f1fa8c>/;s/-pve//&#34;</span><span style=color:#ff79c6>)</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>      cp /boot/efi/loader/entries/<span style=color:#8be9fd;font-style:italic>$entry</span> /boot/efi/loader/entries/<span style=color:#8be9fd;font-style:italic>$new_entry</span>
</span></span><span style=display:flex><span>      sed -i <span style=color:#f1fa8c>&#34;s/EFI/env/&#34;</span> /boot/efi/loader/entries/<span style=color:#8be9fd;font-style:italic>$new_entry</span>
</span></span><span style=display:flex><span>      sed -i <span style=color:#f1fa8c>&#34;s/proxmox/</span><span style=color:#8be9fd;font-style:italic>$be_name</span><span style=color:#f1fa8c>/&#34;</span> /boot/efi/loader/entries/<span style=color:#8be9fd;font-style:italic>$new_entry</span>
</span></span><span style=display:flex><span>      sed -i <span style=color:#f1fa8c>&#34;s/Proxmox Virtual Environment/</span><span style=color:#8be9fd;font-style:italic>$be_name</span><span style=color:#f1fa8c>/&#34;</span> /boot/efi/loader/entries/<span style=color:#8be9fd;font-style:italic>$new_entry</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>done</span>
</span></span><span style=display:flex><span>    rm /boot/efi/loader/loader.conf
</span></span><span style=display:flex><span>    cp /tmp/beadm/loader.conf /boot/efi/loader/loader.conf
</span></span><span style=display:flex><span>    umount /boot/efi
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>done</span>
</span></span></code></pre></div><h3 id=the-activate-parameter>The <code>activate</code> Parameter<a hidden class=anchor aria-hidden=true href=#the-activate-parameter>#</a></h3><p>Here we activate a Boot Environment, that has already been created, so
we only need to mount all the ESPs and copy the correct conf file so it
replaces the loader.conf. We also need to write the name of the active
Boot Environment to <code>/tmp/beadm</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  <span style=color:#ff79c6>for</span> esp in <span style=color:#ff79c6>$(</span>cat /etc/kernel/pve-efiboot-uuids<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span>    mount /dev/disk/by-uuid/<span style=color:#8be9fd;font-style:italic>$esp</span> /boot/efi
</span></span><span style=display:flex><span>    rm -f /boot/efi/loader/loader.conf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4># [...]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    cp /boot/efi/env/<span style=color:#8be9fd;font-style:italic>$be_name</span>/loader.conf /boot/efi/loader/loader.conf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    umount /boot/efi
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>done</span>
</span></span></code></pre></div><h3 id=the-rename-parameter>The <code>rename</code> Parameter<a hidden class=anchor aria-hidden=true href=#the-rename-parameter>#</a></h3><p>Here, we need to rename the folder inside the <code>env</code> directory as well as
the conf files in the entries directory. We also have to make sure they
point to the new directory.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  <span style=color:#ff79c6>for</span> esp in <span style=color:#ff79c6>$(</span>cat /etc/kernel/pve-efiboot-uuids<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span>    mount /dev/disk/by-uuid/<span style=color:#8be9fd;font-style:italic>$esp</span> /boot/efi
</span></span><span style=display:flex><span>    mv /boot/efi/env/<span style=color:#8be9fd;font-style:italic>$be_name</span>/ /boot/efi/env/<span style=color:#8be9fd;font-style:italic>$new_be_name</span>/
</span></span><span style=display:flex><span>    sed -i <span style=color:#f1fa8c>&#34;s/</span><span style=color:#8be9fd;font-style:italic>$be_name</span><span style=color:#f1fa8c>/</span><span style=color:#8be9fd;font-style:italic>$new_be_name</span><span style=color:#f1fa8c>/&#34;</span> /boot/efi/env/<span style=color:#8be9fd;font-style:italic>$new_be_name</span>/loader.conf
</span></span><span style=display:flex><span>    sed -i <span style=color:#f1fa8c>&#34;s/</span><span style=color:#8be9fd;font-style:italic>$be_name</span><span style=color:#f1fa8c>/</span><span style=color:#8be9fd;font-style:italic>$new_be_name</span><span style=color:#f1fa8c>/&#34;</span> /boot/efi/loader/loader.conf
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> entry in <span style=color:#ff79c6>$(</span>ls /boot/efi/loader/entries/ | grep <span style=color:#8be9fd;font-style:italic>$be_name</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span>      sed -i <span style=color:#f1fa8c>&#34;s/</span><span style=color:#8be9fd;font-style:italic>$be_name</span><span style=color:#f1fa8c>/</span><span style=color:#8be9fd;font-style:italic>$new_be_name</span><span style=color:#f1fa8c>/&#34;</span> /boot/efi/loader/entries/<span style=color:#8be9fd;font-style:italic>$entry</span>
</span></span><span style=display:flex><span>      <span style=color:#8be9fd;font-style:italic>new_entry_name</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span><span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#8be9fd;font-style:italic>$entry</span> | sed <span style=color:#f1fa8c>&#34;s/</span><span style=color:#8be9fd;font-style:italic>$be_name</span><span style=color:#f1fa8c>/</span><span style=color:#8be9fd;font-style:italic>$new_be_name</span><span style=color:#f1fa8c>/&#34;</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>      mv /boot/efi/loader/entries/<span style=color:#8be9fd;font-style:italic>$entry</span> /boot/efi/loader/entries/<span style=color:#8be9fd;font-style:italic>$new_entry_name</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>done</span>
</span></span><span style=display:flex><span>    umount /boot/efi
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>done</span>
</span></span></code></pre></div><h3 id=the-destroy-parameter>The <code>destroy</code> Parameter<a hidden class=anchor aria-hidden=true href=#the-destroy-parameter>#</a></h3><p>We need to delete the content of the <code>env</code> directory as well as the
config files.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  <span style=color:#ff79c6>for</span> esp in <span style=color:#ff79c6>$(</span>cat /etc/kernel/pve-efiboot-uuids<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span>    mount /dev/disk/by-uuid/<span style=color:#8be9fd;font-style:italic>$esp</span> /boot/efi
</span></span><span style=display:flex><span>    rm -rf /boot/efi/env/<span style=color:#8be9fd;font-style:italic>$be_name</span>/
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> entry in <span style=color:#ff79c6>$(</span>ls /boot/efi/loader/entries/ | grep <span style=color:#8be9fd;font-style:italic>$be_name</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span>      rm -f /boot/efi/loader/entries/<span style=color:#8be9fd;font-style:italic>$entry</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>done</span>
</span></span><span style=display:flex><span>    umount /boot/efi
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>done</span>
</span></span></code></pre></div><h2 id=conclusion-and-further-work>Conclusion and Further Work<a hidden class=anchor aria-hidden=true href=#conclusion-and-further-work>#</a></h2><p>This post has introduced <code>beadm</code>, a Boot Environment Manager for the
Proxmox Virtualization Plattform, which has been forked from it&rsquo;s
FreeBSD counterpart. First the usage of <code>beadm</code> is showcased, then some
notes on porting <code>beadm</code> from FreeBSD to Linux are presented and finally
the Proxmox specific additions to <code>beadm</code> are explained.</p><p>The way <code>beadm</code> is implemented in this post could partially be
considered bad design, however this is due to <code>beadm</code> being an external
tool and not part of the native Proxmox tooling. The scope of this was
to implement Boot Environments without changing the Proxmox code. I&rsquo;m
sure the design will be improved if this functionality is added to
Proxmox. The following Improvements can be made:</p><ul><li>deduplication of kernel files (Reference counting could help to manage
this)</li><li>minimize the amount of mount / unmount operations</li><li>add the ability to inject kernels into Boot Environments</li><li>add the ability to prune kernels from Boot Environments</li><li>add the ability to export / import Boot Environments together with the
relevant files from the ESPs</li></ul><p>Now that Boot Environments on Proxmox (or more general on Linux) are a
possibility, the next thing to do could be to write up how Boot
Environments can be used in practice. For now the following scenarios,
which could be interesting come to mind:</p><ul><li>Update systems using a new Boot Environment using <code>chroot</code></li><li>Migrate systems by moving Boot Environments</li><li>Use a copy of a system in order to do forensic work</li><li>Find out what has changed between two system states by comparing the
filesystem snapshots</li><li>Use the same “base” Boot Environment to run on multiple bare metal /
virtualized machines, make an update on the base Environment, then
push it out to multiple systems.</li><li>Rollbacks in case of system failure: Reduce MTTR on bare metal systems</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://oblivious.observer/tags/proxmox/>proxmox</a></li><li><a href=https://oblivious.observer/tags/zfs/>ZFS</a></li><li><a href=https://oblivious.observer/tags/systemd-boot/>systemd-boot</a></li><li><a href=https://oblivious.observer/tags/beadm/>beadm</a></li></ul></footer><script src=https://utteranc.es/client.js repo=observer/observer.github.io issue-term=url label=💬 theme=photon-dark crossorigin=anonymous async></script></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>