<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2020-08-29 Sat 14:31 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NixOS on ZFS Install Script</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Oblivious Observer" />
<meta name="description" content="How to automatically install an unencrypted NixOS with root on ZFS"
 />
<script src="/static/jquery.min.js"></script>
<script src="/static/jquery.slim.min.js"></script>
<script src="/static/popper.min.js"></script>
<link rel="stylesheet" href="/static/bootstrap.min.css">
<script src="/static/bootstrap.min.js"></script>
<script src="/static/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="/static/roboto.txt">
<style type="text/css">body{ padding: 5em 20%;}</style>
<style type="text/css">code { color: #808080;}</style>
<style type="text/css">pre { padding: 0pt;}</style>
<style type="text/css">.navbar { margin:0 !important; padding: 0px !important; } </style>
<link rel="stylesheet" href="/static/github.css">
<script src="/static/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

        <style>
        /* From: https://endlessparentheses.com/public/css/endless.css */
        /* See also: https://meta.superuser.com/questions/4788/css-for-the-new-kbd-style */
        kbd
        {
          -moz-border-radius: 6px;
          -moz-box-shadow: 0 1px 0 rgba(0,0,0,0.2),0 0 0 2px #fff inset;
          -webkit-border-radius: 6px;
          -webkit-box-shadow: 0 1px 0 rgba(0,0,0,0.2),0 0 0 2px #fff inset;
          background-color: #f7f7f7;
          border: 1px solid #ccc;
          border-radius: 6px;
          box-shadow: 0 1px 0 rgba(0,0,0,0.2),0 0 0 2px #fff inset;
          color: #333;
          display: inline-block;
          font-family: 'Droid Sans Mono', monospace;
          font-size: 80%;
          font-weight: normal;
          line-height: inherit;
          margin: 0 .1em;
          padding: .08em .4em;
          text-shadow: 0 1px 0 #fff;
          word-spacing: -4px;

          box-shadow: 2px 2px 2px #222; /* MA: An extra I've added. */
        }
        </style>
        <link rel="stylesheet" type="text/css" href="https://alhassy.github.io/org-special-block-extras/tooltipster/dist/css/tooltipster.bundle.min.css"/>

        <link rel="stylesheet" type="text/css" href="https://alhassy.github.io/org-special-block-extras/tooltipster/dist/css/plugins/tooltipster/sideTip/themes/tooltipster-sideTip-punk.min.css" />

        <script type="text/javascript">
            if (typeof jQuery == 'undefined') {
                document.write(unescape('%3Cscript src="https://code.jquery.com/jquery-1.10.0.min.js"%3E%3C/script%3E'));
            }
        </script>

         <script type="text/javascript"            src="https://alhassy.github.io/org-special-block-extras/tooltipster/dist/js/tooltipster.bundle.min.js"></script>

          <script>
                 $(document).ready(function() {
                     $('.tooltip').tooltipster({
                         theme: 'tooltipster-punk',
                         contentAsHTML: true,
                         animation: 'grow',
                         delay: [100,500],
                         // trigger: 'click'
                         trigger: 'custom',
                         triggerOpen: {
                             mouseenter: true
                         },
                         triggerClose: {
                             originClick: true,
                             scroll: true
                         }
         });
                 });
             </script>

        <style>
           abbr {color: red;}

           .tooltip { border-bottom: 1px dotted #000;
                      color:red;
                      text-decoration: none;}
        </style>
</head>
<body>
<div id="preamble" class="status">
<!-- [[file:~/blog/readme.org::*Navigation][Navigation:1]] -->
<nav class="navbar fixed-top navbar-expand-lg navbar-light bg-light">
  <div class="container">

  <a class="navbar-brand" href="/"> <img src="/static/observer.png" width="35" height="35" class="d-inline-block align-top" alt=""> </a>


  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="navbarSupportedContent">
    <ul class="nav navbar-nav ml-auto w-100 justify-content-left">
      <li class="nav-item">
        <a class="nav-link" href="/"> Oblivious Observer </a>
      </li>
    </ul>
    <ul class="nav navbar-nav ml-auto w-100 justify-content-end">
      <li class="nav-item">
        <a class="nav-link" href="/about">about</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/config">config</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/">src</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/tags">tags</a>
      </li>
    </ul>
  </div>
  </div>
</nav>
<!-- Navigation:1 ends here -->
</div>
<div id="content">
<h1 class="title">NixOS on ZFS Install Script</h1>
<p>
This is a rather short post and the start of what will hopefully become a nice
little series of posts related to setting up and managing IT infrastructure.
</p>

<p>
I just had to bulk install NixOS on a bunch of Intel NUCs, here is a little
script to automate the installation process. Some bits and pieces are taken from
other installation scripts, but it&rsquo;s been a while, so I don&rsquo;t know who to credit
for them.
</p>

<p>
Start with the usual <code>#!</code> and set the script up to exit on errors:
</p>
<div class="org-src-container">
<pre><code class="bash">#!/usr/bin/env bash
set -e
</code></pre>
</div>

<p>
Next add a function for pretty printing, (I stole this part from somewhere else).
</p>
<div class="org-src-container">
<pre><code class="bash">pprint () {
    local cyan="\e[96m"
    local default="\e[39m"
    # ISO8601 timestamp + ms
    local timestamp
    timestamp=$(date +%FT%T.%3NZ)
    echo -e "${cyan}${timestamp} $1${default}" 1&gt;&amp;2
}
</code></pre>
</div>

<p>
Instead of using a <code>DISK</code> variable and changing its value inside the script
everytime it is run, simply let the user pick the device.
</p>
<div class="org-src-container">
<pre><code class="bash">echo "These are the disks available:"
ls -l /dev/disk/by-id/ | awk '{print $11, $10, $9}' | tr -d './' | column -t
echo

# Set DISK
select ENTRY in $(ls /dev/disk/by-id/);
do
    echo $ENTRY
    DISK="/dev/disk/by-id/$ENTRY"
    echo "Installing system on $ENTRY."
    break
done
</code></pre>
</div>

<p>
Next set up the SWAP Size:
</p>
<div class="org-src-container">
<pre><code class="bash">echo -n "Enter Swap size (e.g. 10GiB, 5MiB)"
echo
read SWAP_SIZE
if [[ $SWAP_SIZE =~ ^[0-9]*(GiB|MiB)$ ]]
then
  echo "Swap size set to $SWAP_SIZE"
else
  echo "Please enter correct size"
  break
fi
</code></pre>
</div>

<p>
Ask for confirmation and wipe the disk:
</p>
<div class="org-src-container">
<pre><code class="bash">read -p "&gt; Do you want to wipe all data on $ENTRY ?" -n 1 -r
echo # move to a new line
if [[ "$REPLY" =~ ^[Yy]$ ]]
then
    # Clear disk
    wipefs -af "$DISK"
    sgdisk -Zo "$DISK"
    partprobe $DISK
else
    exit 1
fi
</code></pre>
</div>

<p>
Initially I was using <code>sgdisk</code> in order to create all partitions. This usually
seems to work, however I noticed, that on some hardware devices (NUC Canyons),
the boot flag had to be set in order for them to actually boot up, so i switched
to <code>parted</code> instead.
</p>
<div class="org-src-container">
<pre><code class="bash">parted $DISK -- mklabel gpt

pprint "Creating system partition"
parted $DISK -- mkpart primary 512MiB -${SWAP_SIZE}
ROOT="$DISK-part1"

pprint "Creating swap partition"
parted $DISK -- mkpart primary linux-swap -${SWAP_SIZE} 100%
SWAP="$DISK-part2"

pprint "Creating boot (EFI) partition"
parted $DISK -- mkpart ESP fat32 1MiB 512MiB
parted $DISK -- set 3 boot on
BOOT="$DISK-part3"

pprint "Running partprobe on $DISK"
partprobe $DISK
</code></pre>
</div>

<p>
Now that the partitions have been created, lets create filesystems and mount
them. The <code>sleep</code> at the beginning seems to be necessary, otherwise there are
problems with creating the swap partition.
</p>
<div class="org-src-container">
<pre><code class="bash">sleep 2 # not sure why, but if we don't wait, the following swap does not work properly

pprint "Enable SWAP on $SWAP"
mkswap -L swap $SWAP
swapon -L swap

# ZFS partition
pprint "Create zfs pool rpool"
zpool create -f -O mountpoint=none -O acltype=posixacl -O xattr=sa -R /mnt rpool $ROOT

pprint "Create zfs dataset rpool/root"
zfs create -o mountpoint=none   rpool/root
pprint "Create zfs dataset rpool/root/nixos"
zfs create -o mountpoint=legacy rpool/root/nixos
pprint "Create zfs dataset rpool/home"
zfs create -o mountpoint=legacy rpool/home

pprint "Mount datasets: rpool/root/nixos"
mount -t zfs rpool/root/nixos /mnt

pprint "Mount datasets: rpool/home"
mkdir /mnt/home
mount -t zfs rpool/home /mnt/home


pprint "Mount boot partition"
mkfs.fat -F 32 -n boot $BOOT
mkdir /mnt/boot
mount $BOOT /mnt/boot
</code></pre>
</div>

<p>
Finally create a nixos configuration and set the system up to boot from ZFS:
</p>
<div class="org-src-container">
<pre><code class="bash">pprint "Generate NixOS configuration"
nixos-generate-config --root /mnt

# Add LUKS and ZFS configuration
HOSTID=$(head -c8 /etc/machine-id)

HARDWARE_CONFIG=$(mktemp)
cat &lt;&lt; CONFIG &gt; "$HARDWARE_CONFIG"
networking.hostId = "$HOSTID";
boot.supportedFilesystems = [ "zfs" ];
boot.zfs.devNodes = "$ROOT";
}
CONFIG

#pprint "Append configuration to hardware-configuration.nix"
sed -i "\$ s/.}\$//;\$e cat $HARDWARE_CONFIG" /mnt/etc/nixos/configuration.nix

pprint "You can now install nixos using the 'nixos-install' command."
</code></pre>
</div>

That&rsquo;s basically it. You may be interested in the <a href="./index.org">org-mode source</a> of this
document, from where you can tangle the script by opening it in Emacs and using
<code>org-babel-tangle</code>.
</div>
</body>
</html>
